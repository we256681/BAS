<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scenario</title>
</head>
<body style="display:none">
  <!-- ========= -->
  <!--   HTML    -->
  <!-- ========= -->
  <div id="multiselect" style="display:none"></div>
  <div class="findtoolbox">
    <div class="input-group input-group-sm findcontrol">
      <span class="input-group-addon"><i class="fa fa-search" aria-hidden="true"></i></span>
      <input type="text" id="findinput" class="form-control" aria-label="Amount (to the nearest dollar)" data-toggle="tooltip" data-placement="bottom" data-title="To find action, you can put here anything which is displayed inside action, like: action id, action name, variables which uses action. You can't find action by variables, which are not displayed."
>
      <span class="input-group-btn">
        <button class="btn btn-secondary tr" id="findprev" type="button" data-toggle="tooltip" data-placement="bottom" data-title="Search previous match"><i class="fa fa-arrow-left" aria-hidden="true"></i></button>
        <button class="btn btn-secondary tr" id="findnext" type="button" data-toggle="tooltip" data-placement="bottom" data-title="Search next match"><i class="fa fa-arrow-right" aria-hidden="true"></i></button>
        <button class="btn btn-secondary tr" type="button" id="findhide"><i class="fa fa-times-circle-o" aria-hidden="true"></i></button>
      </span>
    </div>
  </div>
  <div id="findbuttoncontainer" data-toggle="tooltip" data-placement="auto" data-title="Search action by specified text">
    <button type="button" class="btn btn-default btn-xs" id="findbutton"><i class="fa fa-search" aria-hidden="true"></i></button>
  </div>
  <div id="helplabelcontainer" data-toggle="tooltip" data-placement="bottom" data-title="Following button leads to menu with most used actions and example of usage. It is good place to start if you are new to BAS.">
    <button type="button" class="btn btn-default btn-xs" id="movetolabelbutton" onclick="BrowserAutomationStudio_HighlightHelpIsActive = false;$('#HelpCenter').modal();"><i class="fa fa-question-circle text-primary" aria-hidden="true"></i></button>
  </div>
  <div id="debugbuttoncontainer">
    <button type="button" class="btn btn-default btn-xs" id="debugbutton" onclick="_Inspector.show()" data-toggle="tooltip" data-placement="auto" data-title="Show variables list. You can create variable with 'Set Variable' action."><i class="fa fa-bug" aria-hidden="true"></i></button>
  </div>
  <div id="container">
   <div id="containerdata" ></div>

   <div class="modal" tabindex="-1" role="dialog" id="HelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Help</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">This page contains information about most used actions and examples of their usage. Complete list of actions can be found on following</span> 
              <a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-09_13-04-38.png');return false">panel</a>. 
              <br/>
              <span class="tr">You can also check</span>

              <a href="#" class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com');return false">wiki</a>
              <span class="tr">for more information</span>.
              </span>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#LoopHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="Loops helps to repeat defined list of actions specified number of times or until certain condition will be met."><i class="fa fa-repeat helpitem"></i><span class="helpitemname tr">Loops</span></a> 
              <span class="smalltext helprow2 tr">helps to repeat actions.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#VariablesHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="Variables are used to store data between action execution. Each variable has a name and a data, which it points to. For example, variable EMAIL may point to string aaa@gmail.com and variable PASS may point string pass123. You can reference this data by filling variable name with double square brackets into any action and any parameters. For example, to input your email on site use following notation [[EMAIL]]"><i class="helpitem">X=</i><span class="helpitemname tr">Variables</span></a>
              <span class="smalltext helprow2 tr">are used to store data.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#ConditionHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="Check specified condition, if it's true execute some action sequence, if it's false execute another action sequence. Finally proceed with next actions."><i class="fa fa-random helpitem"></i><span class="helpitemname tr">Conditions</span></a>
              <span class="smalltext helprow2 tr">helps to execute different actions depending on condition.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#BrowserHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="Interaction with browser."><i class="fa fa-globe helpitem"></i><span class="helpitemname tr">Browser</span></a>
              <span class="smalltext helprow2 tr">interacting with browser.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#LabelHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="Set label so execution point may be transfered to that label later. Labels helps to transfer execution point between two arbitrary places inside script."><i class="fa fa-tag helpitem"></i><span class="helpitemname tr">Labels</span></a>
              <span class="smalltext helprow2 tr">move execution point to arbitrary place.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#FunctionHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="Functions are containers, which holds action list. It helps to group several actions which does same task. For example, there can be function which logins to account, function that checks account balance, etc. It makes your code clear and well organized."><i class="fa fa-bolt helpitem"></i><span class="helpitemname tr">Functions</span></a>
              <span class="smalltext helprow2 tr">containers, which holds action list.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#ErrorHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="You can process errors during action execution and decide how to proceed after error."><i class="fa fa-exclamation-triangle helpitem"></i><span class="helpitemname tr">Error handling</span></span></a>
              <span class="smalltext helprow2 tr">react on error during execution.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#ParseHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="There methods for parsing json, html, xml, csv and other formats."><i class="fa fa-file-text helpitem"></i><span class="helpitemname tr">Parsing data</span></span></a>
              <span class="smalltext helprow2 tr">csv, html, xml parsing.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#OutputHelpCenter').modal();return false;"><i class="fa fa-pencil-square helpitem"></i><span class="helpitemname tr">Output data</span></span></a>
              <span class="smalltext helprow2 tr">Save data to log or file.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#FileHelpCenter').modal();return false;"><i class="fa fa-files-o helpitem"></i><span class="helpitemname tr">Files</span></span></a>
              <span class="smalltext helprow2 tr">Reading or writing files, distribute data across threads.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a href="#" class="helprow1" onclick="$('#HelpCenter').modal('hide');$('#MultithreadingHelpCenter').modal();return false;" data-toggle="tooltip" data-placement="auto" data-title="Multithreaded means, that your activities will be executed in parallel."><i class="fa fa-random helpitem"></i><span class="helpitemname tr">Multithreading</span></span></a>
              <span class="smalltext helprow2 tr">Make your application multithreaded.</span>
              <div class="clearfix"></div>
            </div>
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="LoopHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Loops</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">Loops helps to repeat defined list of actions specified number of times or until certain condition will be met.</span> 
            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('for');$('#LoopHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">For</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Repeat actions specified number of times.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('while');$('#LoopHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">While</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Repeat actions while specified condition.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('foreach');$('#LoopHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Foreach</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Repeat actions for each element in list.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Usage examples</i> <span class="smalltext tr">(some examples requires additional editing)</span> :
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Repeat 10 times</span><a href="#" onclick="_HelpManager.Repeat10Times();$('#LoopHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Repeat infinite number of times</span><a href="#" class="exampleadd" onclick="_HelpManager.RepeatInfinite();$('#LoopHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Repeat until certain condition</span><a href="#" class="exampleadd" onclick="_HelpManager.RepeatUntil();$('#LoopHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Repeat for each element in the list</span><a href="#" onclick="_HelpManager.RepeatForeachList();$('#LoopHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Repeat for each element in resource</span><a href="#" onclick="$('#LoopHelpCenter').modal('hide');_HelpManager.RepeatForeachResource();return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Repeat for each value in user defined list</span><a href="#" onclick="_HelpManager.RepeatForeachUserDefinedList();$('#LoopHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#LoopHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="VariablesHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Variables</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">Variables are used to store data between action execution. Each variable has a name and a data, which it points to. For example, variable EMAIL may point to string aaa@gmail.com and variable PASS may point string pass123. You can reference this data by filling variable name with double square brackets into any action and any parameters. For example, to input your email on site use following notation [[EMAIL]]</span> 
            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('setvariable');$('#VariablesHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Set Variable</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Create or update variable.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('incvariable');$('#VariablesHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Increase Variable</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Increase or decrease numeric variable.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('globalset');$('#VariablesHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Set Global Variable</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Global variables are available during whole script execution in every thread.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('incglobalvariable');$('#VariablesHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Increase Global Variable</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Increase or decrease numeric global variable.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('template');$('#VariablesHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Template</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Create multiline variable, expand spintax.</span>
              <div class="clearfix"></div>
            </div>
            
            
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#VariablesHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="ConditionHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Conditions</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">Conditions helps to execute actions depending if specified condition is true. For example, if certain text is present on page, save it to log, otherwise fail thread.</span> 
            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('if');$('#ConditionHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">If</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">executes different actions depending on condition.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Usage examples</i> <span class="smalltext tr">(some examples requires additional editing)</span> :
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Execute if variable is true</span><a href="#" onclick="_HelpManager.ExecuteIfTrue();$('#ConditionHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Execute if variable equals to specified value</span><a href="#" class="exampleadd" onclick="_HelpManager.ExecuteIfEqual();$('#ConditionHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Execute if variable is greater than</span><a href="#" class="exampleadd" onclick="_HelpManager.ExecuteIfGreaterThan();$('#ConditionHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Execute always</span><a href="#" onclick="_HelpManager.ExecuteAlways();$('#ConditionHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Never execute</span><a href="#" onclick="$('#ConditionHelpCenter').modal('hide');_HelpManager.NeverExecute();return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Execute if variable contains</span><a href="#" onclick="_HelpManager.ExecuteIfVariableContains();$('#ConditionHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#ConditionHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="BrowserHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Browser</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              
              <span class="tr">In order to interact with browser, you need to use actions from </span>
              <a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-11_19-04-18.png');return false">'Browser'</a>.
              <span class="tr">module</span> 

              <br/>

              <span class="tr">A good way to start would be to use 'Load' action, to load some url.</span>

              <br/>

              <span class="tr">To interact with browser elements, you need to select it and then choose what action you want to perform from a context menu, </span><a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-11_19-11-24.png');return false">[[screenshot]]</a>.
              
              <br/>

              <span class="tr">There is also an alternative way to control browser, click on.</span>
              <a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-11_19-14-36.png');return false">following button</a>
              <span class="tr">to get a direct control on browser. You can also select to record a script, which means that all your mouse click and key inputs will be converted into script, which can be repeated later.</span>
              
            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('load');$('#BrowserHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Load</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Load URL.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('proxy');$('#BrowserHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Proxy</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Set browser proxy.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('user_notification_manual_browser_control');$('#BrowserHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Manual browser control</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Control browser directly.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('UseProfile');$('#BrowserHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Create or switch to regular profile</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Set folder, which will contain browser cookie, localStorage and other objects. Can be used to autologin.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Usage examples</i> <span class="smalltext tr">(some examples requires additional editing)</span> :
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Load page and get its content</span><a href="#" onclick="_HelpManager.LoadPageGetContent();$('#BrowserHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Load page and make xpath query.</span><a href="#" class="exampleadd" onclick="_HelpManager.LoadPageDoXpath();$('#BrowserHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#BrowserHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="LabelHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Labels</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">Labels helps to transfer execution point between two arbitrary places inside script.</span> 

              <br/>

              <span class="tr">Easiest way to move execution point is just to drag and drop label handler, like</span>

              <a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=2019-08-11_20-04-27.gif');return false">[[this]]</a>.

              <br/>

              <span class="tr">You can also use labels by running 'Set label' and 'Move to label' actions.</span>

            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('label');$('#LabelHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Set label</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Set label so execution point may be transfered to that label later.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('goto');$('#LabelHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Move to label</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Move execution point to label previously set with "Set label" action.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Usage examples</i> <span class="smalltext tr">(some examples requires additional editing)</span> :
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Create cycle using labels</span><a href="#" onclick="_HelpManager.CreateCycles();$('#LabelHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            
            
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#LabelHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
   </div>


   <div class="modal" tabindex="-1" role="dialog" id="FunctionHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Functions</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">Functions are containers, which holds action list. It helps to group several actions which does same task. For example, there can be function which logins to account, function that checks account balance, etc. It makes your code clear and well organized.</span> 
              <br/>
              <span class="tr">In order to create or call functions use </span> 
              <a href="#"  class="tr" onclick="$('#FunctionHelpCenter').modal('hide');_FunctionManager.RenderDefault();_FunctionManager.Show();return false">Function manager</a>
            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('executefunction');$('#FunctionHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Call Function</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Execute function and proceed with next action.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('executefunctioninseveralthreads');$('#FunctionHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Call function in several threads</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Execute function specified number of times with specified number of threads.</span>
              <div class="clearfix"></div>
            </div>
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#FunctionHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="ErrorHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Error handling</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">By default, if any error will happen during any action execution, thread will restart.</span> 
              <br/>
              <span class="tr">This behavior is acceptable most of times. For example, if your proxy is not working, it is good idea to restart thread and take a new proxy. However, if you want to process error differently than restarting thread, you can use 'Ignore Errors' action. This action allows to detect whenever error happens and do whatever you like by executing arbitrary code. For example, you can write report and restart thread only after that, or move to label and repeat action and don't restart thread at all.</span> 
              <br/>
              <span class="tr">In order to ignore errors during execution of specific action, use </span> 
              <a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-12_13-22-02.png');return false">following button</a>.

              
            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('ignoreerrors');$('#ErrorHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Ignore Errors</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Ignore errors and continue script execution further.</span>
              <div class="clearfix"></div>
            </div>
            
            <hr/>
            <div>
              <i class="tr helpitetitle1">Usage examples</i> <span class="smalltext tr">(some examples requires additional editing)</span> :
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Load page until success, ignore error during page load.</span><a href="#" onclick="_HelpManager.ReloadPage();$('#ErrorHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            
            
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#ErrorHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="ParseHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Parsing data</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">In order to parse data from web page, first load url with 'Load' action, next click on element that you want to extract and select 'Get element text' action,</span> 
              <a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-12_15-13-37.png');return false">[[like this]]</a>. 
              <br/>
              <span class="tr">You can also save page source into variable('Page Html' action) and use xpath or regular expression module in order to extract data.</span> 
              <br/>
              <span class="tr">Regular expressions or xpath can be also used to extract data from any other source if text is stored in the variable. For example, you can get page with http client('Get' action), save its source with 'Content' action and then use regular expressions.</span> 
              <br/>
              <span class="tr">If you want to split line from file, which contains several values, for example, email:password, then you need to use 'Parse Line' action.</span> 

            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('parseline');$('#ParseHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Parse Line</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Split line, which contains several values, for example, email:password into variables.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('html');$('#ParseHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Page Html</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Save page html to variable.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>

            
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('XpathXml');$('#ParseHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Xpath Get Xml</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Execute xpath and find html.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('XpathText');$('#ParseHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Xpath Get Text</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Execute xpath and find text.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('RegexpFirst');$('#ParseHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">First match</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Execute regular expression, get first match.</span>
              <div class="clearfix"></div>
            </div>
            <hr/>

            <div>
              <i class="tr helpitetitle1">Usage examples</i> <span class="smalltext tr">(some examples requires additional editing)</span> :
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Extract page title with regular expression</span><a href="#" onclick="_HelpManager.ExtractTitle();$('#ParseHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Extract all links on page using xpath</span><a href="#" class="exampleadd" onclick="_HelpManager.ExtractLinks();$('#ParseHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Iterate all links on page</span><a href="#" class="exampleadd" onclick="_HelpManager.IterateLinks();$('#ParseHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Split csv line into variables</span><a href="#" onclick="_HelpManager.SplitCsv();$('#ParseHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Split multiline data into list with lines</span><a href="#" onclick="$('#ParseHelpCenter').modal('hide');_HelpManager.SplitMultiline();return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#ParseHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="OutputHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Output data</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">Easiest way to output message is to use 'Log' action, it will write data into special log panel and into file. 'Log' action is more suitable for writing messages about script execution.</span> 
              <br/>
              <span class="tr">To save raw data without timestamps use 'Result' action.</span> 
              <br/>
              <span class="tr">Finally, you can write to any file with 'Write File' action. It accepts resource as input parameter, so you can write into user selected file.</span> 
            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('log');$('#OutputHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Log</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Write message to log</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('result');$('#OutputHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Result</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Output data to results tab</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('filesystem_writefile');$('#OutputHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Write File</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Write data to file with specified path</span>
              <div class="clearfix"></div>
            </div>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Usage examples</i> <span class="smalltext tr">(some examples requires additional editing)</span> :
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Write a test message</span><a href="#" onclick="_HelpManager.WriteTestMessage();$('#OutputHelpCenter').modal('hide');return false" class="exampleadd"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Write line to user selected file</span><a href="#" class="exampleadd" onclick="_HelpManager.WriteToUserSelectedFile();$('#OutputHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#OutputHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="MultithreadingHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Multithreading</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">By default your script will run in single thread and will stop after first execution.</span> 
              
              <br/>

              <span class="tr">In order to make your application multithreaded, you need to set thread number on </span> 

              <a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-12_19-47-11.png');return false">following panel</a>,
              
              <span class="tr">you also need to stop "Record mode" and start script in</span> 
              
              "<a href="#" class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-03_16-56-55.png');return false">Run mode</a>".
              
              <br/>
              
              <span class="tr">Resource system may help you to distribute data across multiple thread. You can create new resource by clicking on following </span> 
              
              <a href="#" class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-12_19-54-14.png');return false">button</a>.
              
              <span class="tr">For example, if you have file with proxy list, create resource with name 'Proxy' and then use it in any parameter in any action, </span> 
              
              <a href="#" class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-12_19-56-16.png');return false">like this</a>.

              <span class="tr">With this approach new proxy will be taken for each thread run.</span> 

              <br/>

              <span class="tr">Resource system also creates user interface, this means, that on each script run you or your users will be prompted to input filename which contains proxies.</span>


              
            </span>
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#MultithreadingHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="FileHelpCenter">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Files</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext">
              <span class="tr">Interacting with file can be performed in two ways. First on is very straightforward, use 'Filesystem' module and 'Read File' or 'Write File' actions in order to read or write file directly.</span> 
              <br/>
              <span class="tr">First approach is very easy to use but has one disadvantage, it is hard to synchronize data across multiple threads.</span> 
              <br/>
              
              <span class="tr">Resource system, the second way, may help you to do that. You can create new resource by clicking on following </span> 
              
              <a href="#" class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-12_19-54-14.png');return false">button</a>.
              
              <span class="tr">For example, if you have file with proxy list, create resource with name 'Proxy' and then use it in any parameter in any action, </span> 
              
              <a href="#" class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-12_19-56-16.png');return false">like this</a>.

              <span class="tr">With this approach new proxy will be taken for each thread run.</span> 

              <br/>

              <span class="tr">In order to repeat your application for each resource value, you need to set 'Run Type' to 'Repeat' on </span> 

              <a href="#"  class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-12_19-47-11.png');return false">following panel</a>,
              
              <span class="tr">you also need to stop "Record mode" and start script in</span> 
              
              "<a href="#" class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-03_16-56-55.png');return false">Run mode</a>".

              <br/>

              <span class="tr">Resource system also creates user interface, this means, that on each script run you or your users will be prompted to input filename which contains proxies.</span>

            </span>
            <hr/>
            <div>
              <i class="tr helpitetitle1">Frequently used actions:</i>
            </div>
            <hr/>
            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('filesystem_readfile');$('#FileHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Read File</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Read data from file with specified path</span>
              <div class="clearfix"></div>
            </div>
            <hr/>

            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('filesystem_writefile');$('#FileHelpCenter').modal('hide');return false">
                <i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Write File</span>
              </a> 
              <span class="smalltext smallmarginright helprow2 tr">Write data to file with specified path</span>
              <div class="clearfix"></div>
            </div>
            <hr/>

            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('filesystem_file_to_list');$('#FileHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Read File To List</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Read data from file to list</span>
              <div class="clearfix"></div>
            </div>
            <hr/>

            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('filesystem_list_to_file');$('#FileHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Write List To File</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Write data from list to file</span>
              <div class="clearfix"></div>
            </div>
            <hr/>

            <div>
              <a class="helprow1" href="#" onclick="BrowserAutomationStudio_OpenAction('ResourceToArray');$('#FileHelpCenter').modal('hide');return false"><i class="fa fa-cog  helpitem"></i><span class="helpitemname tr">Resource To List</span></a> 
              <span class="smalltext smallmarginright helprow2 tr">Read data from resource(user selected file) to list</span>
              <div class="clearfix"></div>
            </div>
            <hr/>


            <div>
              <i class="tr helpitetitle1">Usage examples</i> <span class="smalltext tr">(some examples requires additional editing)</span> :
            </div>
            
            <hr/>
            <div>
              <span class="examplelistitem">&#x25CF;</span><span class="examplelabel tr">Write line to user selected file</span><a href="#" class="exampleadd" onclick="_HelpManager.WriteToUserSelectedFile();$('#FileHelpCenter').modal('hide');return false"><i class="fa fa-plus-square-o"></i></a> 
            </div>
            
            
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" onclick="$('#FileHelpCenter').modal('hide');$('#HelpCenter').modal();" class="btn btn-default standartbutton tr">Back</button>
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

   <div class="modal" tabindex="-1" role="dialog" id="RunModeModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title tr">Run Type</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <span class="smalltext"><span class="tr">Run type determines how many time script will run. This setting doesn't affect "Record mode", if you want to repeat script execution, you need to stop "Record mode" and start script in</span> "<a href="#" class="tr" onclick="BrowserAutomationStudio_OpenUrl('https://wiki.bablosoft.com/lib/exe/fetch.php?cache=&media=browserautomationstudio_2019-08-03_16-56-55.png');return false">Run mode</a>".</span>
            <hr/>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="RunModeRadio" id="RunModeRadioOneTime" value="OneTime" onclick="$('.RunTypeLabel').hide();$('#OneTimeLabel').show()">
              <label class="form-check-label" for="RunModeRadioOneTime">
                <span class="tr">One time</span>
              </label>
            </div>
            <span class="tr smalltext RunTypeLabel" id="OneTimeLabel">Script will be executed once and then will instantly finish.</span>
            <hr/>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="RunModeRadio" id="RunModeRadioRepeat" value="Repeat" onclick="$('.RunTypeLabel').hide();$('#RepeatLabel').show()">
              <label class="form-check-label" for="RunModeRadioRepeat">
                <span class="tr">Repeat</span>
              </label>
            </div>
            <span class="tr smalltext RunTypeLabel" id="RepeatLabel">Script will be constantly repeated infinitely or until data for any resource will be exhausted, or until "End Script" will be executed. Use this mode if you want to execute script until some condition will be met, for example, if the lines in the file run out.</span>
            <hr/>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="RunModeRadio" id="RunModeRadioCustom" value="Custom" onclick="$('.RunTypeLabel').hide();$('#CustomLabel').show()">
              <label class="form-check-label" for="RunModeRadioCustom">
                <span class="tr">Custom</span>
              </label>
            </div>
            <span class="tr smalltext RunTypeLabel" id="CustomLabel">Each script launch has a successful or failure result, for example, successful run could be when account was registered and failure may be because not working proxy. With this type you can limit successful and fail execution number. For example, by setting success number to 100 and fail number to 10, you are telling engine to stop execution after 100 successful account registration or after 10 failures during registration.</span>

          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary runmodeok standartbutton tr" data-dismiss="modal">Ok</button>
        </div>
      </div>
    </div>
  </div>

   <div class="modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" id="editmodal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title tr" id="myModalLabel">Edit Task</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">

              <textarea class="form-control" type="text" id="TaskName" data-placeholder="Task Description"> </textarea>
            </div>
            <div class="form-group">
              
            </div>
            <div class="form-group">
              Id: <span id="TaskId" style="color:gray;font-size:smaller"></span>
            </div>
            <div class="form-group">
              <span class="tr">Color</span>: 
              <span style="-webkit-user-select: none;">
                <span class="color-select color-select-active" color-id="" style="background-color:#f3f3f3">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <span class="color-select action-color-1" color-id="1">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <span class="color-select action-color-2" color-id="2">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <span class="color-select action-color-3" color-id="3">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <span class="color-select action-color-4" color-id="4">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <span class="color-select action-color-5" color-id="5">&nbsp;&nbsp;&nbsp;&nbsp;</span>
              </span>
              
            </div>
            <div class="form-group">
              <input type="checkbox" id="TaskDontRunWhenRecording"/> <label for="TaskDontRunWhenRecording" class="tr">Don't run when recording</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary resok standartbutton tr">Ok</button>
            <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" aria-labelledby="myEditModalLabel" id="editfunctionmodal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title tr" id="myEditModalLabel">Add/Edit Function</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <input class="form-control" type="text" id="EditFunctionName" data-placeholder="Function Name" />
            </div>
            <div class="form-group">
              <button type="button" class="btn btn-default btn-sm onapplicationstart tr">OnApplicationStart</button> <span style="color:gray" data-toggle="tooltip" data-placement="auto" data-title="OnApplicationStart function will run just after script starts and before any other code defined in 'Main' function. It will run in single thread and it is the perfect place to do initialization of global variables, resources, etc."><i class="fa fa-question-circle" aria-hidden="true"></i></span>
            </div>
          </div>
          <div class="modal-footer">
            <span id="validation"></span>
            
            <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary funcok standartbutton tr" data-dismiss="modal">Ok</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" aria-labelledby="myEditModalLabelParameter" id="editparametermodal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title tr" id="myEditModalLabelParameter">Add/Edit Parameter</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="EditParameterName" class="tr">Name:</label>
              <input class="form-control" type="text" id="EditParameterName" />
              <small class="form-text text-muted tr">Name is for identifying parameter, it is used in "Get Function Parameter" action to get parameter value inside function.</small>
            </div>
            <div class="form-group">
              <label for="EditParameterType" class="tr">Type:</label>
              <select class="form-control" id="EditParameterType">
                <option value="String" selected="selected" class="tr">String</option>
                <option value="Number" class="tr">NumberParam</option>
                <option value="Boolean" class="tr">Boolean</option>
                <option value="Expression" class="tr">Expression</option>
                <option value="StringOrExpression" class="tr">String or expression</option>
                <option value="NumberOrExpression" class="tr">Number or expression</option>
              </select>
              <small class="form-text text-muted tr">Type is used to prepare input field for this parameter. It is displayed when starting function, inside "Call Function" action.</small>

            </div>
            <div class="form-group EditParameterDescriptionPanel">
              <label for="EditParameterDescription" class="tr">Description:</label>
              <textarea class="form-control" type="text" id="EditParameterDescription" rows="5"></textarea>
              <small class="form-text text-muted tr">Description is also used to prepare input field for this parameter, same as "Type".</small>
            </div>
            <div class="form-group EditParameterDefaultsPanel">
              <label for="EditParameterDefaults" class="tr">Default value:</label>
              <input class="form-control" type="text" id="EditParameterDefaults" />
              <small class="form-text text-muted tr">Default value for generated input field.</small>
            </div>
          </div>
          <div class="modal-footer">
            <span id="validationParam"></span>
            
            <button type="button" class="btn btn-default standartbutton tr" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary paramok standartbutton tr" data-dismiss="modal">Ok</button>
          </div>
        </div>
      </div>
    </div>
    <div id="FunctionManagerMain" data-visible="false" class="NotDetailed"></div>
  </div>

  <!-- ========= -->
  <!-- TEMPLATES -->
  <!-- ========= -->
  <script type="text/template" id="isscriptexecuting" >
    <img draggable="false" src="icons/play.png" class="action-button <%= (isscriptexecuting || execute_next_id == 1) ? "actionbuttongray" : "" %>" id="play"   data-toggle="tooltip" data-placement="bottom" title="<%= tr("Play. Run rest of the script starting from current action.") %>" />
    <img draggable="false" src="icons/next.png" class="action-button <%= (isscriptexecuting || execute_next_id == 1) ? "actionbuttongray2" : "" %>" id="stepnext"  data-toggle="tooltip" data-placement="bottom" title="<%= tr("Run next action. Only single action will be executed.") %>" />
    <img draggable="false" src="icons/pause.png" class="action-button <%= (isscriptexecuting) ? "" : ((isscriptexecuting || execute_next_id == 1) ? "actionbuttongray" : "actionbuttongray2") %>" id="pause" />
  </script>

  <script type="text/template" id="selectiontemplate">
    <% _TotalSelected = TotalSelected(); %>
    <div style="float:left;text-align:center;white-space: nowrap" class="halfscreenorall">
      <img draggable="false" src="icons/undo.png" class="action-button2 <%= (_UndoManager.CanUndo()) ? "" : "disabled" %>" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Undo (Ctrl-Z)") %>" id="action-undo" />
      <img draggable="false" src="icons/redo.png" class="action-button2 <%= (_UndoManager.CanRedo()) ? "" : "disabled" %>" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Redo (Ctrl-Y)") %>" id="action-redo" />

      <img draggable="false" src="icons/copy.png" class="action-button2 <%= (_TotalSelected > 0) ? "" : "disabled" %>" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Copy (Ctrl-C)") %>" id="action-copy" />
      <img draggable="false" src="icons/cut.png" class="action-button2 <%= (_TotalSelected > 0) ? "" : "disabled" %>" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Cut (Ctrl-X)") %>" id="action-cut" />
      <img draggable="false" src="icons/paste.png" class="action-button2" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Paste (Ctrl-V)") %>" id="action-paste" />
      <img draggable="false" src="icons/checkall.png" class="action-button2" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Check All") %>" id="action-checkall" />
      <img draggable="false" src="icons/uncheckall.png" class="action-button2 <%= (_TotalSelected > 0) ? "" : "disabled" %>"  data-toggle="tooltip" data-placement="bottom" title="<%= tr("Clear Selection") %>" id="action-uncheckall" />      
    </div>
    <div style="float:left" class="halfscreenorall">
      <div class="centeredonlyifsmall">
        <span class="small"><%= tr("Selected") %></span>: <strong><%= TotalSelected() %></strong>
      </div>
    </div>
  </script>

  <script type="text/template" id="main">
    <div class="threads" >
      <div class="text-center toolbox halfscreenorall" style="float:left">
        <span id="isscriptexecutingcontainer">
          
        </span>
        <img draggable="false" src="icons/stop.png" class="action-button" id="stop" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Stop script and exit 'Record' mode.") %>" />
        <img draggable="false" src="icons/restart.png" class="action-button" id="restart" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Restart script. Script will be stopped and then started again in 'Record' mode.") %>" />

      </div>
      <div style="float:left" class="halfscreenorall" >
        <div class="centeredonlyifsmall" id="runproperties" <%= ((global["successnumber"] == 1 && global["failnumber"] == 1) || (global["successnumber"] >= 100000 && global["failnumber"] >= 100000)) ? "style='margin-top:10px;margin-bottom:10px;'" : "" %> >
          <div class="nowrap" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Number of threads. This option affects only 'Run' mode, but not 'Record' mode. To start script in multithreaded mode, change this setting, stop record and click 'Run'.") %>">
              <span class="<%= global["threadnumber"] > 1 ? "text-success" : "text-danger"  %>" >&#x25CF;</span>
              <span class="small"><%= tr("Thread Number") %></span>: <strong><a href="#" id="thread-number-edit" style=""><%= global["threadnumber"] %></a></strong>
          </div>

          <div class="nowrap" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Run type determines how many time script will run. This setting doesn't affect 'Record mode', if you want to repeat script execution, you need to stop 'Record mode' and start script in 'Run mode'. Start editing this value to discover available types.") %>">
            <span style="white-space: nowrap;">
              <span class="<%= (global["successnumber"] == 1 && global["failnumber"] == 1) ? "text-danger" : "text-success"  %>" >&#x25CF;</span>
              <span class="small"><%= tr("Run Type") %></span>: 
              <strong >
                <a href="#" id="runmode-edit" style="">
                  <% if(global["successnumber"] == 1 && global["failnumber"] == 1){ %>
                    <span><%= tr("One time") %></span>
                  <% }else if(global["successnumber"] >= 100000 && global["failnumber"] >= 100000){ %>
                    <span><%= tr("Repeat") %></span>
                  <% }else{ %>
                    <span><%= tr("Custom") %></span>
                  <% } %>
                </a> 
              </strong>
            </span>
          </div>

          <% if(!((global["successnumber"] == 1 && global["failnumber"] == 1) || (global["successnumber"] >= 100000 && global["failnumber"] >= 100000))){ %>
            <div class="nowrap">
              
              <span style="white-space: nowrap;">
                <span style="color:gray">&#x25CF;</span>


                <span class="small" data-toggle="tooltip" data-placement="bottom" title="<%= tr("Each script launch has a successful or failure result, for example, successful run could be when account was registered and failure may be because not working proxy. With this type you can limit successful and fail execution number. For example, by setting success number to 100 and fail number to 10, you are telling engine to stop execution after 100 successful account registration or after 10 failures during registration.") %>"><%= tr("Run Number") %></span>: 
                
                <a href="#" id="success-number-edit" style="text-decoration-color: green;">
                  <strong class="text-success"
                    <%= global["successnumber"].toString().length > 15 ? (('data-toggle="tooltip" data-placement="bottom" title="') + quoteattr(global["successnumber"]) + ('"')) : '' %> 
                  >
                    <%= global["successnumber"].toString().length > 15 ? (global["successnumber"].toString().substr(0,15) + " ... ") : global["successnumber"] %>
                  </strong>
                </a> 
                
                <span style="margin-left:3px;margin-right:3px;">&#x0338; </span>

                <a href="#" id="fail-number-edit" style="text-decoration-color: red;">
                  <strong class="text-danger"  
                    <%= global["failnumber"].toString().length > 15 ? (('data-toggle="tooltip" data-placement="bottom" title="') + quoteattr(global["failnumber"]) + ('"')) : '' %> 
                  >
                    <%= global["failnumber"].toString().length > 15 ? (global["failnumber"].toString().substr(0,15) + " ... ") : global["failnumber"] %>
                  </strong>
                </a> 
              </span>
            </div>
          <% } %>

        </div>
      </div>
      <div class="maintoolbox">
        <span id="selectiontemplatecontainer"></span>
      </div>
    </div>
    <div class="main" style="padding-bottom: <%= (_Inspector.$el.is(':visible') ? _Inspector.$el.height() : 0) + 50 %>px;">
      <div id="paddinfind"></div>
      <% for(var indexraw = 0;indexraw<data.length;indexraw++){ %>
        <% var index = indexraw - 1 + index_start;%>
        <% if (indexraw == 0) { index = 0; } %>
        <%var task = data[indexraw]; %>
          <% var CanDisplay = global.function_name == GetFunctionData( parseInt(task.get("id")) )["name"] && !IsFunctionNode(parseInt(task.get("id"))) %>
          <% if(CanDisplay) {%>

            <% var len = GetTaskDepth(task.get("id")); %>
            <% if(GetFunctionData(task.get("id"))["id"] != 0) len--; %>

            <div id="id1-<%= task.get("id") %>" class="tool-margin <%= (prepare_folding(task.get("parentid"), parseInt(task.get("id")), len)) ? "" : "folded" %>" style="<%= prepare_margins(task.get("parentid"), len, "compute") %>"  task-id=<%= task.get("id") %> parent-id="<%= task.get("parentid") %>" data-margin="<%= len %>" >
              <div id="id2-<%= task.get("id") %>" class="tool-div">

                <% if(NeedToShowUpperInsert(index)){ %>
                  <div id="id3-<%= task.get("id") %>" class="toolinsertdata" data-toggle="tooltip" data-placement="auto" title="<%= tr("A place where new action can be inserted or moved. Click to make it active.") %>" task-id="-<%= task.get("id") %>" data-insert-index="-1" data-insert-parent="<%= task.get("parentid") %>" data-insert-id="<%= task.get("id") %>">
                    <div id="id4-<%= task.get("id") %>" class="toolinsert<%= (global.insert_index == -index && global.insert_parent == task.get("parentid") || global.insert_index == 0 && (parseInt(task.get("id")) == parseInt(GetFirstNotFunctionId())) ) ? " toolselected":"" %>"></div>
                    <div id="id5-<%= task.get("id") %>" noupdate class="toollabelcreate" draggable="true" data-toggle="tooltip" data-placement="auto" title="<%= tr("Drag this arrow in order to create new label and move execution point to other place.") %>"><i class="fa fa-arrow-circle-right"></i></div>
                  </div>
                <% } %>
                <div id="id6-<%= task.get("id") %>" <%= prepare_label_data(task.dat(),task.get("name")) %> class=" <%= (task.get("donotexecuteduringrecord"))? "notactive" : "" %> <%= (task.get("color").length > 0) ? ("action-color-" + task.get("color")) : "" %> tool <%= (index==0)? "toolmenufirst" : (AllowToExecuteOnce(task.get("id")) ? "toolmenuextended" : "toolmenu") %> <%= ((parseInt(task.get("id")) == parseInt(GetFirstNotFunctionId()) && global.execute_next_id == 0 || global.execute_next_id == task.get("id") ) && index != 0)? "toolexecutecurrent" : "toolnotexecute" %> taskcontainer" task-id="<%= task.get("id") %>" data-index="<%= index == 0 ? "0" : "-1" %>" <%= (parseInt(task.get("id")) == 0) ? "" : "draggable=\"true\"" %> <%= (parseInt(task.get("id")) == 0) ? ("data-toggle=\"tooltip\" data-placement=\"top\" title=\"" + prepare_title_tooltip(task.dat(),task.get("name")) + "\"") : "" %>
>


                  <div id="id7-<%= task.get("id") %>" class="tooltitle <%= prepare_styles(task.dat(),task.get("name") ) %>"> <%= prepare_group(task.dat(),task.get("name"),task.get("id")) %> <%= prepare_title(task.dat(),task.get("name")) %> <span id="id71-<%= task.get("id") %>" class="disablenotice" task-id="<%= task.get("id") %>"><%= (task.get("donotexecuteduringrecord"))? " (" + tr("disabled") + ")" : "" %></span>

                    <img id="id8-<%= task.get("id") %>" class="selected" src="icons/selected.png" style="<%= (!task.get("is_selected")) ? "visibility:hidden" : "" %>"></img>
                  </div>

                  <div id="id9-<%= task.get("id") %>" class="titlebody " style="position:relative">

                    <% if(task.get("id")!=0){ %>
                      <span id="id10-<%= task.get("id") %>" noupdate class="executing" data-toggle="tooltip" data-placement="auto" title="<%= tr("Click to move execution point here.") %>"><i class="fa fa-arrow-right"></i></span>
                    <% } %>

                    <% if(task.get("id")!=0 && task.get("name") != "Else"){ %>
                      <span id="id11-<%= task.get("id") %>" noupdate class="ignoreerrorsthis" data-toggle="tooltip" data-placement="auto" title="<%= tr("Click to process error during execution of this action.") %>"><i class="fa fa-exclamation-triangle"></i></span>
                    <% } %>
                    
                    <span id="id12-<%= task.get("id") %>">
                      <%= prepare_body(task.dat(),task.get("name")) %>
                    </span>

                    <% if(task.get("id")!=0 && task.get("code").indexOf("section_insert") >= 0 && task.get("name") != "Else"){ %>
                      
                      <span id="id13-<%= task.get("id") %>" class="folding-unfolded" <%= task.get("is_fold") ? "style='display:none'" : "" %> task-id="<%= task.get("id") %>" ><i id="id14-<%= task.get("id") %>" noupdate class="fa fa-arrow-circle-down"></i></span>
                    
                      <span id="id15-<%= task.get("id") %>" class="folding-folded" <%= task.get("is_fold") ? "" : "style='display:none'" %> task-id="<%= task.get("id") %>" ><i id="id16-<%= task.get("id") %>" noupdate class="fa fa-arrow-circle-left"></i></span>
                    <% } %>


                  </div>

                  <% var description = prepare_description(task.dat(),task.get("name"));if(description.length > 0){ %>
                    <div class="titledescription" id="id17-<%= task.get("id") %>">
                      <%= description %>
                    </div>  
                  <% } %>

                  <div class="titleid" id="id18-<%= task.get("id") %>" noupdate>
                    Id: <%= task.get("id") %>
                  </div>  
                </div>

                <% if(NeedToShowLowerInsert(index)){ %>
                  <div id="id19-<%= task.get("id") %>" class="toolinsertdata" data-toggle="tooltip" data-placement="auto" title="<%= tr("A place where new action can be inserted or moved. Click to make it active.") %>" task-id="<%= task.get("id") %>" data-insert-index="-1" data-insert-parent="<%= task.get("parentid") %>">
                    <div id="id20-<%= task.get("id") %>" class="toolinsert<%= (global.insert_index == index && global.insert_parent == task.get("parentid")) ? " toolselected":"" %>" ></div>
                    <div id="id21-<%= task.get("id") %>" noupdate class="toollabelcreate" draggable="true" data-toggle="tooltip" data-placement="auto" title="<%= tr("Drag this arrow in order to create new label and move execution point to other place.") %>"><i id="id22-<%= task.get("id") %>" noupdate class="fa fa-arrow-circle-right"></i></div>

                  </div>
                <% } %>

              </div>
            </div>
            <% } %>
            <% if(CanDisplay || IsEmptyFunctionNode(parseInt(task.get("id"))) && GetFunctionDataOfThisNode(parseInt(task.get("id")))["name"] == global.function_name ){ %>
              <% _.each(GetGroupsEndings(index), function(ending, current_index) { %>

              <% var endinglevel = ending["level"] %>
              <% if(GetFunctionData(task.get("id"))["id"] != 0) endinglevel--; %>
               <% if(endinglevel>=0){ %>
                 <div id="id23-<%= task.get("id") %>-<%= current_index %>" class="tool-margin <%= (prepare_folding(ending["parentid"], 0, endinglevel)) ? "" : "folded" %>" style="<%= prepare_margins(ending["parentid"], endinglevel, "compute") %>" parent-id="<%= ending["parentid"] %>" data-margin="<%= endinglevel %>">

                   <div id="id24-<%= task.get("id") %>-<%= current_index %>" class="tool-div">
                    <div id="id25-<%= task.get("id") %>-<%= current_index %>" class="toolinsertdata" data-toggle="tooltip" data-placement="auto" title="<%= tr("A place where new action can be inserted or moved. Click to make it active.") %>" task-id="<%= task.get("id") %>" data-insert-index="-1" data-insert-parent="<%= ending["parentid"] %>">
                      <div id="id26-<%= task.get("id") %>-<%= current_index %>" class="toolinsert toolinsertright<%= (global.insert_index == index && global.insert_parent == ending["parentid"]) ? " toolselected":"" 
                      %>" ></div>
                      <div id="id27-<%= task.get("id") %>-<%= current_index %>" noupdate class="toollabelcreate" draggable="true" data-toggle="tooltip" data-placement="auto" title="<%= tr("Drag this arrow in order to create new label and move execution point to other place.") %>"><i class="fa fa-arrow-circle-right"></i></div>

                    </div>
                   </div>
                   <div id="id28-<%= task.get("id") %>-<%= current_index %>" noupdate class="clearfix"></div>
                 </div>
               <% } %>

              <% }); %>

            <% } %>

      <% }; %>
      <%if(GetFirstNotFunctionId() == 0 && global["function_name"] == "Main"){%>
        <div id="id29-<%= task.get("id") %>" class="tool-div">
          <div id="id30-<%= task.get("id") %>" class="toolinsertdata" data-toggle="tooltip" data-placement="auto" title="<%= tr("A place where new action can be inserted or moved. Click to make it active.") %>" task-id="0" data-insert-index="0" data-insert-parent="0">
            <div id="id31-<%= task.get("id") %>" class="toolinsert toolinsertright<%= (global.insert_index == 0 && GetFirstNotFunctionId() == 0) ? " toolselected":"" %>"></div>
            <div id="id32-<%= task.get("id") %>" noupdate class="toollabelcreate" draggable="true" data-toggle="tooltip" data-placement="auto" title="<%= tr("Drag this arrow in order to create new label and move execution point to other place.") %>"><i class="fa fa-arrow-circle-right"></i></div>

          </div>
        </div>
      <% } %>
      <svg id="visualizelabels" style="z-index:-100">
        <defs>
          <marker id="Arrow0" markerWidth="10" markerHeight="10" refX="6" refY="2" orient="auto" markerUnits="strokeWidth">
            <path d="M0,1 L5,2 L0,3" stroke="#bbe2ab" fill="none"></path>
          </marker>
          <marker id="Arrow1" markerWidth="10" markerHeight="10" refX="6" refY="2" orient="auto" markerUnits="strokeWidth">
            <path d="M0,1 L5,2 L0,3" stroke="#d9d4a1" fill="none"></path>
          </marker>
          <marker id="Arrow2" markerWidth="10" markerHeight="10" refX="6" refY="2" orient="auto" markerUnits="strokeWidth">
            <path d="M0,1 L5,2 L0,3" stroke="#a8d6d4" fill="none"></path>
          </marker>
          <marker id="Arrow3" markerWidth="10" markerHeight="10" refX="6" refY="2" orient="auto" markerUnits="strokeWidth">
            <path d="M0,1 L5,2 L0,3" stroke="#a7bed9" fill="none"></path>
          </marker>
          <marker id="Arrow4" markerWidth="10" markerHeight="10" refX="6" refY="2" orient="auto" markerUnits="strokeWidth">
            <path d="M0,1 L5,2 L0,3" stroke="#e6bbbb" fill="none"></path>
          </marker>
        </defs>
      </svg>
    </div>
    <div class="bottompannel">
      <div id="inspector" style="display: none; height: 300px;" noupdate>
        <div class="handle" style="background: #dbdbdb; cursor: ns-resize; height: 6px;"></div>
        <div style="height: calc(100% - 6px); position: relative; display: flex;">
          <iframe src="inspector/frame/index.html?lang=<%= _K %>" style="border: 0; width: 100%; height: 100%;"></iframe>
          <div class="loader" style="display: none;">
            <button type="button" onclick="_Inspector.hide()">
              <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.87348 12.2583L3.93414 13.3189L8 9.25305L12.0659 13.3189L13.1265 12.2583L9.06066 8.19239L13.1265 4.12652L12.0659 3.06586L8 7.13173L3.93414 3.06586L2.87348 4.12652L6.93934 8.19239L2.87348 12.2583Z" fill="#606060" />
              </svg>
            </button>
            <span><%= tr('Variables will be loaded on next script pause') %></span>
          </div>
        </div>
      </div>
      <div id="functions">
        <a id="FunctionName" title="<%= tr('Current function name. Functions are containers, which holds action list. It helps to group several actions which does same task. For example, there can be function which logins to account, function that checks account balance, etc. It makes your code clear and well organized.') %>">
          <%= global.function_name %>
        </a>
      </div>
    </div>
  </script>

  <script type="text/template" id="start">
    browser()!
  </script>

  <script type="text/template" id="resource_code">
      RS("<%= je(resource) %>", <%= notreuse %>, <%= onlyfail %>)!
      <%= variable %> = _result().get()
  </script>

  <script type="text/template" id="function_code">
      function <%= name %>()
      {
        section_insert()
      }
  </script>

  <!-- ========= -->
  <!-- Libraries -->
  <!-- ========= -->
  <script src="jquery-2.1.3.min.js"></script>
  <script src="underscore-min.js"></script>
  <script src="backbone-min.js"></script>
  <script src="bootstrap.min.js"></script>
  <script src="context.js"></script>
  <script src="bootbox.min.js"></script>
  <script src="vendor/resizable/resizable.min.js"></script>
  <script src="vendor/velocity/velocity.min.js"></script>
  <script src="diff_match_patch_uncompressed.js"></script>
  <script src="mark.js"></script>
  <script src="vendor/bootstrap-select/bootstrap-select.min.js"></script>
  <script src="morphdom.js"></script>

  <!-- ========= -->
  <!--  Scripts  -->
  <!-- ========= -->
  <script>window.App = { Inspector: {}, utils: {} };</script>
  <script src="../actions/actions.js"></script>
  <script src="utility/logger.js"></script>
  <script src="utility/utils.js"></script>
  <script src="translate.js"></script>
  <script src="undo.js"></script>
  <script src="actionfinder.js"></script>
  <script src="multiselect.js"></script>
  <script src="draganddrop.js"></script>
  <script src="updategotos.js"></script>
  <script src="embeddedmodel.js"></script>
  <script src="edgescroll.js"></script>
  <script src="functionmanager.js"></script>
  <script src="webinterfacetasks.js"></script>
  <script src="visualizelabels.js"></script>
  <script src="helpmanager.js"></script>
  <script src="updater/internal/backbone.events.js"></script>
  <script src="updater/internal/progressbar.js"></script>
  <script src="updater/internal/translate.js"></script>
  <script src="updater/internal/utils.js"></script>
  <script src="updater/updater.js"></script>
  <script src="moveexecutionpoint.js"></script>
  <script src="inspector/inspector.js"></script>
  <script src="inspector/modal.js"></script>
  <script>_.extend(window.App, Backbone.Events);</script>

  <script> _L = $.extend(_L, _AL) </script>
  <script> _MACRO_INSERT_LOCALIZE_ </script>
  <script> _MACRO_INSERT_ACTIONS_ </script>

  <!-- ========= -->
  <!--   Styles  -->
  <!-- ========= -->
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="context.standalone.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="font-awesome.min.css">
  <link rel="stylesheet" href="vendor/bootstrap-select/bootstrap-select.min.css">
  <link rel="stylesheet" href="checkbox.min.css">
  <link rel="stylesheet" href="inspector/inspector.css">
  <link rel="stylesheet" href="inspector/modal.css">
  <link rel="stylesheet" href="updater/updater.css">

  <!-- =============== -->
  <!-- Javascript code -->
  <!-- =============== -->
  <script>

    var TaskModel = Backbone.Model.extend({
        defaults: {
            name: "",
            code: "",
            internal_label_id: "",

            dat_precomputed: null,
            search_precomputed: null,
            code_precomputed: null,
            
            parentid: 0,
            id: 0,
            donotexecuteduringrecord:false,
            is_selected:false,
            color:"",
            is_fold: false,
            fd: ""
        },
        initialize: function ()
        {
            this.on('change', function(){
              this.attributes['dat_precomputed'] = null
              this.attributes['search_precomputed'] = null
              this.attributes['code_precomputed'] = null
            }, this);
        },
        dat: function()
        {
          if(this.attributes['dat_precomputed'] === -1)
            return null

          if(this.attributes['dat_precomputed'] !== null)
            return this.attributes['dat_precomputed']
          
          var match = this.get("code").match("Dat:([^\*]+)")
          if(!match)
          {
            this.attributes['dat_precomputed'] = -1
            return null
          }

          var dat = JSON.parse(b64_to_utf8(match[1]))
          this.attributes['dat_precomputed'] = dat

          return dat
        },
        toJSON: function()
        {
          var attr = this.attributes
          return {name: attr.name,
            code: attr.code,
            internal_label_id: attr.internal_label_id,

            dat_precomputed: null,
            search_precomputed: null,
            code_precomputed: null,
            
            parentid: attr.parentid,
            id: attr.id,
            donotexecuteduringrecord:attr.donotexecuteduringrecord,
            is_selected:attr.is_selected,
            color:attr.color,
            is_fold: attr.is_fold,
            fd: attr.fd
          }
        },
        search: function()
        {
          if(this.attributes['search_precomputed'] === -1)
            return []

          if(this.attributes['search_precomputed'] !== null)
            return this.attributes['search_precomputed']

          var res = []

          /* id */
          res.push("Id: " + this.get("id"))

          /* description */
          if(this.get("name").length > 0)
            res.push(this.get("name"))

          var dat = this.dat()

          if(dat === null)
            return res

          /* name */
          res.push(tr(_A[dat["s"]]["name"]))

          /* body */
          var body = BrowserAutomationStudio_GenerateActionText("", dat, 999999, true)
          if(body.length > 0)
            res.push(body)


          this.attributes['search_precomputed'] = res


          return res

        }

    });
    var GobalModel = Backbone.Model.extend({
        defaults: {
            state: "main",
            istaskexecuting: false,
            isscriptexecuting: false,
            isexecutionaborting: false,
            execute_next_id: 0,
            isstepnextactivated: false,
            insert_index: 0,
            insert_parent: 0,
            current_run_until_target_id: -1,
            run_only_one_enabled: false,
            dontsend: true,
            threadnumber: 1,
            successnumber: 1,
            failnumber: 1,
            function_name: "Main",
        },
        initialize: function () {  
          this.bind("change:execute_next_id", function(model) {  
            var execute_next_id = model.get("execute_next_id");
            _WebInterfaceTasks.CurrentIdChanged(execute_next_id)
          });

          this.on("change:isscriptexecuting", (_, value) => {
            log.info(`The script has been ${value ? "started" : "completed"}`);
            _Inspector.wait(value);

            if (!value) requestUpdate();
          });

          this.on("change:istaskexecuting", (_, value) => {
            log.info(`The task has been ${value ? "started" : "completed"}`);
            _Inspector.wait(value);

            if (!value) requestUpdate();
          });

          const requestUpdate = () => _.defer(() => {
            if (!this.get("isexecutionaborting")) {
              if (VariablesUpdateSkip) {
                VariablesUpdateSkip = false;
                return BrowserAutomationStudio_AskForVariablesUpdateIfNeeded();
              }
              return BrowserAutomationStudio_AskForVariablesUpdate();
            }
            this.once("change:isexecutionaborting", (_, value) => value || requestUpdate());
          });
        }  
    });
    var TaskCollection = Backbone.Collection.extend({
        model: TaskModel
    });

    var _ActionFinder = new ActionFinder()
    _ActionFinder.Initialize();

    bootbox.setLocale(_K);

    var MainView = Backbone.View.extend({
      el: '#container',
      currentTargetId: 0,
      isEdit: false,
      idInsertBefore: -1,
      idInsertAfter: -1,
      idInsertParent: -1,
      currentFuncName: "",

      events: {
        "click .executing": "moveexecutionpointfast",
        "click .folding-unfolded": "fold",
        "click .folding-folded": "unfold",
        "mouseup .tool": "mousedowntool",
        "click .resok": "taskedit",
        "hidden.bs.modal #editmodal": "taskcancel",
        "click .toolinsertdata": "toolinsertdata",
        "click .ignoreerrorsthis": "ignoreerrorsthis",
        "click #action-copy": "Copy",
        "click #action-paste": "Paste",
        "click #action-undo": "Undo",
        "click #action-redo": "Redo",
        "click #action-cut": "Cut",
        "click #action-checkall" :"CheckAll",
        "click #action-uncheckall" :"ClearSelection",
        "click #play": "play",
        "click #stepnext": "stepnext",
        "mousedown #pause": "pause",
        "click #restart": "restart",
        "click #stop": "stop",
        "change #FunctionName": "setfunctionname",
        "click #FunctionName": "showfunctionmanager",

        "click #addfunction": "addfunction",

        "click #editfunction": "editfunction",
        "click #removefunction": "removefunction",
        "click .funcok": "funcok",
        "click .runmodeok": "runmodeok",
        
        "click .paramok": "paramok",
        "click .onapplicationstart": "onapplicationstart",
        "click #thread-number-edit": "threadnumberedit",
        "click #runfunction": "runfunction",
        "click #runfunctionseveralthreads": "runfunctionseveralthreads",

        "click #success-number-edit": "successnumberedit",
        "click #fail-number-edit": "failnumberedit",
        "click #runmode-edit": "runmodeedit",
        "click .color-select": "selectcolor"
      },

      showfunctionmanager: function(event)
      {
        if(_FunctionManager.IsVisible())
        {
          _FunctionManager.Hide()
        }else
        {
          _FunctionManager.RenderDefault();
          _FunctionManager.Show()
        }
      },

      fold: function(event)
      {
        var task = FindTaskById(parseInt($(event.target).closest("*[data-index]").attr("task-id")));

        if(task)
        {
          task.attributes["is_fold"] = true
          task.attributes["code_precomputed"] = null
          $(".folding-unfolded[task-id='" + task.get("id") + "']").hide()
          $(".folding-folded[task-id='" + task.get("id") + "']").show()
          this.RecalculateFolding($(".tool-margin"))
        }
        BrowserAutomationStudio_SaveToUndoManager();
        this.send()
        event.preventDefault();


      },

      unfold: function(event)
      {
        var task = FindTaskById(parseInt($(event.target).closest("*[data-index]").attr("task-id")));

        if(task)
        {
          task.attributes["is_fold"] = false
          task.attributes["code_precomputed"] = null
          $(".folding-unfolded[task-id='" + task.get("id") + "']").show()
          $(".folding-folded[task-id='" + task.get("id") + "']").hide()
          this.RecalculateFolding($(".tool-margin"))
        }
        BrowserAutomationStudio_SaveToUndoManager();
        this.send()
        event.preventDefault();

      },

      selectcolor: function(event)
      {
        $(".color-select").removeClass("color-select-active")
        var el = $(event.target)
        el.addClass("color-select-active")
        event.preventDefault();

      },

      moveexecutionpointfast: function(event)
      {
        if (_GobalModel.get("isscriptexecuting") || _GobalModel.get("istaskexecuting")) return;

        var task = FindTaskById(parseInt($(event.target).closest("*[data-index]").attr("task-id")));

        if(task && task.get("id") != this.model.get("execute_next_id"))
        {
          var execute_point_code = GenerateCodeForMovingExecutionPoint(this.model.get("execute_next_id"), task.get("id"))

          _WebInterfaceTasks.MovedExecutionPoint(this.model.get("execute_next_id"), task.get("id"))
          var second_line = "debug_callstack()!\nsection_start(\"test\", " + task.get("id") + ")!"
          var code = execute_point_code + "\n" + second_line
          BrowserAutomationStudio_Execute(code, false)
        }

        
        event.preventDefault();
      },

      runfunction: function(event)
      {
        BrowserAutomationStudio_RunFunction();
        event.preventDefault();
      },
      
      runfunctionseveralthreads: function(event)
      {
        BrowserAutomationStudio_RunFunctionSeveralThreads();
        event.preventDefault();
      },
      threadnumberedit: function(event)
      {
        BrowserAutomationStudio_ThreadNumberEdit();
        event.preventDefault();
      },
      successnumberedit: function(event)
      {
        BrowserAutomationStudio_SuccessNumberEdit();
        event.preventDefault();
      },
      runmodeedit: function(event)
      {
        if(_GobalModel.get("successnumber") == 1 && _GobalModel.get("failnumber") == 1)
        {
          $("[value=OneTime]").prop("checked", true);
          $('.RunTypeLabel').hide();
          $("#OneTimeLabel").show();

        }else if(_GobalModel.get("successnumber") >= 100000 && _GobalModel.get("failnumber") >= 100000)
        {
          $("[value=Repeat]").prop("checked", true);
          $('.RunTypeLabel').hide();
          $("#RepeatLabel").show();
        }else
        {
          $("[value=Custom]").prop("checked", true);
          $('.RunTypeLabel').hide();
          $("#CustomLabel").show();
        }
        $('#RunModeModal').modal();
        event.preventDefault();
      },
      failnumberedit: function(event)
      {
        BrowserAutomationStudio_FailNumberEdit();
        event.preventDefault();
      },

      RecalculateMargins: function(elements, default_value)
      {
        var len = elements.length
        for(var i = 0;i<len;i++)
        {
          var el = $(elements[i])
          var style = prepare_margins(parseInt(el.attr("parent-id")), parseInt(el.attr("data-margin")), default_value)
          el.attr("style",style)
        }
      },

      RecalculateFolding: function(elements)
      {
        var len = elements.length
        for(var i = 0;i<len;i++)
        {
          var el = $(elements[i])
          var res = prepare_folding(parseInt(el.attr("parent-id")), parseInt(el.attr("task-id")), parseInt(el.attr("data-margin")))
          if(res)
            el.removeClass("folded")  
          else
            el.removeClass("folded").addClass("folded")  
        }
        _VisualizeLabels.Visualize()

      },

      CheckAll: function()
      {
          this.ClearSelection()

          this.model.set("dontsend",true)

          _.every(BrowserAutomationStudio_GetCurrentVisibleTasks(), function(task,index){
              try{
                var id = Number(task.get("id"))
                if(id !== 0 && GetFunctionData(id)["name"] == _GobalModel.get("function_name") && !IsFunctionNode(id))
                {
                  if(task.attributes["is_selected"] != true)
                    task.attributes["code_precomputed"] = null
                  task.attributes["is_selected"] = true
                }
                  
              }catch(e){}
             return true 
            })

           $(".taskcontainer .selected").css("visibility","visible")
           $(".taskcontainer[data-index=0] .selected").css("visibility","hidden")
           this.RecalculateMargins($(".tool-margin"),"set")

         this.model.set("dontsend",false)
         BrowserAutomationStudio_SaveToUndoManager()
         BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
         this.renderselectiontemplatecontainer()
         //this.render()
      },
     
      
      onapplicationstart: function()
      {
        $("#EditFunctionName").val("OnApplicationStart")
      },

      paramok: function(e)
      {
        var Name = $("#EditParameterName").val()
        var Type = $("#EditParameterType").val()
        var Description = $("#EditParameterDescription").val()
        var Defaults = $("#EditParameterDefaults").val()
        var ReturnError = _FunctionManager.AddOrChangeParam(Name, Type, Description, Defaults);
        if(ReturnError)
        {
          e.preventDefault();
          $("#validationParam").html(ReturnError)
          $("#editparametermodal").modal({})
          return
        }
      },

      runmodeok: function(e)
      {
        var Val = $("input[name='RunModeRadio']:checked").val();
        if(Val == "OneTime")
        {
          _GobalModel.set("successnumber",1)
          _GobalModel.set("failnumber",1)
          _MainView.send()
        }
        if(Val == "Repeat")
        {
          _GobalModel.set("successnumber",1000000)
          _GobalModel.set("failnumber",1000000)
          _MainView.send()
        }
        if(Val == "Custom")
        {
          _GobalModel.set("successnumber",10)
          _GobalModel.set("failnumber",10)
          _MainView.send()
        }
      },

      funcok: function(e)
      {

        var name = $("#EditFunctionName").val()

        if(name.length == 0 )
        {
          e.preventDefault();
          $("#validation").html("Function name is empty")
          $("#editfunctionmodal").modal({})
          return
        }

        var f = name.charCodeAt(0)
        if(f >= 48 && f <= 57)
        {
          e.preventDefault();
          $("#validation").html("Function name starts from digit")
          $("#editfunctionmodal").modal({})
          return
        }

        if(name.indexOf("VAR_") == 0)
        {
          e.preventDefault();
          $("#validation").html("Function name starts from VAR_")
          $("#editfunctionmodal").modal({})
          return
        }

        var no_allowed = "print,gc,version,Helper,CsvHelper,HtmlParser,Browser,ScriptWorker,Results1,Results2,Results3,Results4,Results5,Results6,Results7,Results8,Results9,Logger,FactorySolver,EngineRes,ResourceHandlers,Properties,_K,MemoryInfo,ResourceLoader,_template,tr,_L,Cycle,Cycles,_next,_next_or_section,_kill_call_stack,_break,_iterator,_arguments,_do,_repeat,_if,_if_else,_call,_call_section,_result,_set_result,_return,_set_label,_rewind,_goto,_fast_goto,VAR_CYCLE_INDEX,VAR_FOREACH_DATA,LINK_REGEXP,VAR_FOR_EACH_CSS,VAR_FOR_EACH_MATCH,VAR_FOR_EACH_XPATH,IF_ELSE_EXPRESSION,CYCLES,memory_virtual_total,memory_virtual_available,memory_physical_total,memory_physical_available,html_parser_xpath_parse,html_parser_xpath_xml,html_parser_xpath_count,html_parser_xpath_exist,html_parser_xpath_text,html_parser_xpath_xml_list,html_parser_xpath_text_list,_get_function_body,rand,_spintax,proxy_parse,proxy_pack,parse_json,md5,base64_encode,base64_decode,file_read,file_read_base64,file_write,file_write_base64,file_append,file_append_base64,directory_of,directory_create,filename_of,combine_path,encode_string,image_get_dimension,image_central_crop,oauth1_header,csv_parse,csv_generate,date_format,date_format_now,db_date_now,translit,_stop_subscript_execution,fail,die,success,request_variables,debug_variables,_get_actual_http_client,_switch_http_client_main,_switch_http_client_internal,_switch_http_client,_ensure_http_client,on_http_client_loaded,new_http_client,http_client_set_fail_on_error,http_client_was_error,http_client_error_string,http_client_get,http_client_get2,http_client_download,http_client_solve,http_client_post,http_client_get_no_redirect,http_client_get_no_redirect2,http_client_post_no_redirect,http_client_url,http_client_content,http_client_content_base64,http_client_header,http_client_status,http_client_set_header,http_client_clear_header,http_client_proxy,http_client_set_proxy,http_client_get_cookies,http_client_save_cookies,http_client_restore_cookies,http_client_xpath_parse,http_client_xpath_xml,http_client_xpath_text,http_client_xpath_xml_list,http_client_xpath_text_list,http_client_xpath_count,http_client_xpath_exist,HttpClientIndex,_ensure_pop3_client,new_pop3_client,pop3_client_set_config,pop3_client_proxy,pop3_client_was_error,pop3_client_error_string,pop3_client_set_proxy,pop3_client_pull_messages_length,pop3_client_pull_message,pop3_client_messages_length,pop3_client_body,pop3_client_subject,pop3_client_sender,_ensure_imap_client,new_imap_client,imap_client_set_config,imap_client_set_proxy,imap_client_proxy,imap_client_was_error,imap_client_error_string,imap_client_pull_messages_length,imap_client_messages_length,imap_client_search,imap_client_custom_search,imap_client_search_result,imap_client_pull_message,imap_client_message,imap_custom_query,imap_custom_query_result,imap_custom_query_log,waiter_timeout_next,waiter_nofail_next,wait_url,wait_load,wait_memory,waiter_prepare_frames,waiter_create_css_path,waiter_create_match_path,wait_content_visible,wait_css_visible,wait_content,wait_css,wait_async_load,wait,get_element_selector,wait_element,wait_element_visible,BROWSERAUTOMATIONSTUDIO_WAIT_TIMEOUT,BROWSERAUTOMATIONSTUDIO_FULL_LOAD_TIMEOUT,BROWSERAUTOMATIONSTUDIO_WAIT_TIMEOUT_NEXT,BROWSERAUTOMATIONSTUDIO_WAIT_NOFAIL_NEXT,_get_last_record_id,RS,R,RSafe,Refuse,RIsRefused,Reload,RInsert,RSync,RCreate,RTake,RSuccessAll,RFailAll,RDieAll,RInfo,RPick,RPickRandom,RMap,_R,_RKEY,P,PSet,PClear,_ensure_browser_created,_simulate_crush,_settings,new_browser,_mbr,_mar,browser,close_browser,mouse,mouse_up,mouse_down,timezone,geolocation,popupclose,popupselect,render,scroll,_default_move_params,move,_clarify,wait_code,section_end,load,load_instant,open_file_dialog,prompt_result,http_auth_result,screenshot,url,get_cookies,resize,reset,jquery,optimize,save_cookies,restore_cookies,restore_localstorage,page,clear_log,log,log_html,log_success,log_fail,ResultResolve,result,result_html,result_file,css,frame,frame_css,xpath,xpath_all,frame_match,position,match,match_all,all,thread_number,success_number,project_path,fail_number,sleep,script,font_list,onloadjavascript,onloadjavascriptinternal,agent,antigate,rucaptcha,twocaptcha,capmonster,solver_properties_clear,solver_property,dbc,_solver_properties_list,solve,solve_base64,solve_base64_no_fail,solver_failed,progress,progress_value,progress_maximum,suspend,on_fail,clear_on_fail,on_success,clear_on_success,_on_fail,_on_fail_exceed,_on_success_exceed,_finnaly,_clear_on_fail,_on_success,_clear_on_success,_set_max_fail,_set_max_success,DEC,_db_add_record,_db_select_records,_db_delete_records,_db_update_record,_db_add_group,_on_start,native,native_async,general_timeout_next,general_timeout,async_load_timeout,solver_timeout_next,solver_timeout,_preprocess,VAR_WAS_ERROR,VAR_LAST_ERROR,_BAS_SOLVER_PROPERTIES,open_browser,_DEFAULT_MOVE_PARAMS,_set_target,_get_target,_get_network_access_manager,header,header_order,clear_header,proxy,set_proxy,cache_allow,cache_deny,request_allow,request_deny,cache_get_base64,cache_get_string,cache_get_status,cache_clear,cache_data_clear,cache_masks_clear,is_load,get_load_stats,_restrict_popups,_allow_popups,_restrict_downloads,_allow_downloads,_BROWSERAUTOMATIONSTUDIO_TARGET,section_start,_sa,section_insert,_clear_image_data,_set_image_data,_find_image,_image,_wait_image,IMAGE_FINDER,BrowserAutomationStudio_ApplyFingerprint,NumbersParseRecaptcha2,BAS_CapmonsterUpdateImage,BAS_SolveRecaptcha,BAS_CAPMONSTER_IMAGE_ID,_BAS_GETSMSSITECODE,_BAS_PARSEJSONFROMHTTPCLIENT,_sms_ban_thread,_sms_ban_service,_sms_before_request,_BAS_SMSREGAPIREQUEST,_BAS_SMSACTIVATEPIREQUEST,_BAS_SMSPVAREQUEST,_BAS_SMSCONFIRMDATA,_SMS_BAN_THREAD,_SMS_DEBUG,NetworkAccessManager"

        if(no_allowed.split(",").indexOf(name) >= 0)
        {
          e.preventDefault();
          $("#validation").html("Function name not allowed")
          $("#editfunctionmodal").modal({})
          return
        }
        var FunctionName = _FunctionManager.GetEditingFunctionName()
        if(FunctionName.length == 0)
        {
          if(_.find(GetFunctionList(), function(el){ return el["name"] == name; }))
          {
            e.preventDefault();
            $("#validation").html("Function " + name + " already exists")
            $("#editfunctionmodal").modal({})
            return
          }
        }else 
        {
          if(_.find(GetFunctionList(), function(el){ return el["name"] == name; }) && name != FunctionName)
          {
            e.preventDefault();
            $("#validation").html("Function " + name + " already exists")
            $("#editfunctionmodal").modal({})
            return
          }

        }
        _FunctionManager.SetFunctionName(name);


        /*if(this.currentFuncName.length == 0)
        {
          if(_.find(GetFunctionList(), function(el){ return el["name"] == name; }))
          {
            e.preventDefault();
            $("#validation").html("Function " + name + " already exists")
            $("#editfunctionmodal").modal({})
            return
          }
          var id = Math.floor(Math.random() * (1000000000 - 100)) + 100
          var code = Normalize(_.template($('#function_code').html())({name:name}))
          var task = { name: name, code: code, id: id, donotexecuteduringrecord: false, parentid: 0}
          _TaskCollection.add(task,{at: 1})
          this.model.set("function_name",name)
          this.ClearSelection()
          this.SetDefaultInsert()
        }else
        {
          if(_.find(GetFunctionList(), function(el){ return el["name"] == name; }) && name != this.currentFuncName)
          {
            e.preventDefault();
            $("#validation").html("Function " + name + " already exists")
            $("#editfunctionmodal").modal({})
            return
          }
          this.model.set("dontsend",true)

          var task = FindTaskById(0)
          var found = false
          while(true)
          {
            if(!task)
              break
            var id = parseInt(task.get("id"))
            if(IsFunctionNode(id) && GetFunctionData(id)["name"] == this.currentFuncName)
            {
              found = true
              break
            }
            task = FindNextTask(id)
          }
          if(found)
          {
            task.set("name",name)
            task.set("code",Normalize(_.template($('#function_code').html())({name:name})))
          }
          this.model.set("function_name",name)
          //this.ClearSelectionFast()
          this.SetDefaultInsert()
          this.model.set("dontsend",false)
          BrowserAutomationStudio_SaveToUndoManager()
          BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
          this.send()
          this.render()
        }*/
        
        
        
      },

      removefunction: function(FunctionName)
      {

        /*this.currentFuncName = FunctionName*/
        var self = this
        bootbox.confirm(tr("Are you sure that you want to delete") + " " + FunctionName + " " + tr("function and all its content?"), function(result) {
          if(result)
          {
            self.model.set("dontsend",true)
            _CacheLoader.SetDontUpdate(true)
            var task = FindTaskById(0)
            var found = false
            while(true)
            {
              if(!task)
                break
              var id = parseInt(task.get("id"))
              if(IsFunctionNode(id) && GetFunctionData(id)["name"] == FunctionName)
              {
                found = true
                break
              }
              task = FindNextTask(id)
            }
            if(found)
            {
              self.currentTargetId = IndexOf(parseInt(task.get("id")))
              self.Delete()
              if(FunctionName == self.model.get("function_name"))
              {
                self.model.set("function_name","Main")
                self.ClearSelectionFast()
              }
            }
            _CacheLoader.SetDontUpdate(false)
            _CacheLoader.Start()
            self.model.set("dontsend",false)
            BrowserAutomationStudio_SaveToUndoManager()
            BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
            self.send()
            self.render()
            _FunctionManager.RenderDefault()
          }

        });
      },

      addfunction: function(e)
      {
        this.currentFuncName = ""
        $("#EditFunctionName").val("")
        $("#validation").html("")
        $("#editfunctionmodal").modal({})
      },

      editfunction: function(e)
      {
        this.currentFuncName = this.model.get("function_name")
        $("#EditFunctionName").val(this.currentFuncName)
        $("#validation").html("")
        $("#editfunctionmodal").modal({})
      },

      setfunctionname: function(Name)
      {
        _ActionFinder.ResetSearch()
        this.model.set("dontsend",true)

        this.model.set("function_name",Name)
        this.ClearSelectionFast();

        this.model.set("dontsend",false)
        this.render()
        BrowserAutomationStudio_SaveToUndoManager()
      },

      key: function(e)
      {
        if($('.modal.in').length == 0 && _ActionUpdater.$el.is(':hidden'))
        {
          if (e.keyCode == 70 && e.ctrlKey)
          {
            _ActionFinder.Show()
          }
          if (e.keyCode == 90 && e.ctrlKey)
          {
            this.Undo();
          }
          if (e.keyCode == 89 && e.ctrlKey)
          {
            this.Redo();
          }
          if (e.keyCode == 67 && e.ctrlKey && window.getSelection().toString().length == 0)
          {
            this.Copy();
          }
          if (e.keyCode == 86 && e.ctrlKey)
          {
            this.Paste();
          }
          if (e.keyCode == 88 && e.ctrlKey)
          {
            this.Cut();
          }
          if (e.keyCode == 46)
          {
            this.DeleteSelected();
          }
        }
      },

      stepnext: function()
      {
        this.model.set("isstepnextactivated", true)
        this.play()
      },

      pause: function(event)
      {
        if($("#pause").hasClass("actionbuttongray"))
        {
          event.preventDefault();
          return;
        }
        this.model.set("isexecutionaborting", true);
        this.model.set("isscriptexecuting", false);
      },

      restart: function()
      {
        BrowserAutomationStudio_Restart(false);
      },

      stop: function()
      {
        BrowserAutomationStudio_Restart(true);
      },

      play: function(event)
      {
        if ($("#play").hasClass("actionbuttongray")) {
          event.preventDefault();
          return;
        }
        this.model.set("isscriptexecuting", true);
        if (!this.model.get("istaskexecuting") && !this.model.get("isexecutionaborting")) {
          SendTask();
        }
      },

      UpdateInsertDataInterface: function()
      {
        if(typeof(window.BrowserAutomationStudio_IsInsideElementLoop) == "undefined")
          window.BrowserAutomationStudio_IsInsideElementLoop = false;
        var IsInside = IsInsideElementLoop(parseInt(_GobalModel.get("insert_parent")))
        if(IsInside != BrowserAutomationStudio_IsInsideElementLoop)
        {
          window.BrowserAutomationStudio_IsInsideElementLoop = IsInside
          BrowserAutomationStudio_IsInsideElementLoopChanged(IsInside)
        }


        $(".toolinsert").removeClass("toolselected")

        if(parseInt(_GobalModel.get("insert_index")) == 0)
        {
          $(".toolinsertdata[data-insert-id='" + GetFirstNotFunctionId() + "'] .toolinsert").addClass("toolselected")
        }else
        {
          var task_id = DataInsertIndexToTaskId(_GobalModel.get("insert_index"))
          if(task_id !== null)
          {
            $(".toolinsertdata[task-id='" + task_id + "'][data-insert-parent='" + _GobalModel.get("insert_parent") + "'] .toolinsert").addClass("toolselected")
          }
        }
        
      },

      toolinsertdata: function(e)
      {
        var index = TaskIdToDataInsertIndex(parseInt($(e.target).closest(".toolinsertdata").attr("task-id")))
        var parentid = parseInt($(e.target).closest(".toolinsertdata").attr("data-insert-parent"))
        
        this.model.attributes["insert_index"] = index
        this.model.attributes["insert_parent"] = parentid
        this.UpdateInsertDataInterface()

        
        //var params = {"insert_index" : index, "insert_parent": parentid}
        //this.model.set(params)
        /*this.model.set("insert_index",index)
        this.model.set("insert_parent",parentid)*/

        UpdateInsertPlacesTooltips();

        this.PreserveInsert();

      },

      ignoreerrorsthis: function(event)
      {
        event.preventDefault();

        if(_GobalModel.get("isscriptexecuting"))
            return;

        BrowserAutomationStudio_StopSaveToUndoManager = true

        var el = $(event.target).closest("*[data-index]")
        var Task = FindTaskById(parseInt(el.attr("task-id")))
        var Index = IndexOf(parseInt(Task.get("id")));
        
        var TaskSlave = null
        var dat = Task.dat()
        if(dat["role"] && dat["role"] == "master")
        {
          TaskSlave = FindTaskById(dat["slave"])
        }

        var Id = Task.get("id")
        
        if(NeedToShowUpperInsert(Index))
        {
          this.model.attributes["insert_index"] = -Index
        }else
        {
          var PrevTask = FindPrevTask(Id)
          if(PrevTask)
          {
            this.model.attributes["insert_index"] = parseInt(IndexOf(PrevTask.get("id")))
          }else
          {
            this.model.attributes["insert_index"] = -1
          }
          
        }
        
        this.model.attributes["insert_parent"] = parseInt(Task.get("parentid"))

        
        this.UpdateInsertDataInterface()
        UpdateInsertPlacesTooltips();

        var IdIgnoreErrors = Math.floor(Math.random() * (1000000000 - 100)) + 100
        var IdIf = Math.floor(Math.random() * (1000000000 - 100)) + 100
        var IdLog = Math.floor(Math.random() * (1000000000 - 100)) + 100

        // Add 3 new actions: ignore errors, if, log
        var PasteData = null
        
        
        if(_K == "ru")
        {
          PasteData =JSON.stringify([{"name":"","code":"/*Dat:eyJzIjoiaWdub3JlZXJyb3JzIiwidiI6MSwiZiI6W10sInV3IjoiMCIsInV0IjoiMCIsInV0byI6IjAiLCJ1bSI6IjAiLCJkIjpbXX0=*/\n          _call(function()\n          {\n          _on_fail(function(){\n          VAR_LAST_ERROR = _result()\n          VAR_ERROR_ID = ScriptWorker.GetCurrentAction()\n          VAR_WAS_ERROR = false\n          _break(1,true)\n          })\n          CYCLES.Current().RemoveLabel(\"function\")\n          section_insert()\n          },null)!","internal_label_id":"","dat_precomputed":null,"search_precomputed":null,"code_precomputed":null,"parentid":0,"id":IdIgnoreErrors,"donotexecuteduringrecord":false,"is_selected":false,"color":"","is_fold":false,"fd":""},{"name":"","code":`/*Dat:eyJzIjoiaWYiLCJ2IjoxLCJmIjpbXSwidXciOiIwIiwidXQiOiIwIiwidXRvIjoiMCIsInVtIjoiMCIsImQiOlt7ImlkIjoiSWZFeHByZXNzaW9uIiwidHlwZSI6ImNvbnN0ciIsImRhdGEiOiJbW1dBU19FUlJPUl1dIiwiY2xhc3MiOiJleHByZXNzaW9uIn0seyJpZCI6IklmRWxzZSIsInR5cGUiOiJjaGVjayIsImRhdGEiOmZhbHNlfV19*/\n                _set_if_expression("${utf8_to_b64('[[WAS_ERROR]]')}");\n                _if(VAR_WAS_ERROR,function(){\nsection_insert()\n                })!`,"internal_label_id":"","dat_precomputed":null,"search_precomputed":null,"code_precomputed":null,"parentid":0,"id":IdIf,"donotexecuteduringrecord":false,"is_selected":false,"color":"5","is_fold":false,"fd":""},{"name":"","code":"/*Dat:eyJzIjoibG9nIiwidiI6MSwiZiI6W10sInV3IjoiMCIsInV0IjoiMCIsInV0byI6IjAiLCJ1bSI6IjAiLCJkIjpbeyJpZCI6IkxvZ1RleHQiLCJ0eXBlIjoiY29uc3RyIiwiZGF0YSI6ItCf0YDQvtC40LfQvtGI0LvQsCDQvtGI0LjQsdC60LAgOiBbW0xBU1RfRVJST1JdXSIsImNsYXNzIjoic3RyaW5nIn1dfQ==*/\n      log(\"Произошла ошибка : \" + VAR_LAST_ERROR)","internal_label_id":"","dat_precomputed":null,"search_precomputed":null,"code_precomputed":null,"parentid":IdIf,"id":IdLog,"donotexecuteduringrecord":false,"is_selected":false,"color":"5","is_fold":false,"fd":""}])
        } 
        else
        {
          PasteData =JSON.stringify([{"name":"","code":"/*Dat:eyJzIjoiaWdub3JlZXJyb3JzIiwidiI6MSwiZiI6W10sInV3IjoiMCIsInV0IjoiMCIsInV0byI6IjAiLCJ1bSI6IjAiLCJkIjpbXX0=*/\n          _call(function()\n          {\n          _on_fail(function(){\n          VAR_LAST_ERROR = _result()\n          VAR_ERROR_ID = ScriptWorker.GetCurrentAction()\n          VAR_WAS_ERROR = false\n          _break(1,true)\n          })\n          CYCLES.Current().RemoveLabel(\"function\")\n          section_insert()\n          },null)!","internal_label_id":"","dat_precomputed":null,"search_precomputed":null,"code_precomputed":null,"parentid":0,"id":IdIgnoreErrors,"donotexecuteduringrecord":false,"is_selected":false,"color":"","is_fold":false,"fd":""},{"name":"","code":`/*Dat:eyJzIjoiaWYiLCJ2IjoxLCJmIjpbXSwidXciOiIwIiwidXQiOiIwIiwidXRvIjoiMCIsInVtIjoiMCIsImQiOlt7ImlkIjoiSWZFeHByZXNzaW9uIiwidHlwZSI6ImNvbnN0ciIsImRhdGEiOiJbW1dBU19FUlJPUl1dIiwiY2xhc3MiOiJleHByZXNzaW9uIn0seyJpZCI6IklmRWxzZSIsInR5cGUiOiJjaGVjayIsImRhdGEiOmZhbHNlfV19*/\n                _set_if_expression("${utf8_to_b64('[[WAS_ERROR]]')}");\n                _if(VAR_WAS_ERROR,function(){\nsection_insert()\n                })!`,"internal_label_id":"","dat_precomputed":null,"search_precomputed":null,"code_precomputed":null,"parentid":0,"id":IdIf,"donotexecuteduringrecord":false,"is_selected":false,"color":"5","is_fold":false,"fd":""},{"name":"","code":"/*Dat:eyJzIjoibG9nIiwidiI6MSwiZiI6W10sInV3IjoiMCIsInV0IjoiMCIsInV0byI6IjAiLCJ1bSI6IjAiLCJkIjpbeyJpZCI6IkxvZ1RleHQiLCJ0eXBlIjoiY29uc3RyIiwiZGF0YSI6IkVycm9yIG9jY3VycmVkIDogW1tMQVNUX0VSUk9SXV0iLCJjbGFzcyI6InN0cmluZyJ9XX0=*/\n      log(\"Error occurred : \" + VAR_LAST_ERROR)","internal_label_id":"","dat_precomputed":null,"search_precomputed":null,"code_precomputed":null,"parentid":IdIf,"id":IdLog,"donotexecuteduringrecord":false,"is_selected":false,"color":"5","is_fold":false,"fd":""}])
        }


        var InsertedActions = this.PasteFinal(PasteData, true)

        this.model.attributes["insert_index"] = IndexOf(IdIgnoreErrors)
        this.model.attributes["insert_parent"] = IdIgnoreErrors

        this.UpdateInsertDataInterface()
        UpdateInsertPlacesTooltips();

        var TaskIds = [parseInt(Id)]
        if(TaskSlave)
          TaskIds.push(parseInt(TaskSlave.get("id")))

        var Data = this.CopyToString(TaskIds)
        var NewId = this.PasteFinal(Data, true)[0]



        if(TaskSlave)
        {
          this.currentTargetId = IndexOf(parseInt(TaskSlave.get("id")))
          this.Delete(true)

        }

        this.currentTargetId = IndexOf(parseInt(Id))
        this.Delete(true)

        BrowserAutomationStudio_StopSaveToUndoManager = false
        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()

        //BrowserAutomationStudio_FocusAction(NewId,true)
        BrowserAutomationStudio_FocusAction(IdIgnoreErrors,true)
        BrowserAutomationStudio_FocusAction(IdIf,true)
        BrowserAutomationStudio_FocusAction(IdLog,true)


      },

      taskedit: function()
      {
        BrowserAutomationStudio_EditSaveStart()
        //BrowserAutomationStudio_EditSaveEnd()
      },

      taskcancel: function()
      {
        if(this.isEdit)
        {
          this.isEdit = false
          BrowserAutomationStudio_EditEnd()
        }
      },

      taskeditcustom: function(name,code,dontexecute)
      {
        this.model.set("dontsend",true)
        _CacheLoader.SetDontUpdate(true)
        
        var Task = this.collection.at(this.currentTargetId)
        Task.set("name",$("#TaskName").val())
        var color = $(".color-select-active").attr("color-id")

        //this.collection.at(this.currentTargetId).set("code",$("#TaskData").val() + "\n" + $("#TaskCode").val())
        var dat = Task.dat()

        if(dat["role"])
        {
          var task = null
          if(dat["role"] == "master") 
          {
            task = FindTaskById(dat["slave"])
          }else if(dat["role"] == "slave") 
          {
            task = FindTaskById(dat["master"])
          }
          if(task)
          {
            task.set("donotexecuteduringrecord",true == $("#TaskDontRunWhenRecording").prop('checked'))   

            task.attributes["color"] = color
            task.attributes["code_precomputed"] = null

            var el = $(".tool[task-id='" + task.get("id") + "']").removeClass("action-color-1").removeClass("action-color-2").removeClass("action-color-3").removeClass("action-color-4").removeClass("action-color-5")
            if(color.length > 0)
            {
              el.addClass("action-color-" + color)
            }
          }
        }
        Task.set("donotexecuteduringrecord",true == $("#TaskDontRunWhenRecording").prop('checked'))

        Task.attributes["color"] = color
        Task.attributes["code_precomputed"] = null
        var el = $(".tool[task-id='" + Task.get("id") + "']").removeClass("action-color-1").removeClass("action-color-2").removeClass("action-color-3").removeClass("action-color-4").removeClass("action-color-5")
        if(color.length > 0)
        {
          el.addClass("action-color-" + color)
        }


        //this.collection.at(this.currentTargetId).set("name",name)
        var task = this.collection.at(this.currentTargetId)
        //var id = parseInt(this.collection.at(this.currentTargetId).get("id"))
        UpdateIfMasterSlave(task, code)
        task.set("code",code)
        //this.collection.at(this.currentTargetId).set("donotexecuteduringrecord",dontexecute)

        _CacheLoader.SetDontUpdate(false)
        _CacheLoader.Start()
        
        this.model.set("dontsend",false)
        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
        this.render()
        this.send()

        $('#editmodal').data('accept', true).modal('hide');

        this.isEdit = false
      },

      mousedowntool: function(e){
        if($(e.target).hasClass("movetofunction"))
        {
          return
        }

        if(!!$('.executing').filter(function() { return $(this).is(":hover"); }).length)
        {
          return
        }
        if(!!$('.ignoreerrorsthis').filter(function() { return $(this).is(":hover"); }).length)
        {
          return
        }
        if(!!$('.folding-folded').filter(function() { return $(this).is(":hover"); }).length)
        {
          return
        }
        if(!!$('.folding-unfolded').filter(function() { return $(this).is(":hover"); }).length)
        {
          return
        }
        if($(e.target).closest("*[data-index]").attr("data-index") == 0)
        {
          $("#editmodal input,#editmodal textarea").attr("readonly","readonly")
        }else
        {
          $("#editmodal input,#editmodal textarea").removeAttr("readonly")
        }
        if($(e.target).closest("*[data-index]").attr("data-index") != 0)
        {
          if( e.button == 2 ) {
            this.currentTargetId = IndexOf(parseInt($(e.target).closest("*[data-index]").attr("task-id")))
          }else if(e.button == 0)
          {
            this.currentTargetId = IndexOf(parseInt($(e.target).closest("*[data-index]").attr("task-id")))
            this.ToggleSelection()

            var now = Date.now()
            if(now - BrowserAutomationStudio_DoubleClickTime < 500 && BrowserAutomationStudio_DoubleClickId == this.currentTargetId)
            {
                this.Edit()
            }
            BrowserAutomationStudio_DoubleClickId = this.currentTargetId
            BrowserAutomationStudio_DoubleClickTime = Date.now()

          }
        }
      },

      Undo: function()
      {
        BrowserAutomationStudio_RestoreFromUndoManager(_UndoManager.Undo())
      },

      Redo: function()
      {
        BrowserAutomationStudio_RestoreFromUndoManager(_UndoManager.Redo())
      },

      CopyToString: function(Ids)
      {
        var _CopyBuffer = new TaskCollection([]);
        var id_map = {}
        var ids = []
        var IdsDoNotSetParentToZero = []

        _.each(BrowserAutomationStudio_GetCurrentVisibleTasks(), function(task){
          var is_selected;
          
          if(Ids)
          {
            is_selected = Ids.indexOf(parseInt(task.get("id"))) >= 0
          }else
          {
            is_selected = task.get("is_selected")
          }

          if(is_selected)
          {
            ids.push(parseInt(task.get("id")))
          }
        })

        _.each(BrowserAutomationStudio_GetCurrentVisibleTasks(), function(task){
          var currentid = parseInt(task.get("id"))

          var checkids = ids.slice();
          var index = checkids.indexOf(currentid);
          if (index > -1)
            checkids.splice(index, 1);

          var is_selected;
          if(Ids)
          {
            is_selected = Ids.indexOf(parseInt(task.get("id"))) >= 0
          }else
          {
            is_selected = task.get("is_selected")
          }

          var IsAnsectorOfOtherSelected = this.IsAnsectorOfAny(checkids,currentid) && is_selected
          
          if(is_selected || this.IsAnsectorOfAny(ids,currentid))
          {
            var id;
            if(parseInt(task.get("id")) in id_map)
            {
              id = id_map[parseInt(task.get("id"))]
            }else
            {
              id = Math.floor(Math.random() * (1000000000 - 100)) + 100
              if(Ids && Ids.indexOf(parseInt(task.get("id"))) >= 0)
                Ids.push(id)
              id_map[parseInt(task.get("id"))] = id
            }
            var new_task = new TaskModel(task.toJSON())
            new_task.set("id", id)
            
            if(IsAnsectorOfOtherSelected)
              IdsDoNotSetParentToZero.push(id)
            
            _CopyBuffer.add(new_task)
          }
        })

        _.each(_CopyBuffer.models, function(task){

          var code = task.get("code")
          try
          {
            var match = code.match("Dat:([^\*]+)")
            if(match)
            {
              var dat = JSON.parse(b64_to_utf8(match[1]))

              /* Replace master and slave */

              if(dat["role"])
              {
                dat["master"] = id_map[parseInt(dat["master"])]
                dat["slave"] = id_map[parseInt(dat["slave"])]
                
                code = code.replace(new RegExp("Dat:([^\*]+)"), "Dat:" + utf8_to_b64(JSON.stringify(dat)))
                task.set("code",code)
              }
            }

          }catch(e){}


          var currentid = parseInt(task.get("id"))

          var is_selected = "NNNN";
          
          if(Ids)
          {
            is_selected = Ids.indexOf(parseInt(task.get("id"))) >= 0
          }else
          {
            is_selected = task.get("is_selected")
          }

          /*console.log("is_selected")
          console.log(task.get("id"))
          console.log(is_selected)*/


          if(is_selected && IdsDoNotSetParentToZero.indexOf(currentid)<0)
          {
            task.set("parentid", 0)
          }
          if(task.get("parentid") in id_map)
          {
            task.set("parentid", id_map[task.get("parentid")])
          }
          task.attributes["is_selected"] = false
          task.attributes["code_precomputed"] = null
        })

        return JSON.stringify(_CopyBuffer.toJSON())
      },

      GetSelectedTasks: function()
      {
        var ids = []
        var res = []
        
        _.each(this.collection.models, function(task){
          if(task.get("is_selected"))
          {
            ids.push(parseInt(task.get("id")))
            res.push(task)
          }
        })

        /*_.each(this.collection.models, function(task){
          var currentid = parseInt(task.get("id"))

          var checkids = ids.slice();
          var index = checkids.indexOf(currentid);
          if (index > -1)
            checkids.splice(index, 1);

          var is_selected = task.get("is_selected")
          
          if(this.IsAnsectorOfAny(checkids,currentid) && res.indexOf(currentid) < 0)
          {
            res.push(task)
          }
          
        })*/

        return res
      },

      EnableSelected: function()
      {
        var tasks = this.GetSelectedTasks()

        if(tasks.length == 0)
          return;


        this.model.set("dontsend",true)


        tasks.forEach(function(task){
            task.attributes["donotexecuteduringrecord"] = false
            task.attributes["code_precomputed"] = null
            $(".taskcontainer[task-id='" + task.get("id") + "']").removeClass("notactive")
            $(".disablenotice[task-id='" + task.get("id") + "']").hide()
            
        })
        
        this.model.set("dontsend",false)
        BrowserAutomationStudio_SaveToUndoManager()
        this.send()
        this.render()

        this.ClearSelection()
      },

      DisableSelected: function()
      {
        var tasks = this.GetSelectedTasks()

        if(tasks.length == 0)
          return;

        this.model.set("dontsend",true)


        tasks.forEach(function(task){
            task.attributes["donotexecuteduringrecord"] = true
            task.attributes["code_precomputed"] = null
            $(".taskcontainer[task-id='" + task.get("id") + "']").addClass("notactive")
            $(".disablenotice[task-id='" + task.get("id") + "']").show()
        })
        
        this.model.set("dontsend",false)
        BrowserAutomationStudio_SaveToUndoManager()
        this.send()
        this.render()

        this.ClearSelection()

      },

      SetSelectedColor: function(color)
      {
        var tasks = this.GetSelectedTasks()

        if(tasks.length == 0)
          return;

        this.model.set("dontsend",true)


        tasks.forEach(function(task){
            task.attributes["color"] = color
            task.attributes["code_precomputed"] = null
            var el = $(".tool[task-id='" + task.get("id") + "']").removeClass("action-color-1").removeClass("action-color-2").removeClass("action-color-3").removeClass("action-color-4").removeClass("action-color-5")
            if(color.length > 0)
            {
              el.addClass("action-color-" + color)
            }
            
        })
        
        this.model.set("dontsend",false)
        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
        this.send()
        this.render()

        this.ClearSelection()

      },

      Copy: function()
      {
        BrowserAutomationStudio_SetClipboard(this.CopyToString())
      },

      Paste: function()
      {
          BrowserAutomationStudio_GetClipboard();
      },

      PasteFinal: function(data, dontsetbuffer)
      {

        try
        {
          var j = JSON.parse(data)
        }catch(e)
        {
          return []
        }

        if(typeof(j) != "object")
          return []


        var _CopyBuffer = new TaskCollection(j);

        this.model.set("dontsend",true)
        _CacheLoader.SetDontUpdate(true)

        var id_map = {}
        var newbuffer = []

        _.each(_CopyBuffer.models, function(task){
          var id;
          if(parseInt(task.get("id")) in id_map)
          {
            id = id_map[parseInt(task.get("id"))]
          }else
          {
            id = Math.floor(Math.random() * (1000000000 - 100)) + 100
            id_map[parseInt(task.get("id"))] = id
          }
          var new_task = new TaskModel(task.toJSON())
          new_task.set("id", id)
          newbuffer.push(new_task)
        })

        /* replace master and slave */
        var newbuffer2 = []

        _.each(newbuffer, function(task){
          var code = task.get("code")
          try
          {
            var match = code.match("Dat:([^\*]+)")
            if(match)
            {

              var dat = JSON.parse(b64_to_utf8(match[1]))

              if(dat["role"])
              {
                dat["master"] = id_map[parseInt(dat["master"])]
                dat["slave"] = id_map[parseInt(dat["slave"])]

                code = code.replace(new RegExp("Dat:([^\*]+)"), "Dat:" + utf8_to_b64(JSON.stringify(dat)))
                task.set("code",code)
              }

             
              
            }
          }catch(e){}

          
          var new_task = new TaskModel(task.toJSON())
          newbuffer2.push(new_task)
        })

        newbuffer = newbuffer2

        var insert_parent = _GobalModel.get("insert_parent")
        var insert_index = _GobalModel.get("insert_index")
        var insert_index_first = null;
        var insert_task_list = []
        var if_var_list = {}


        _.each(_CopyBuffer.models, function(task){

          if(insert_index == 0)
          {
            insert_index = GetFirstNotFunctionId()
            if(insert_index == 0)
              insert_index = _TaskCollection.models.length - 1
            else
              insert_index = -IndexOf(GetFirstNotFunctionId())
          }
          insert_index = ((insert_index<0) ? - insert_index : insert_index + 1)

          if(parseInt(task.get("parentid")) == 0)
          {
            task.set("parentid", insert_parent)
          }
          if(!insert_index_first)
            insert_index_first = insert_index

          /* replace FOREACH_ARRAY_ and IF_ELSE_EXPRESSION_ */
          var code = task.get("code")
          try
          {
            var match = code.match("Dat:([^\*]+)")
            if(match)
            {

              var dat = JSON.parse(b64_to_utf8(match[1]))

              if(code.indexOf("FOREACH_ARRAY_") >= 0)
              {
                var r = Math.floor(Math.random() * (999999 - 100000) + 100000)  
                code = code.replace(new RegExp("FOREACH_ARRAY_\\d+","g"),"_cycle_param(\"foreach_data\")")
                task.set("code",code)
              }


              if(code.indexOf("IF_ELSE_EXPRESSION_") >= 0)
              {
                var if_var = code.match(new RegExp("IF_ELSE_EXPRESSION_\\d+"))[0]

                var r;
                if(if_var_list[if_var])
                {
                  r = if_var_list[if_var]
                }else
                {
                  r = "_cycle_params().if_else"    
                  if_var_list[if_var] = r
                }
                
                code = code.replace(new RegExp("IF_ELSE_EXPRESSION_\\d+","g"),r)

                dat["if_var"] = r
                code = code.replace(new RegExp("Dat:([^\*]+)"), "Dat:" + utf8_to_b64(JSON.stringify(dat)))
                
                task.set("code",code)
              }
              
            }
          }catch(e){}

          

          insert_task_list.push(task)
          //_TaskCollection.add(task,{at: insert_index})

          //console.log(insert_index)
        })
        if(insert_index_first)
          _TaskCollection.add(insert_task_list,{at: insert_index_first})

        //_GobalModel.set("insert_index", insert_index)
        this.model.attributes["insert_index"] = insert_index
        this.UpdateInsertDataInterface()

        //console.log(insert_index)


        _CopyBuffer.reset()
        _CopyBuffer.add(newbuffer)

        _.each(_CopyBuffer.models, function(task){
          if(task.get("parentid") in id_map)
          {
            task.set("parentid", id_map[task.get("parentid")])
          }
          task.attributes["is_selected"] = false
          task.attributes["code_precomputed"] = null
        })

        _CacheLoader.SetDontUpdate(false)
        _CacheLoader.Start()
        
        this.model.set("dontsend",false)
        //this.SetDefaultInsert()
        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
        this.send()
        this.render()

        this.ClearSelection();

        if(dontsetbuffer)
        {

        }else
        {
          BrowserAutomationStudio_SetClipboard(JSON.stringify(_CopyBuffer.toJSON()))
        }

        return Object.keys(id_map).map(function(key) {
            return parseInt(key);
        });

      },

      Cut: function()
      {
        this.model.set("dontsend",true)

        _CacheLoader.SetDontUpdate(true)

        this.Copy()

        var stillexists = true

        while(stillexists)
        {
          stillexists = false
          var self = this
          var offest = BrowserAutomationStudio_GetCurrentVisibleOffset()
          _.every(BrowserAutomationStudio_GetCurrentVisibleTasks(), function(task,index){
            if(task.get("is_selected"))
            {
              stillexists = true
              self.currentTargetId = index + offest
              self.Delete()
              return false
            }
            return true
          })
        }

        _CacheLoader.SetDontUpdate(false)
        _CacheLoader.Start()

        this.model.set("dontsend",false)
        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
        this.send()
        this.render()
      },

      DeleteSelected: function()
      {
        this.model.set("dontsend",true)

        _CacheLoader.SetDontUpdate(true)
        var stillexists = true

        while(stillexists)
        {
          stillexists = false
          var self = this
          var offest = BrowserAutomationStudio_GetCurrentVisibleOffset()
          _.every(BrowserAutomationStudio_GetCurrentVisibleTasks(), function(task,index){
            if(task.get("is_selected"))
            {
              stillexists = true
              self.currentTargetId = index + offest
              self.Delete()
              return false
            }
            return true
          })
        }

        _CacheLoader.SetDontUpdate(false)
        _CacheLoader.Start()


        this.model.set("dontsend",false)
        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
        this.send()
        this.render()
      },

      ClearSelection: function()
      {


         this.model.set("dontsend",true)
         _.every(this.collection.models, function(task,index){
            if(task.attributes["is_selected"] != false)
             task.attributes["code_precomputed"] = null

            task.attributes["is_selected"] = false
            return true
          })
         $(".taskcontainer .selected").css("visibility","hidden")
         this.RecalculateMargins($(".tool-margin"),"clear")
         this.model.set("dontsend",false)
         
         BrowserAutomationStudio_SaveToUndoManager()
         BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()

         this.renderselectiontemplatecontainer()
         //this.render()
      },

      UnfoldAll: function()
      {
         _.every(this.collection.models, function(task,index){
            if(task.attributes["is_fold"] != false)
             task.attributes["code_precomputed"] = null  
            task.attributes["is_fold"] = false
            return true
          })
         
         this.RecalculateFolding($(".tool-margin"))
         $(".folding-folded").hide()
         $(".folding-unfolded").show()
         
         BrowserAutomationStudio_SaveToUndoManager()
         this.send()
      },

      FoldAll: function()
      {
         _.every(this.collection.models, function(task,index){
            if(task.get("name") != "Else")
            {
              if(task.attributes["is_fold"] != true)
                task.attributes["code_precomputed"] = null 
              task.attributes["is_fold"] = true
            }
            return true
          })
         
         this.RecalculateFolding($(".tool-margin"))
         $(".folding-folded").show()
         $(".folding-unfolded").hide()
         
         BrowserAutomationStudio_SaveToUndoManager()
         this.send()
      },

      GetSelection: function()
      {
         var res = []
         
         _.every(this.collection.models, function(task,index){
            if(task.get("is_selected"))
            {
              res.push(parseInt(task.get("id")))
            }
            return true
          })
         
         return res;
      },

      ClearSelectionFast: function()
      {
         _.every(this.collection.models, function(task,index){
            if(task.attributes["is_selected"] != false)
             task.attributes["code_precomputed"] = null              
            task.attributes["is_selected"] = false
            return true
          })
         $(".taskcontainer .selected").css("visibility","hidden")
         this.RecalculateMargins($(".tool-margin"),"clear")
      },

      Delete: function(is_single){
        if(typeof(is_single) == "undefined")
          is_single = false

        var currentTargetId = parseInt(this.currentTargetId)
        if(this.currentTargetId > 0)
        {
          if(is_single)
          {
            this.model.set("dontsend",true)
          }

          var self = this
          var task = this.collection.at(currentTargetId);
          var taskstoremove = []

          if(task)
          {
            taskstoremove.push(task)
            var len = _TaskCollection.models.length;
            var Id = Number(task.get('id'))
            for(var i = currentTargetId + 1;i<len;i++)
            {
              var taskinner = this.collection.at(i);
              var IdAnsector = Number(taskinner.get('id'))
              if(IsAnsectorOf(Id, IdAnsector))
              {
                taskstoremove.push(taskinner)
              }else
              {
                break;
              }
            }

            /*_.find(_TaskCollection.models, function(taskinner){
              var IdAnsector = Number(taskinner.get('id'))
              var Id = Number(task.get('id'))
              if(IdAnsector != Id && IsAnsectorOf(Id, IdAnsector))
              {
                taskstoremove.push(taskinner)
              }
            });*/
          }
          var deleted_current_execute = false
          var deleted_current_insert = false
          var taskcurrentexecute = parseInt(this.model.get("execute_next_id"))
          var taskcurrentinsert = parseInt(_GobalModel.get("insert_index"))
          if(taskcurrentinsert<0)
            taskcurrentinsert = -taskcurrentinsert

          if(taskcurrentinsert < _TaskCollection.length && taskcurrentinsert >= 0)
            taskcurrentinsert = parseInt(_TaskCollection.models[taskcurrentinsert].get("id"))
          else
            taskcurrentinsert = 0

          for(var i = 0;i<taskstoremove.length;i++)
          {
            var task = taskstoremove[i]
            if(parseInt(task.get("id")) === taskcurrentexecute)
              deleted_current_execute = true

            if(parseInt(task.get("id")) === taskcurrentinsert)
              deleted_current_insert = true

          }

          this.collection.remove(taskstoremove);

          if(deleted_current_insert)
          {
            this.model.attributes["insert_index"] = _TaskCollection.length
            this.model.attributes["insert_parent"] = 0
            this.UpdateInsertDataInterface()
          }

          if(deleted_current_execute)
          {
            this.model.set("execute_next_id",1)
          }
          if(is_single)
          {
            this.model.set("dontsend",false)
            BrowserAutomationStudio_SaveToUndoManager()
            BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
            this.send()
            this.render()
          }
        }

      },

      PreserveInsert: function()
      {
        this.idInsertBefore = -1
        this.idInsertAfter = -1
        this.idInsertParent = -1
        try
        {
          this.idInsertParent = parseInt(this.model.attributes["insert_parent"])
        }catch(e)
        {

        }

        var Index = this.model.attributes["insert_index"]
        if(Index >= 0)
        {
          try
          {
            var Task = _TaskCollection.models[Index]
            if(parseInt(Task.get("parentid")) == this.idInsertParent)
              this.idInsertBefore = parseInt(Task.get("id"))
          }catch(e)
          {

          }

          try
          {
            this.idInsertAfter = parseInt(FindDirectNextSibling(this.idInsertBefore).get("id"))
          }catch(e)
          {

          }
        }else
        {
          try
          {
            var Task = _TaskCollection.models[-Index]
              if(parseInt(Task.get("parentid")) == this.idInsertParent)
            this.idInsertAfter = parseInt(Task.get("id"))
          }catch(e)
          {

          }

          try
          {
            this.idInsertBefore = parseInt(FindDirectPrevSibling(this.idInsertAfter).get("id"))
          }catch(e)
          {

          }
        }
      },

      RestoreInsert: function(){
        var FunctionName = this.model.get("function_name")
        if(this.idInsertBefore >= 0)
        {
          try
          {
            var Task = FindTaskById(this.idInsertBefore)
            if(Task && GetFunctionData(this.idInsertBefore)["name"] == FunctionName)
            {
              this.model.attributes["insert_index"] = IndexOf(this.idInsertBefore)
              this.model.attributes["insert_parent"] = parseInt(Task.get("parentid"))


              this.UpdateInsertDataInterface()
              this.PreserveInsert()
              return true
            }
          }catch(e)
          {

          }
        }

        if(this.idInsertAfter >= 0)
        {
          try
          {
            if(GetFunctionData(this.idInsertAfter)["name"] == FunctionName)
            {
              var Prev = FindDirectPrevSibling(this.idInsertAfter)
              if(Prev)
              {
                this.model.attributes["insert_index"] = IndexOf(parseInt(Prev.get("id")))
                this.model.attributes["insert_parent"] = parseInt(Prev.get("parentid"))


              }else
              {
                var Task = FindTaskById(this.idInsertAfter)
                if(Task)
                {
                  this.model.attributes["insert_index"] = -IndexOf(this.idInsertAfter)
                  this.model.attributes["insert_parent"] = parseInt(Task.get("parentid"))
                }else
                  return false
              }
              this.UpdateInsertDataInterface()
              this.PreserveInsert()
              return true
            }
          }catch(e)
          {

          }
        }

        if(this.idInsertParent >= 0)
        {
          try
          {
            if(GetFunctionData(this.idInsertParent)["name"] == FunctionName)
            {
              var task = FindTaskById(0)
              var lastTask = null
              var id = null

              while(true)
              {
                if(!task)
                  break

                var id = parseInt(task.get("id"))

                if(this.idInsertParent != id && IsAnsectorOf(this.idInsertParent, id))
                {
                  lastTask = task
                }else if(lastTask)
                  break;

                task = FindNextTask(id)
              }
              if(lastTask)
              {
                this.model.attributes["insert_index"] = IndexOf(parseInt(lastTask.get("id")))
              }else
              {
                this.model.attributes["insert_index"] = IndexOf(this.idInsertParent)
              }
              this.model.attributes["insert_parent"] = this.idInsertParent
              this.UpdateInsertDataInterface()
              this.PreserveInsert()
              return true
            }
          }catch(e)
          {

          }
        }

        return false

      },

      SetDefaultInsert: function(){

        if(this.RestoreInsert())
        {
          return
        }else
        {
          this.idInsertBefore = -1
          this.idInsertAfter = -1
          this.idInsertParent = -1
        }
        var name = this.model.get("function_name")
        if(name == "Main")
        {
          if(GetFirstNotFunctionId() != 0)
          {
            this.model.attributes["insert_index"] = _TaskCollection.length - 1
            this.model.attributes["insert_parent"] = 0
          }else
          {
            this.model.attributes["insert_index"] = 0
            this.model.attributes["insert_parent"] = 0
          }
          this.UpdateInsertDataInterface()

        }else
        {
          var task = FindTaskById(0)
          var id = null
          var was_in_function = false
          var insert_index = 0
          var insert_parent = 0

          while(true)
          {
            if(!task)
              break

            var id = parseInt(task.get("id"))

            if(GetFunctionDataOfThisNode(id)["name"] == name)
            {
              was_in_function = true
              var index = IndexOf(id)
              if(IsEmptyAndGroup(IndexOf(id)))
              {
                insert_index = index
              }else
              {
                insert_index = -IndexOf(id) - 1
              }
              insert_parent = id
            }else if(GetFunctionData(id)["name"] == name)
            {
              was_in_function = true
              var index = IndexOf(id)
              insert_index = index
            }else if(was_in_function)
            {
              break
            }

            task = FindNextTask(id)
          }

          this.model.attributes["insert_index"] = insert_index
          this.model.attributes["insert_parent"] = insert_parent

          this.UpdateInsertDataInterface()

        }
      },

      ToggleSelection: function(){
          var currentTargetId = this.currentTargetId
          if(currentTargetId >= this.collection.models.length || currentTargetId < 0)
            return
          
          this.model.set("dontsend",true)

          var task = this.collection.models[currentTargetId]

          if(task)
          {
            var dat = task.dat()

            var is_selected;
            var el = $(".taskcontainer[task-id=" + task.get("id") + "] .selected")
            var el_connected = null
            var id_connected = null
            if(dat && dat["role"])
            {
              if(dat["role"] == "master")
              {
                id_connected = parseInt(dat["slave"])
                
              }else if(dat["role"] == "slave")
              {
                id_connected = parseInt(dat["master"])
              }

            }

            if(id_connected)
            {
              el_connected = $(".taskcontainer[task-id=" +  id_connected  + "] .selected")
            }


            if(task.get("is_selected"))
            {
              el.css("visibility","hidden")
              if(el_connected)
                el_connected.css("visibility","hidden")
              is_selected = false
            }
            else
            {
              el.css("visibility","visible")
              if(el_connected)
                el_connected.css("visibility","visible")
              is_selected = true
            }

            task.attributes["is_selected"] = is_selected
            task.attributes["code_precomputed"] = null
            if(id_connected)
            {
              var task_connected = FindTaskById(id_connected)
              if(task_connected)
                task_connected.attributes["is_selected"] = is_selected
                task_connected.attributes["code_precomputed"] = null

            }

            this.RecalculateMargins($(".tool-margin"),"compute")
          }

          this.model.set("dontsend",false)
          BrowserAutomationStudio_SaveToUndoManager()
          this.renderselectiontemplatecontainer()


          //this.render()
      },


      DeleteThisAndAllUpper: function(){

        if(this.currentTargetId == 0)
          return

        var task = this.collection.models[this.currentTargetId]
        if(!task)
          return

        this.model.set("dontsend",true)

        _CacheLoader.SetDontUpdate(true)

        var func_original = GetFunctionData(parseInt(task.get("id")))["name"]

        while(parseInt(this.currentTargetId)>0)
        {
          task = this.collection.models[this.currentTargetId]
          var id = parseInt(task.get("id"))
          var func = GetFunctionData(id)["name"]
          if(func == func_original && !IsFunctionNode(id))
            this.Delete()
          this.currentTargetId = this.currentTargetId - 1
        }

        _CacheLoader.SetDontUpdate(false)
        _CacheLoader.Start()

        this.model.set("dontsend",false)
        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
        this.send()
        this.render()
      },

      DeleteThisAndAllLower: function(){

        if(this.currentTargetId == 0)
          return
        
        var task = this.collection.models[this.currentTargetId]
        if(!task)
          return

        this.model.set("dontsend",true)


        _CacheLoader.SetDontUpdate(true)


        var parent_id = task.get("parentid")
        while(parseInt(this.currentTargetId)<this.collection.length)
        {
          task = this.collection.models[this.currentTargetId]
          if(task.get("parentid") != parent_id)
            break
          this.Delete()
        }

        _CacheLoader.SetDontUpdate(false)
        _CacheLoader.Start()

        this.model.set("dontsend",false)
        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
        this.send()
        this.render()
      },


      RunUntilThis: function()
      {
          var task = this.collection.at(this.currentTargetId);
          if(task)
          {
            this.model.set("current_run_until_target_id", task.get("id"));
            this.play()
          }
      },

      MoveExecutionPointHere: function()
      {
          if (_GobalModel.get("isscriptexecuting") || _GobalModel.get("istaskexecuting")) return;

          var task = this.collection.at(this.currentTargetId);
          if(task)
          {
            var execute_point_code = GenerateCodeForMovingExecutionPoint(this.model.get("execute_next_id"), task.get("id"))

            _WebInterfaceTasks.MovedExecutionPoint(this.model.get("execute_next_id"), task.get("id"))
            var second_line = "debug_callstack()!\nsection_start(\"test\", " + task.get("id") + ")!"
            var code = execute_point_code + "\n" + second_line
            BrowserAutomationStudio_Execute(code, false)

          }
      },

      ExecuteOnlyThis: function()
      {
          if(_GobalModel.get("isscriptexecuting"))
            return;

          var task = this.collection.at(this.currentTargetId);
          if(task)
          {
            if(!AllowToExecuteOnce(Number(task.get("id"))))
              return;

            var execute_next_id = Number(_GobalModel.get("execute_next_id"))
            if(execute_next_id == 0)
              execute_next_id = -2
            _GobalModel.set("run_only_one_enabled", true);
            _GobalModel.set("isscriptexecuting",true)

            var second_line = "section_start(\"test\", " + execute_next_id + ")!"
            var code = "_sa(" + parseInt(task.get("id")) + ");" + task.get("code") + "\n" + second_line


            if(code.indexOf("_goto(")>=0)
            {
              var is_long = code.indexOf("_long_goto(")>=0
              code = code.split("_goto(")[1]
              code = code.split(")!")[0]
              var depth = -1
              var additional = []
              if(is_long)
              {
                depth = parseInt(code.split(",")[1])
                additional = JSON.parse(code.split(",").slice(2).join(","))
              }

              AdditionalStackItems = ""

              for(var i = additional.length - 1;i>=0;i--)
              {
                var a = additional[i]

                if(a)
                {
                  a = FindTaskIdByInternalLabelId(a.replace("_internal_",""))
                  if(a)
                  {
                    AdditionalStackItems+="CYCLES.Push(new Cycle(function(){_break();},function(){section_start(\"\"," + a + ",function(){})}));"
                  }
                }else
                {
                  AdditionalStackItems+="CYCLES.Push(new Cycle(function(){_break();},function(){}));"
                }
              }

              var label = JSON.parse(code.split(",")[0])
              second_line = "section_start(\"test\", " + FindTaskIdByLabel(label) + ")!"

              if(depth >= 0)
                code = "for(var i = 0;i<" + depth + ";i++)CYCLES.Pop();" + "\n" + AdditionalStackItems + "\n" + second_line
              else
                code = "_kill_call_stack();" + "\n" + second_line

            }else if(code.indexOf("_set_goto_label(")>=0)
            {
              code = second_line
            }
            BrowserAutomationStudio_DetectorBrowserData(task)
            BrowserAutomationStudio_Execute(code, false)
          }
      },


      Edit: function(options = {}){

        var dat = this.collection.at(this.currentTargetId).dat()

        if(dat && dat["role"] && dat["role"] == "slave")
        {
          return;
        }

        this.isEdit = VariablesUpdateSkip = true

        var task = this.collection.at(this.currentTargetId)

        var code = task.get("code")
        $("#TaskName").val(prepare_edit_body(dat, task.get("name")))
        $("#TaskId").html(task.get("id"))
        $(".color-select").removeClass("color-select-active")
        $(".color-select[color-id='" + task.get("color") + "']").addClass("color-select-active")

        $("#TaskDontRunWhenRecording").prop('checked', this.collection.at(this.currentTargetId).get("donotexecuteduringrecord"))
        if (!options.disableModal) {
          $("#editmodal").modal().data('accept', false).one('hidden.bs.modal', (event) => {
            if ((VariablesUpdateSkip = $(event.target).data('accept'))) {
              log.info(`Task editing has been finished`);
            } else {
              log.info(`Task editing has been canceled`);
            }
          });
        }
        var match = code.match(/\/\*Dat\:([^\*]+)\*\//)
        if(match)
        {
          //$("#TaskCode").val(code.replace(/\s*\/\*Dat\:[^\*]+\*\/\s*/g,""))
          //$("#TaskData").val("/*Dat:" + match[1] + "*/")
          BrowserAutomationStudio_EditStart(match[1])
        }
      },

      initialize: function(){
        this.templates =
        {
          "main" : _.template($('#main').html())
        }
        var self = this

        this.send = function()
        {

          if(!self.model.get("dontsend"))
          {
            //alert("send")
            try{
              var time = Date.now()

              UpdateGotos()

              _EmbeddedModel.Update()

              console.log("Preprocessing in " + (Date.now() - time).toString())

              var code = GenerateCode(self.collection.toJSON(),self.model.toJSON())
              console.log("Generate in " + (Date.now() - time).toString())
              
              var d = new diff_match_patch()

              var prefix_length  = d.diff_commonPrefix(BrowserAutomationStudio_LastCode, code)
              
              var patch_text1 = BrowserAutomationStudio_LastCode.substring(prefix_length,BrowserAutomationStudio_LastCode.length)
              var patch_text2 = code.substring(prefix_length,code.length)
              
              var suffix_length  = d.diff_commonSuffix(patch_text1, patch_text2)

              patch_text1 = patch_text1.substring(0,patch_text1.length - suffix_length)
              patch_text2 = patch_text2.substring(0,patch_text2.length - suffix_length)

              console.log("Patch text 1 length " + patch_text1.length)
              console.log("Patch text 2 length " + patch_text2.length)

              var patch = ""
              var is_diff_match_patch = patch_text2.length > 50000
              if(is_diff_match_patch)
              {
                try
                {
                  console.log("Try to use native diff match patch ...")
                  //Run no longer then 500 ms
                  var diff = d.diff_main(patch_text1, patch_text2, true, (new Date).getTime() + 500)
                  patch = prefix_length + "@@@" + suffix_length + "@@@0@@@" + d.patch_toText(d.patch_make(patch_text1, diff))
                  console.log("Success!")
                }catch(e)
                {
                  console.log("Too long preparing patch, using native")
                  is_diff_match_patch = false
                }
              }else
              {
                console.log("Changes are too short, using native")
              }

              
              if(!is_diff_match_patch)
                patch = prefix_length + "@@@" + suffix_length + "@@@1@@@" + patch_text2

              
              BrowserAutomationStudio_LastCode = code

              console.log("Patch in " + (Date.now() - time).toString())


              console.log("Patch length " + patch.length)

              BrowserAutomationStudio_SendCode(patch, extract_functions(code), extract_resources(code), extract_variables(code), extract_global_variables(code), extract_labels(code), _GobalModel.get("execute_next_id"));
              console.log("Send in " + (Date.now() - time).toString())
            }catch(e)
            {}
          }
        }


        this.model.bind('change', this.render, this);
        
        this.collection.bind('add', function(){_CacheLoader.StartCarefully()});
        this.collection.bind('change', function(){_CacheLoader.StartCarefully()});
        this.collection.bind('remove', function(){_CacheLoader.StartCarefully()});  
        this.collection.bind('reset', function(){_CacheLoader.StartCarefully()});  


        this.collection.bind('add', this.render, this);
        this.collection.bind('add', this.send, this);
        this.collection.bind('remove', this.render, this);
        this.collection.bind('remove', this.send, this);

        try{
          BrowserAutomationStudio_Initialized();
        }catch(e)
        {}
        this.render();
      },

      renderisscriptexecutingcontainer: function(){
        var isscriptexecutingcontainer =  _.template($('#isscriptexecuting').html())({isscriptexecuting:_GobalModel.get("isscriptexecuting"), execute_next_id: _GobalModel.get("execute_next_id")});
        $("#isscriptexecutingcontainer").html(isscriptexecutingcontainer);
        
        var all = $("#isscriptexecutingcontainer *[title]")
        
        for(var i = 0;i< all.length;i++)
        {
          var el = $(all[i])
          el.attr("title",tr(el.attr("title")))
        }

        /*$('#isscriptexecutingcontainer [data-toggle="tooltip"]').tooltip({trigger:'hover', template:'<div class="mytooltip" role="tooltip"><div class="mytooltip-arrow tooltip-arrow"></div><div class="mytooltip-inner tooltip-inner"></div></div>',delay: { "show": 500, "hide": 100 }})*/
      },

      rendertaksid: function(){
        $(".taskcontainer").removeClass("toolexecutecurrent").removeClass("toolnotexecute").addClass("toolnotexecute")
        
        var id;
        if(parseInt(_GobalModel.get("execute_next_id")) == 0)
        {
          id = GetFirstNotFunctionId();
        }else
        {
          id = _GobalModel.get("execute_next_id");
        }

        $(".taskcontainer[task-id=" + id + "]").removeClass("toolexecutecurrent").removeClass("toolnotexecute").addClass("toolexecutecurrent")
      },

      renderselectiontemplatecontainer: function(){
        var selectiontemplatecontainer =  _.template($('#selectiontemplate').html())();
        $("#selectiontemplatecontainer").html(selectiontemplatecontainer);

        /*$('#selectiontemplatecontainer [data-toggle="tooltip"]').tooltip({trigger:'hover', template:'<div class="mytooltip" role="tooltip"><div class="mytooltip-arrow tooltip-arrow"></div><div class="mytooltip-inner tooltip-inner"></div></div>',delay: { "show": 500, "hide": 100 }})*/

      },

      render: function(model){
        if(_GobalModel.hasChanged("dontsend"))
        {
          return;
        }


        if(_GobalModel.hasChanged("isstepnextactivated") || _GobalModel.hasChanged("run_only_one_enabled") || _GobalModel.hasChanged("istaskexecuting"))
        {
          return;
        }

        if(_GobalModel.hasChanged("execute_next_id"))
        {
            this.rendertaksid();
            this.renderisscriptexecutingcontainer();
          return; 
        }


        if(_GobalModel.hasChanged("isscriptexecuting"))
        {
          this.renderisscriptexecutingcontainer();
          return;
        }

        if(this.model.get("dontsend"))
          return


        var t = new Date()

        if(!_CacheLoader.GetIsActiveForFindTaskById())
          _CacheLoader.Start()

        t = new Date()

        //alert("render")





        var index_start = -1;
        var index_end = -1;


        var models = _TaskCollection.models
        var len = models.length
        var function_name = _GobalModel.get("function_name")
        for(var i = 0;i<len;i++)
        {
          var task = models[i]
          var CanDisplay = function_name == GetFunctionData( parseInt(task.get("id")) )["name"] && !IsFunctionNode(parseInt(task.get("id")))
          if(CanDisplay || IsEmptyFunctionNode(parseInt(task.get("id"))) && GetFunctionDataOfThisNode(parseInt(task.get("id")))["name"] == function_name)
          {
            if(index_start <= 0)
            {
              index_start = i
            }
            index_end = i
          }
        }

        if(index_start < 0)
          index_start = 0
        
        if(index_end < 0)
          index_end = this.collection.length - 1
          
        console.log("render from " + index_start + " to " + index_end)

        BrowserAutomationStudio_CurrentVisibleStartIndex = index_start
        BrowserAutomationStudio_CurrentVisibleEndIndex = index_end

        var dat = []
        
        if(index_end != 0 || index_start != 0)
        {
          dat = this.collection.models.slice(index_start,index_end + 1)
        }

        if(this.collection.models.length > 0)
          dat.unshift(this.collection.models[0])

        console.time("Create html");
        var html = this.templates[this.model.get("state")]({data:dat,global:this.model.toJSON(),index_start: index_start})
        console.timeEnd("Create html");

        console.time("Apply html");
        //$("#containerdata").html(html)
        //document.getElementById("containerdata").innerHTML = html
        var total_actions = 0;
        var cached_actions = 0;
        var total_added = 0;
        var total_removed = 0;
        


        
        morphdom(document.getElementById("containerdata"), '<div id="containerdata" >' + html + '</div>', {
          onBeforeElUpdated: function(fromEl, toEl) {
              if(fromEl.hasAttribute("noupdate"))
              {
                return false
              }
              
              if(fromEl.id !== undefined && fromEl.id.startsWith("id1-"))
              {
                total_actions ++;
                if (fromEl.isEqualNode(toEl))
                {
                  cached_actions ++;
                  return false
                }

              }
              return true;
          },
          onNodeAdded: function(node)
          {
            if(node && node.nodeType == Node.ELEMENT_NODE)
            {
              _DragAndDrop.AddElement(node)
            }
          }

      });
        console.timeEnd("Apply html");
        console.log("Cached actions: " + cached_actions + " / " + total_actions + ". Total added: " + total_added + ", total removed: " + total_removed)




        _MainView.SetDefaultInsert()



        console.trace("Render time" + (new Date() - t) )
        if(window.startTime)
          console.log(Date.now() - window.startTime)

        
        //_CacheLoader.Stop()
        this.renderisscriptexecutingcontainer();
        this.renderselectiontemplatecontainer();
        _Inspector.render();

        var self = this

        $(".dropdown-context").remove();

        context.destroy()

        var elementmenu = [

          {text: tr('Delete this and all upper'), action: function(e){
                e.preventDefault();
                self.DeleteThisAndAllUpper()
          }},
          {text: tr('Delete this and all lower'), action: function(e){
                e.preventDefault();
                self.DeleteThisAndAllLower()
          }},
          {text: tr('Toggle selection'), action: function(e){
                e.preventDefault();
                self.ToggleSelection()
          }},
          {text: tr('Edit'), action: function(e){
                e.preventDefault();
                self.Edit()
          }},
          {text: tr('Delete this'), action: function(e){
                e.preventDefault();
                self.Delete(true)
          }},
          {text: tr('Run until this'), action: function(e){
                e.preventDefault();
                self.RunUntilThis()
          }},
          {text: tr('Move Execution Point Here'), action: function(e){
                e.preventDefault();
                self.MoveExecutionPointHere()
          }}
        ]

        var elementmenuextended = elementmenu.slice()
        elementmenuextended.push({text: tr('Execute only this action'), action: function(e){
                e.preventDefault();
                self.ExecuteOnlyThis()
          }})

        context.attach('.toolmenu', elementmenu);

        context.attach('.toolmenuextended', elementmenuextended);

        context.attach('.main', [
          {header: tr('Actions')},

          {text: '<img draggable="false" src="icons/copy.png" style="width:14px" /> ' + tr('Copy selected'), action: function(e){
                e.preventDefault();
                self.Copy()
          }},
          {text: '<img draggable="false" src="icons/paste.png" style="width:14px" /> ' + tr('Paste selected'), action: function(e){
                e.preventDefault();
                self.Paste()
          }},
          {text: '<img draggable="false" src="icons/cut.png" style="width:14px" /> ' + tr('Cut selected'), action: function(e){
                e.preventDefault();
                self.Cut()
          }},
          {text: tr('Delete selected'), action: function(e){
                e.preventDefault();
                self.DeleteSelected()
          }},
          {divider:true},
          {text: tr('Enable selected'), action: function(e){
                e.preventDefault();
                self.EnableSelected()
          }},
          {text: tr('Disable selected'), action: function(e){
                e.preventDefault();
                self.DisableSelected()
          }},
          {divider:true},
          {text: tr('Set color') + ' <span class="action-color-1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> ' + tr('for selected actions'), action: function(e){
              e.preventDefault();
              self.SetSelectedColor("1")
          }},
          {text: tr('Set color') + ' <span class="action-color-2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> ' + tr('for selected actions'), action: function(e){
              e.preventDefault();
              self.SetSelectedColor("2")
          }},
          {text: tr('Set color') + ' <span class="action-color-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> ' + tr('for selected actions'), action: function(e){
              e.preventDefault();
              self.SetSelectedColor("3")
          }},
          {text: tr('Set color') + ' <span class="action-color-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> ' + tr('for selected actions'), action: function(e){
              e.preventDefault();
              self.SetSelectedColor("4")
          }},
          {text: tr('Set color') + ' <span class="action-color-5">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> ' + tr('for selected actions'), action: function(e){
              e.preventDefault();
              self.SetSelectedColor("5")
          }},
          {text: tr('Clear color') + " " + tr('for selected actions'), action: function(e){
              e.preventDefault();
              self.SetSelectedColor("")
          }},
          {divider:true},
          {text: '<img draggable="false" src="icons/checkall.png" style="width:14px" /> ' + tr('Select all'), action: function(e){
                e.preventDefault();
                self.CheckAll()

          }},
          {text: '<img draggable="false" src="icons/uncheckall.png" style="width:14px" /> ' + tr('Clear selection'), action: function(e){
                e.preventDefault();
                self.ClearSelection()

          }},
          {divider:true},
          {text: '<i class="fa fa-arrow-circle-left" aria-hidden="true"></i> ' + tr('Fold all'), action: function(e){
                e.preventDefault();
                self.FoldAll()

          }},
          {text: '<i class="fa fa-arrow-circle-down" aria-hidden="true"></i> ' + tr('Unfold all'), action: function(e){
                e.preventDefault();
                self.UnfoldAll()

          }},
          {divider:true},

          {text: '<i class="fa fa-search" aria-hidden="true"></i> ' + tr('Search'), action: function(e){
                e.preventDefault();
                _ActionFinder.Show()
          }},
          {text: '<i class="fa fa-bug" aria-hidden="true"></i> ' + tr('Variable inspector'), action: function(e){
                e.preventDefault();
                _Inspector.show();
          }},
        ]);

        UpdateInsertPlacesTooltips();
        

        tr()

        _ActionFinder.SearchLast()
        
        _DragAndDrop.Init()

        /*$('[data-toggle="tooltip"]').tooltip({trigger:'hover', template:'<div class="mytooltip" role="tooltip"><div class="mytooltip-arrow tooltip-arrow"></div><div class="mytooltip-inner tooltip-inner"></div></div>',delay: { "show": 500, "hide": 100 }})*/

        $("body").show()
        BrowserAutomationStudio_HandlersInitialize()

        _VisualizeLabels.Visualize();

        return this.trigger('render');
      }
    });

    var _TaskCollection = new TaskCollection([/*{name:"Initialize Browser",code:"new_browser()!",id:0},{name:"Load Gmail.com",code:"load(\"gmail.com\")!",id:123},{name:"Load ya.ru",code:"load(\"ya.ru\")!",id:456}*/]);

    var _GobalModel = new GobalModel();

    var _MainView = new MainView({collection: _TaskCollection, model: _GobalModel});

    var _CacheLoader = new CacheLoader();

    var _UndoManager = new UndoManager();

    var BrowserAutomationStudio_LastCode = ""

    var _MultiSelect = new MultiSelect()

    var _DragAndDrop = new DragAndDrop()

    var _FunctionManager = new FunctionManager()

    var _HelpManager = new HelpManager()

    var _EmbeddedModel = new EmbeddedModel()

    var _WebInterfaceTasks = new WebInterfaceTasks()

    var _VisualizeLabels = new VisualizeLabels()

    var _ActionUpdater = new App.ActionUpdater();

    var _Inspector = new App.Inspector.View();

    _MultiSelect.Init()

    context.init({preventDoubleContext: false});

    $( document ).ready(function() {
        //document.documentElement.style.zoom = _Z + '%';
        $(document).keydown(function(e) {
          _MainView.key(e)
        });



        setTimeout(function(){_VisualizeLabels.Visualize()},1000)

        InitEdgeScroll();

        $("#EditFunctionName").keypress(function(e){
            var charCode = !e.charCode ? e.which : e.charCode;
            var IsGoodchar = charCode >= 'A'.charCodeAt(0) && charCode <= 'Z'.charCodeAt(0) || charCode >= 'a'.charCodeAt(0) && charCode <= 'z'.charCodeAt(0) || charCode == '_'.charCodeAt(0) || charCode >= '0'.charCodeAt(0) && charCode <= '9'.charCodeAt(0)
            if(!IsGoodchar)
                e.preventDefault();
        })
    });

    var BrowserAutomationStudio_DoubleClickId = -1
    var BrowserAutomationStudio_DoubleClickTime = 0



    /*
         =========
          VISIBLE INDEXES
         =========

    */

    var BrowserAutomationStudio_CurrentVisibleStartIndex = -1
    var BrowserAutomationStudio_CurrentVisibleEndIndex = -1

    function BrowserAutomationStudio_GetCurrentVisibleOffset()
    {
      if(BrowserAutomationStudio_CurrentVisibleStartIndex < 0 || BrowserAutomationStudio_CurrentVisibleEndIndex < 0)
      {
        //No information yet, return all and 0 offset
        return 0
      }

      if(BrowserAutomationStudio_CurrentVisibleStartIndex == 0 && BrowserAutomationStudio_CurrentVisibleEndIndex == 0)
      {
        //Empty function, zero offset again
        return 0
      }

      return BrowserAutomationStudio_CurrentVisibleStartIndex
    }


    function BrowserAutomationStudio_GetCurrentVisibleTasks()
    {
      if(BrowserAutomationStudio_CurrentVisibleStartIndex < 0 || BrowserAutomationStudio_CurrentVisibleEndIndex < 0)
      {
        //No information yet, return all
        return _TaskCollection.models
      }

      if(BrowserAutomationStudio_CurrentVisibleStartIndex == 0 && BrowserAutomationStudio_CurrentVisibleEndIndex == 0)
      {
        //Empty function
        return []
      }


      return _TaskCollection.models.slice(BrowserAutomationStudio_CurrentVisibleStartIndex,BrowserAutomationStudio_CurrentVisibleEndIndex + 1)
    }



    /*
         =========
          UNDO
         =========

    */

    
    var BrowserAutomationStudio_HandlerIsInitialized = false
    var BrowserAutomationStudio_StopSaveToUndoManager = false

    function BrowserAutomationStudio_SaveToUndoManager()
    {

      if(BrowserAutomationStudio_StopSaveToUndoManager)
        return

      if(_GobalModel.get("dontsend"))
          return

      var g = _GobalModel.toJSON()
      
      _UndoManager.Save(JSON.stringify({tasks: _TaskCollection.toJSON(), global: 
        {
          threadnumber: g["threadnumber"],
          successnumber: g["successnumber"],
          failnumber: g["failnumber"],
          function_name: g["function_name"]
        }}))
    }

    function BrowserAutomationStudio_RestoreFromUndoManager(data)
    {
      var j = JSON.parse(data)
      var global = j["global"]
      var tasks = j["tasks"]



      BrowserAutomationStudio_StopSaveToUndoManager = true
      _GobalModel.set("dontsend",true)
        
        _GobalModel.set("threadnumber",global["threadnumber"])
        _GobalModel.set("successnumber",global["successnumber"])
        _GobalModel.set("failnumber",global["failnumber"])
        _GobalModel.set("function_name",global["function_name"])

        _TaskCollection.reset(tasks);

        if(FindTaskById(_GobalModel.get("execute_next_id")) == null)
        {
          _GobalModel.set("execute_next_id",1)
        }

      _GobalModel.set("dontsend",false)
      BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
      _MainView.send()
      _MainView.render()



      BrowserAutomationStudio_StopSaveToUndoManager = false

    }

    /*
         =========
          INITIALIZE HANDLERS
         =========

    */    

    function BrowserAutomationStudio_HandlersInitialize() {
      if (BrowserAutomationStudio_HandlerIsInitialized) return;

      BrowserAutomationStudio_HandlerIsInitialized = true;
      _TaskCollection.on('add change remove', () => BrowserAutomationStudio_SaveToUndoManager());
      _TaskCollection.on('add change remove reset', () => BrowserAutomationStudio_AskForVariablesUpdateIfNeeded());
    }

    /*
         =========
          HELPERS
         =========

    */

    function FindTaskById(Id)
    {
      if(_CacheLoader.GetIsActiveForFindTaskById())
      {
        return _CacheLoader.FindTaskById(Id)
      }
      if(Id == 0)
        return _TaskCollection.at(1)

      var models = _TaskCollection.models
      var len = models.length
      for(var i = 0;i<len;i++)
      {
        var task = models[i]
        if(Number(task.get('id')) === Id)
        {
          return task
        }
      }
    }

    function DataInsertIndexToTaskId(insert_index)
    {
      insert_index = parseInt(insert_index)
      if(insert_index == 0)
        return 0;
      var task_id = null
      var is_upper = insert_index < 0
      if(is_upper)
        insert_index = -insert_index
      var task = _TaskCollection.at(insert_index)
      if(task)
      {
        task_id = parseInt(task.get("id"))
        if(is_upper)
          task_id = -task_id
        return task_id
      }
      return null
    }

    function TaskIdToDataInsertIndex(task_id)
    {
      var data_insert_index = null
      task_id = parseInt(task_id)
      if(task_id == 0)
        return 0;
      var is_upper = task_id < 0
      if(is_upper)
        task_id = -task_id
      data_insert_index = IndexOf(task_id)
      if(data_insert_index < 0)
        return null
      if(is_upper)
        data_insert_index = -data_insert_index
      return data_insert_index
    }

    

    function IsInsideElementLoop(Id)
    {
      if(Id == 0)
        return false
      
      var Task = FindTaskById(Id)

      if(!Task)
        return false

      var taskName = ""
      
      try
      {
        taskName = Task.dat()["s"]
      }catch(e)
      {
        taskName = ""
      }

      if(taskName == "loopelement")
      {
        return true
      }

      var parentId = parseInt(Task.attributes["parentid"])

      return IsInsideElementLoop(parentId)
    }

    function UpdateIfMasterSlave(Task, Code)
    {
      var match = Code.match("Dat:([^\*]+)")
      if(!match)
       return ""

      var dat = JSON.parse(b64_to_utf8(match[1]))
      if(dat["s"] != "if")
        return;

      if(!dat["d"])
        return;

      var IfElse = dat["d"].find(function(el){return el["id"] == "IfElse"})

      if(!IfElse)
        return;

      var iselse_next = IfElse["data"]

      IfElse = Task.dat()["d"].find(function(el){return el["id"] == "IfElse"})

      if(!IfElse)
        return;
      
      var iselse_prev = IfElse["data"]

      dat["master"] = parseInt(Task.get("id"))

      

      if(!iselse_next && iselse_prev)
      {
        if(Task.dat()["slave"])
        {
          var slave = parseInt(Task.dat()["slave"])
          var index = IndexOf(slave)
          if(index >= 0)
          {
            _MainView.currentTargetId = index
            _MainView.Delete()
            _.every(_MainView.collection.models, function(task,index){
              task.attributes["is_selected"] = false
              task.attributes["code_precomputed"] = null
              return true
            })
            $(".taskcontainer .selected").css("visibility","hidden")
            _MainView.RecalculateMargins($(".tool-margin"),"clear")
          }
        }
      }else if(iselse_next && !iselse_prev)
      {
        
        var original_id = parseInt(Task.get("id"))
        var insert_index = IndexOf(original_id)
        while(true)
        {
          var task_current = _MainView.collection.at(insert_index)
          if(insert_index >= _MainView.collection.length)
            break;
          
          if(parseInt(task_current.get("id")) != original_id &&  !IsAnsectorOf(original_id,task_current.get("parentid")))
            break;

          insert_index += 1
        }

        var insert_parent = parseInt(Task.get("parentid"))

        var Id = parseInt(dat["slave"])

        dat["role"] = "slave"

        var Code = "/*Dat:" + utf8_to_b64(JSON.stringify(dat)) + "*/\n"
        Code += "_if(!" + dat["if_var"] + ",function(){\n"
        Code += "section_insert()\n"
        Code += "})!\n"
        Code += "delete " + dat["if_var"] + ";\n"

        var task = { name: "Else", code: Code, id: Id, donotexecuteduringrecord: Task.get("donotexecuteduringrecord"), parentid: insert_parent}

        
        _TaskCollection.add(task,{at: insert_index})

        dat["role"] = "master"

        Code = Code.replace(new RegExp("Dat:([^\*]+)"), "Dat:" + utf8_to_b64(JSON.stringify(dat)))
        Task.set("code",Code)  

        _.every(_MainView.collection.models, function(task,index){


          task.attributes["is_selected"] = false
          task.attributes["code_precomputed"] = null
          return true
        })
        $(".taskcontainer .selected").css("visibility","hidden")
        _MainView.RecalculateMargins($(".tool-margin"),"clear")

      }

      
      
    }

    function FindTaskIdByLabel(Label)
    {
      var search = "_set_goto_label(" + JSON.stringify(Label) + ")!"
      var models = _TaskCollection.models
      var len = models.length
      for(var i = 0;i<len;i++)
      {
        var task = models[i]
        if(task.get('code').indexOf(search) >= 0)
        {
          return task.get('id')
        }
      }
      return 1
    }

    function FindTaskIdByInternalLabelId(internal)
    {
      var models = _TaskCollection.models
      var len = models.length
      for(var i = 0;i<len;i++)
      {
        var task = models[i]
        if(task.get('internal_label_id') == internal)
        {
          return task.get('id')
        }
      }
      return -1
    }

    function TotalSelected()
    {
      var res = 0
      var models = _TaskCollection.models
      var len = models.length
      for(var i = 0;i<len;i++)
      {
        var task = models[i]
        if(Number(task.get('is_selected')))
        {
          res++
        }
      }
      return res
    }

    function IndexOf(Id)
    {
      var task = FindTaskById(Id)
      if(!task)
        return -1
      return _TaskCollection.models.indexOf(task)
    }

    function FindNextTask(Id)
    {
      var task = FindTaskById(Id)
      if(!task)
        return null
      var index = _TaskCollection.models.indexOf(task)

      if(index<0)
        return null

      if(index + 1 >= _TaskCollection.models.length)
        return null

      var nexttask = _TaskCollection.models[index + 1]
      return nexttask
    }

    function FindPrevTask(Id)
    {
      var task = FindTaskById(Id)
      if(!task)
        return null
      var index = _TaskCollection.models.indexOf(task)

      if(index == 0)
        index = _TaskCollection.models.length - 1
      else
        index -= 1

      if(index<0)
        return null

      if(index >= _TaskCollection.models.length)
        return null

      var nexttask = _TaskCollection.models[index]
      return nexttask
    }

    function IsFunctionNode(Id)
    {
      if(parseInt(Id) == 0)
        return false
      var task = FindTaskById(Id)
      if(!task)
        return false
      return task.get("code").indexOf("function") == 0
    }

    function IsEmptyFunctionNode(Id)
    {
      return IsFunctionNode(Id) && IsEmptyAndGroup(IndexOf(Id))
    }

    function GetFunctionDataOfThisNode(Id)
    {
      if(_CacheLoader.GetIsActiveForGetFunctionDataOfThisNode())
      {
        return _CacheLoader.GetFunctionDataOfThisNode(Id)
      }
      var task = FindTaskById(Id)
      if(!task)
        return {isfunction: false,name: "Main", id: 0}

      if(!IsFunctionNode(Id))
        return {isfunction: false,name: "Main", id: 0}

      var RegexpFunction = new RegExp("function\\s+([^\\(]+)\\(");
      var code = task.get("code")
      var match = code.match(RegexpFunction)
      if(match)
      {
        return {isfunction: true, name: match[1], id: Id}
      }
      return {isfunction: false,name: "Main", id: 0}
    }

    function GetFunctionBody(name)
    {
      var task = FindTaskById(0)
      var functionExists = false;
      while(true)
      {
        if(!task)
          break

        var id = parseInt(task.get("id"))

        if(GetFunctionData(id)["name"] == name)
        {
          if(!IsFunctionNode(id))
          {
            var code = _.template($('#function_code').html())({name:name})
            code = code.replace("section_insert()","section_start(\"test\", " + id + ")!")
            return code
          }else
          {
            functionExists = true;
          }
        }


        task = FindNextTask(id)
      }
      if(functionExists)
      {
        return "function " + name + "(){}"
      }
      return ""
    }

    function IsFunctionExists(name)
    {
      var task = FindTaskById(0)
      while(true)
      {
        if(!task)
          break

        var id = parseInt(task.get("id"))

        if(IsFunctionNode(id) && GetFunctionData(id)["name"] == name)
        {
          return true
        }

        task = FindNextTask(id)
      }
      return false
    }

    function GetFunctionList()
    {
      var task = FindTaskById(0)
      var res = []
      res.push({isfunction: false,name: "Main", id: 0})
      while(true)
      {
        if(!task)
          break

        var id = parseInt(task.get("id"))

        if(IsFunctionNode(id))
          res.push(GetFunctionDataOfThisNode(id))


        task = FindNextTask(id)
      }
      return res
    }


    function GetFunctionData(Id)
    {
      if(_CacheLoader.GetIsActiveForGetFunctionData())
      {
        return _CacheLoader.GetFunctionData(Id)
      }
      var id = Id

      while(true)
      {
        var task = FindTaskById(parseInt(id))

        if(!task)
          break

        var data = GetFunctionDataOfThisNode(parseInt(id))

        if(data["isfunction"])
          return data

        id = parseInt(task.get("parentid"))

        if(id == 0)
          break;
      }
      return {isfunction: false,name: "Main", id: 0};
    }

    function GetFirstNotFunctionId()
    {
      if(_CacheLoader.GetIsActiveForGetFirstNotFunctionId())
      {
        return _CacheLoader.GetFirstNotFunctionId()
      }
      var task = FindTaskById(0)
      var found = false
      while(true)
      {
        if(!task)
          break
        var id = parseInt(task.get("id"))
        var funcdata = GetFunctionData(id)

        if(id != 0 && funcdata["id"] == 0)
        {
          found = true
          break
        }
        task = FindNextTask(id)
      }
      if(found)
      {
        return parseInt(task.get("id"))
      }else
        return 0
    }

    function FindFirstAncestor(Id)
    {
      var task = FindNextTask(Id)
      if(task && parseInt(task.get("parentid")) === parseInt(Id))
      {
        return task
      }
      return null
    }

    function FindNextSiblingOrUpper(Id)
    {
      var task = FindTaskById(Id)
      if(!task)
        return null
      while(true)
      {
        var tasknext = FindNextTask(Id)

        if(!tasknext)
          break
        if(tasknext && GetTaskDepth(parseInt(task.get("id"))) >= GetTaskDepth(parseInt(tasknext.get("id"))))
        {
          return tasknext
        }
        Id = parseInt(tasknext.get("id"))
      }
      return null
    }

    function FindNextSibling(Id)
    {
      //var first_not_function = GetFirstNotFunctionId();
      var task = FindTaskById(Id)
      var task_depth = GetTaskDepth(parseInt(task.get("id")))
      if(!task)
        return null
      while(true)
      {
        var tasknext = FindNextTask(Id)

        if(!tasknext)
          break

        /*if(parseInt(first_not_function) == parseInt(tasknext.get("id")))
          return null*/

        if(tasknext)
        {
          var tasknext_depth = GetTaskDepth(parseInt(tasknext.get("id")))
          if(tasknext_depth == task_depth)
          {
            return tasknext            
          }
          if(tasknext_depth < task_depth)
          {
            return null            
          }
        }
        Id = parseInt(tasknext.get("id"))
      }
      return null
    }

    function FindDirectNextSibling(Id)
    {
      //var first_not_function = GetFirstNotFunctionId();
      var task = FindTaskById(Id)
      var task_depth = GetTaskDepth(parseInt(task.get("id")))
      if(!task)
        return null
      while(true)
      {
        var tasknext = FindNextTask(Id)

        if(!tasknext)
          break

        /*if(parseInt(first_not_function) == parseInt(tasknext.get("id")))
          return null*/

        if(tasknext)
        {
          var tasknext_depth = GetTaskDepth(parseInt(tasknext.get("id")))
          if(tasknext_depth == task_depth)
          {
            return tasknext            
          }else
          {
            return null            
          }
        }
        Id = parseInt(tasknext.get("id"))
      }
      return null
    }

    function FindDirectPrevSibling(Id)
    {
      //var first_not_function = GetFirstNotFunctionId();
      var task = FindTaskById(Id)
      var task_depth = GetTaskDepth(parseInt(task.get("id")))
      if(!task)
        return null
      while(true)
      {
        var tasknext = FindPrevTask(Id)

        if(!tasknext)
          break

        /*if(parseInt(first_not_function) == parseInt(tasknext.get("id")))
          return null*/

        if(tasknext)
        {
          var tasknext_depth = GetTaskDepth(parseInt(tasknext.get("id")))
          if(tasknext_depth == task_depth)
          {
            return tasknext            
          }
          else
          {
            return null            
          }
        }
        Id = parseInt(tasknext.get("id"))
      }
      return null
    }

    function IsAnsectorOf(Id,IdAnsector)
    {
      if(Id == IdAnsector)
        return true

      if(Id == 0)
        return true

      while(true)
      {
        var TaskAnsector = FindTaskById(IdAnsector)
        if(!TaskAnsector)
          break
        var parentid = parseInt(TaskAnsector.get("parentid"))
        if(parentid == 0)
          break
        if(Id == parentid)
          return true
        IdAnsector = parentid
      }

      return false
    }

    function IsAnsectorOfAny(Ids,IdAnsector)
    {
      for(var i = 0;i<Ids.length;i++)
      {
        if(this.IsAnsectorOf(Ids[i],IdAnsector))
        {
          return true
        }
      }
      return false
    }

    function NeedToShowUpperInsert(index)
    {
      if(index == 0)
        return false

      if(index == 1)
        return true

      if(_TaskCollection.models[index].get("name") == "Else")
      {
        return false
      }

      if(
        parseInt(GetFirstNotFunctionId()) == parseInt(_TaskCollection.models[index].get("id")) || 
        parseInt(_TaskCollection.models[index].get("parentid")) != parseInt(_TaskCollection.models[index - 1].get("parentid")) || 
        (/*(_TaskCollection.models[index].get("code").indexOf("section_insert") < 0) &&*/ (_TaskCollection.models[index - 1].get("code").indexOf("section_insert") >= 0)) 
      )
        return true

      return false
    }

    function IsEmptyAndGroup(index)
    {
      
      if(_CacheLoader.GetIsActiveForIsEmptyAndGroup())
      {
        return _CacheLoader.IsEmptyAndGroup(index)
      }
      if(index == 0)
        return false

      if (_TaskCollection.at(index).get("code").indexOf("section_insert()") < 0)
        return false

      var isempty = true
      var id = parseInt(_TaskCollection.at(index).get("id"))
      var len = _TaskCollection.models.length
      

      /*for(var i = 0;i<len;i++)
      {
        if(id === parseInt(_TaskCollection.at(i).get("parentid")))
        {
          isempty = false
          break
        }
      }*/

      if(index + 1 <= len - 1 && id === parseInt(_TaskCollection.at(index + 1).get("parentid")))
        isempty = false

      return isempty
    }
    

    function AllowToExecuteOnce(Id)
    {
      var task = FindTaskById(Id)
      if(task)
      {
        if(task.get("code").indexOf("section_insert()") >= 0)
          return false
        if(task.get("code").indexOf("_call") >= 0)
          return false
        if(task.get("code").indexOf("_call_function") >= 0)
          return false
        
        return true
      }else
        return false
    }

    function GetGroupsEndings(index)
    {
      if(_CacheLoader.GetIsActiveForGetGroupsEndings())
      {
        return _CacheLoader.GetGroupsEndings(index)
      }
      var res = []

      if(index<0 || index >= _TaskCollection.models.length)
        return res;

      var task = _TaskCollection.models[index]

      if(!task)
        return res;

      var id = parseInt(task.get("id"))
      var add = 1

      var thisdepth = GetTaskDepth(id)

      if(IsEmptyAndGroup(index))
      {
        res.push({"parentid":id,"level":thisdepth + 1})
        add = 0
      }

      var thisdepthcopy = thisdepth

      var nexttask = null

      if(index + 1 < _TaskCollection.models.length)
        nexttask = _TaskCollection.models[index + 1]
      
      var nextdepth = -1
      if(nexttask)
      {
        var parentid = parseInt(task.get("parentid"))
        var nextparent = parseInt(nexttask.get("parentid"))

        if(parentid == nextparent)
        {
          nextdepth = thisdepth
        }else if(id == nextparent)
        {
          nextdepth = thisdepth + 1
        }else
        {
          nextdepth = GetTaskDepth(nexttask.get("id"))
        }
      }

      if(thisdepth - nextdepth > add)
      {
        var stack = GetTaskStack(id)
        for(var i = add;i<thisdepth - nextdepth;i++)
        {
          res.push({"parentid":stack[i],"level":thisdepthcopy - i})
        }
      }
      return res
    }

    function NeedToShowLowerInsert(index)
    {
      if(index == 0)
      {
        return false
      }
      if(_TaskCollection.models[index].get("code").indexOf("section_insert()") >= 0)
        return false

      return true
    }

    function PrepareFunction(FunctionName)
    {
      var FunctionData = ""
      
      var task = FindTaskById(0)
      while(true)
      {
        if(!task)
          break

        var id = parseInt(task.get("id"))

        if(IsFunctionNode(id) && GetFunctionData(id)["name"] == FunctionName)
        {
          break 
        }

        task = FindNextTask(id)
      }

      if(task)
      {
        FunctionData += GenerateSubsection(IndexOf(task.get("id")),_TaskCollection.toJSON(),1,"").res
                          .replace(/section\_end\(\)\!/g,"")
                          .replace(/section\_start.*\)\!/g,"")
      }

      
      return FunctionData

    }

    function BrowserAutomationStudio_PrepareFunction(FunctionName)
    {
      BrowserAutomationStudio_PrepareFunctionResult(FunctionName, PrepareFunction(FunctionName))
    }


    function BrowserAutomationStudio_DetectorBrowserData(task)
    {
      var res = {}
      try
      {
        var a = task.dat()["s"]
        if
        (
          a == "load" ||
          a == "type" ||
          a == "moveandclickelement" ||
          a == "moveandclick" ||
          a == "click" ||
          a == "clickelement" ||
          a == "typeelement" ||
          a == "dragelement" ||
          a == "dropelement" ||
          a == "drag" ||
          a == "drop"
        )
        {
          res["type"] = "browser"
          res["id"] = task.get("id");
          res["name"] = prepare_title(task.dat(),task.get("name"))
          
          res["is_image"] = Boolean(task.dat()["p"] && task.dat()["p"]["is_image"])
          if(res["is_image"])
          {
            res["image"] = task.dat()["d"].find(function(el){return el["id"] == "ImageBase64"})["data"]
          }else
          {
            res["description"] = max_length(BrowserAutomationStudio_GenerateActionText("", task.dat(), 50, true), 50)
          }

          res["comment"] = prepare_description(task.dat(),task.get("name"));

          res["timestamp"] = Math.floor(Date.now())

          BrowserAutomationStudio_SendDetectorBrowserData(JSON.stringify(res))

          //alert("Send " + res["id"])
        }
      }catch(e)
      {
      }

      

    }


    function GetTaskDepth(Id)
    {
      var res = 0
      var id = Id


      while(true)
      {
        var task = FindTaskById(parseInt(id))

        if(!task)
          break

        id = parseInt(task.get("parentid"))

        if(id == 0)
          break;
        res += 1
      }
      return res;
    }

    function GetTaskStack(Id)
    {

      var id = Id
      var res = []

      while(true)
      {
        var task = FindTaskById(parseInt(id))

        if(!task)
          break

        id = parseInt(task.get("parentid"))
        res.push(id)

        if(id == 0)
          break;
      }
      return res;
    }

    function SendTask()
    {
      var execute_next_id = parseInt(_GobalModel.get("execute_next_id"))
      if(execute_next_id == 0)
      {
        execute_next_id = GetFirstNotFunctionId()
        if(execute_next_id == 0)
          execute_next_id = 1
        if(IsFunctionExists("OnApplicationStart"))
        {
          var code = GetFunctionBody("OnApplicationStart") + "\n_call(OnApplicationStart,null)!\nsection_start(\"test\", " + execute_next_id + ")!"
          BrowserAutomationStudio_Execute(code, BrowserAutomationStudio_IsPlayingScript())
          return
        }

      }

      var task = null
      if(execute_next_id != 1)
        task = FindTaskById(execute_next_id)

      if(!task)
        _GobalModel.set("isscriptexecuting",false)
      else
      {
        //var index = _.indexOf(_TaskCollection.models, task)
        var second_line = "";

        var tasknext;

        tasknext = FindNextSiblingOrUpper(parseInt(execute_next_id))

        if(tasknext && GetFirstNotFunctionId() != parseInt(tasknext.get("id")) && !IsFunctionNode(parseInt(tasknext.get("id"))))
        {

          var nextindex = IndexOf(parseInt(tasknext.get("id")))
          var index = IndexOf(parseInt(task.get("id")))
          if(nextindex >= 0 && nextindex > index && GetTaskDepth(parseInt(tasknext.get("id"))) < GetTaskDepth(parseInt(task.get("id"))) )
          {
            second_line="_next_or_section(" + tasknext.get("id") + ")!"
          }else
          {
            second_line="section_start(\"test\", " + tasknext.get("id") + ")!"
          }
        }else
        {
          if(parseInt(task.get("parentid")) != 0)
          {
            second_line="_next_or_section(1)!"
          }else
          {
            second_line="section_start(\"test\", 1)!"
          }
        }

        /*if(index + 1 >= _TaskCollection.length)
        {
          second_line="section_start(\"test\", 1)!"
        }else
        {
          var next_task_id = _TaskCollection.at(index + 1).get("id")
          second_line="section_start(\"test\", " + next_task_id + ")!"
        }*/

        var code = ""

        if(!task.get("donotexecuteduringrecord"))
        {
          code += task.get("code")
          if(code.indexOf("_goto(")>=0)
          {
            var is_long = code.indexOf("_long_goto(")>=0
            code = code.split("_goto(")[1]
            code = code.split(")!")[0]
            var depth = -1
            var additional = []
            if(is_long)
            {
              depth = parseInt(code.split(",")[1])
              additional = JSON.parse(code.split(",").slice(2).join(","))

            }

            AdditionalStackItems = ""

            for(var i = additional.length - 1;i>=0;i--)
            {
              var a = additional[i]

              if(a)
              {
                a = FindTaskIdByInternalLabelId(a.replace("_internal_",""))
                if(a)
                {
                  AdditionalStackItems+="CYCLES.Push(new Cycle(function(){_break();},function(){section_start(\"\"," + a + ",function(){})}));"
                }
              }else
              {
                AdditionalStackItems+="CYCLES.Push(new Cycle(function(){_break();},function(){}));"
              }
            }


            var label = JSON.parse(code.split(",")[0])
            second_line = "section_start(\"test\", " + FindTaskIdByLabel(label) + ")!"
            if(depth >= 0)
              second_line = "for(var i = 0;i<" + depth + ";i++)CYCLES.Pop();" + AdditionalStackItems + second_line
            else
              second_line = "_kill_call_stack();" + second_line

            code = ""

          }else if(code.indexOf("_set_goto_label(")>=0)
          {
            code = ""
          }
          else
          {
            var taskansector = FindFirstAncestor(parseInt(execute_next_id))
            if(taskansector)
            {
              code = code.replace("section_insert()","section_insert()\n" + "section_start(\"test\", " + taskansector.get("id") + ")!")
            }
          }
        }

        code = code.replace(new RegExp("\\_call_section\\(\\s*([^\\,\\s]+)\\s*\\,.*?\\)\\!","g"),"_call($1,null)!")
        var FunctionRegexp = new RegExp("\\_call(?:_function)?\\(\\s*([^\\,\\s]+)\\s*\\,")
        var match = code.match(FunctionRegexp)
        if(match)
        {
          var name = match[1]
          code = GetFunctionBody(name) + "\n" + code
        }
        
        
        var FunctionRegexp2 = new RegExp(/\/\*CallsFunction\:([^\*]+)\*\//)
        var match2 = code.match(FunctionRegexp2)
        if(match2)
        {

          var name = match2[1]
          code = PrepareFunction(name) + "\n" + code
        }
      

        
        var CustomThreadRegexp = new RegExp("\\_thread_start\\(\\s*[^\\,]+\\,\\s*[^\\,]+\\,\\s*\\\"([^\\,\\s\\\"]+)\\\"\\s*\\,")
        if(!match)
        {
          match = code.match(CustomThreadRegexp)
          if(match)
          {
            _WebInterfaceTasks.OnStartCustomThread()
            var name = match[1]
            code = GetFunctionBody(name) + "\n" + code + "\nScriptWorker.SendTaskResult(JSON.stringify({Message: \"\", Result: null,Success:true}))"
          }
        }

        code += "\n"
        code += second_line
        //alert(second_line)
        

        BrowserAutomationStudio_DetectorBrowserData(task)
        BrowserAutomationStudio_Execute("_sa(" + parseInt(task.get("id")) + ");" + code, BrowserAutomationStudio_IsPlayingScript())
      }

    }

    var VariablesUpdateRequested = false;
    var VariablesUpdateNeeded = false;
    var VariablesUpdateSkip = false;
    var VariablesListPrev = [];

    function BrowserAutomationStudio_Play()
    {
      _MainView.play()
    }

    function BrowserAutomationStudio_GetVariablesList()
    {
      var code = GenerateCode(_TaskCollection.toJSON(),_GobalModel.toJSON())
      var match = code.match(/VAR_[A-Z0-9_]+/g)
      var variables = null
      if(match)
      {
        variables = _.uniq(match)
      }else
        variables = []       

      JSON.parse(extract_global_variables(code)).forEach(function(el){
        variables.push("GLOBAL:" + el["name"])

      })

      return variables
    }

    function BrowserAutomationStudio_FocusActionFast(Id)
    {
      BrowserAutomationStudio_FocusAction(Id,true)
    }

    var BrowserAutomationStudio_HighlightHelpIsActive = false;
    async function BrowserAutomationStudio_HighlightHelp()
    {
      if(BrowserAutomationStudio_HighlightHelpIsActive)
        return

      BrowserAutomationStudio_HighlightHelpIsActive = true;
      for(var i = 0; i < 5;i++)
      {
        $("#helplabelcontainer").css("border-left", "1px solid #bb5852")
        $("#helplabelcontainer").css("border-bottom", "1px solid #bb5852")
        $("#helplabelcontainer").css("border-top", "1px solid #bb5852")
        $("#helplabelcontainer").css("background-color", "#bb5852")
        $("#helplabelcontainer button").css("border-color", "#bb5852")
        await new Promise(resolve => setTimeout(resolve, 500));
        if(i == 4 || !BrowserAutomationStudio_HighlightHelpIsActive)
        {
          $("#helplabelcontainer").css("border-left", "1px solid #dbdbdb")
          $("#helplabelcontainer").css("border-bottom", "1px solid #dbdbdb")
          $("#helplabelcontainer").css("border-top", "1px solid #dbdbdb")
          $("#helplabelcontainer").css("background-color", "#f1f1f1")
          $("#helplabelcontainer button").css("border-color", "#ccc")
          BrowserAutomationStudio_HighlightHelpIsActive = false;
          return;
        }else
        {
          $("#helplabelcontainer").css("border-left", "1px solid #dbdbdb")
          $("#helplabelcontainer").css("border-bottom", "1px solid #dbdbdb")
          $("#helplabelcontainer").css("border-top", "1px solid #dbdbdb")
          $("#helplabelcontainer").css("background-color", "#f1f1f1")
          $("#helplabelcontainer button").css("border-color", "#ccc")
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
      }
      

      
    }


    function BrowserAutomationStudio_FocusAction(Id, Fast)
    {
      if(typeof(Fast) == "undefined" || Fast == false)
      {
        var task = FindTaskById(Id)
        if(!task)
          return
        var funcdata = GetFunctionData(Id)
        var function_name = _GobalModel.get("function_name")

      
        if(function_name != funcdata["name"])
        {

          if(_GobalModel.get("function_name") != funcdata["name"])
          {
            _MainView.ClearSelection()
          }
          
          _GobalModel.set("function_name", funcdata["name"])
        }
      }

      var el = $(".tool[task-id=" + Id + "]")
      if(el.length > 0)
      {
        el[0].scrollIntoViewIfNeeded();
        el.addClass("toolhighlight")
        setTimeout(function(){el.removeClass("toolhighlight")},1000)
      }
      
    }

    function BrowserAutomationStudio_UnfoldTaskMasterSlave(Task)
    {
      var need_send = false

      var dat = Task.dat()
      if(dat && dat["role"] == "slave") 
      {
        if(Task.get("is_fold"))
        {
           need_send = true
           Task.attributes["is_fold"] = false
           Task.attributes["code_precomputed"] = null
           $(".folding-unfolded[task-id='" + Task.get("id") + "']").show()
           $(".folding-folded[task-id='" + Task.get("id") + "']").hide()
        }

        var master = FindTaskById(dat["master"])

        if(master && master.get("is_fold"))
        {
          need_send = true
          master.attributes["is_fold"] = false
          master.attributes["code_precomputed"] = null
          $(".folding-unfolded[task-id='" + master.get("id") + "']").show()
          $(".folding-folded[task-id='" + master.get("id") + "']").hide()
        }
      }
      if(dat && dat["role"] == "master") 
      {
        var slave = FindTaskById(dat["slave"])

        if(slave && slave.get("is_fold"))
        {
          need_send = true
          slave.attributes["is_fold"] = false
          slave.attributes["code_precomputed"] = null
          $(".folding-unfolded[task-id='" + slave.get("id") + "']").show()
          $(".folding-folded[task-id='" + slave.get("id") + "']").hide()
        }
      }
      return need_send

    }

    function BrowserAutomationStudio_UnfoldParents(Id)
    {
      var need_send = false

      Id = parseInt(Id)
      if(Id == 0)
        return;

      var Task = FindTaskById(Id)
      if(!Task)
        return;

      if(BrowserAutomationStudio_UnfoldTaskMasterSlave(Task))
        need_send = true

      Id = parseInt(Task.get("parentid"))

      while(true)
      {
        if(Id == 0)
          break;
        var Task = FindTaskById(Id)
        if(!Task)
           break

        if(Task.get("is_fold"))
        {
           need_send = true
           Task.attributes["is_fold"] = false
           Task.attributes["code_precomputed"] = null
           $(".folding-unfolded[task-id='" + Task.get("id") + "']").show()
           $(".folding-folded[task-id='" + Task.get("id") + "']").hide()
        }

        if(BrowserAutomationStudio_UnfoldTaskMasterSlave(Task))
          need_send = true

        var ParentId = parseInt(Task.get("parentid"))
        if(ParentId == 0)
           break
        
        Id = ParentId
      }

      if(need_send)
      {
        _MainView.RecalculateFolding($(".tool-margin"))
        BrowserAutomationStudio_SaveToUndoManager()
        _MainView.send()
      }
    }

    function BrowserAutomationStudio_AskForVariablesUpdateIfNeeded() {
      if (_GobalModel.get('dontsend')) return;

      const variables = BrowserAutomationStudio_GetVariablesList();

      if (_.isEqual(variables, VariablesListPrev)) {
        return log.info('Skipping a non-strict variables update - variables haven’t changed yet');
      }

      if (_GobalModel.get('isscriptexecuting')) {
        return log.info('Skipping a non-strict variables update - the script is still running');
      }

      if (_GobalModel.get('istaskexecuting')) {
        return log.info('Skipping a non-strict variables update - the task is still running');
      }

      BrowserAutomationStudio_AskForVariablesUpdate();
    }

    function BrowserAutomationStudio_AskForVariablesUpdate() {
      if (VariablesUpdateRequested) {
        log.info('Request to update variables has already been sent');
        VariablesUpdateNeeded = true;
        return;
      }

      VariablesListPrev = BrowserAutomationStudio_GetVariablesList();
      VariablesUpdateRequested = true;
      VariablesUpdateNeeded = false;

      log.info('Request to update the list of variables', VariablesListPrev);
      BrowserAutomationStudio_Execute(`debug_variables(${JSON.stringify(VariablesListPrev)})!\nsection_start("test", -3)!`, false, true);
    }

    function BrowserAutomationStudio_RequestVariablesResult(data) {
      App.trigger('variablesRequest', App.utils.parseJSON(data));
    }

    function BrowserAutomationStudio_UpdateVariablesResult(data) {
      if (VariablesUpdateRequested) {
        VariablesUpdateRequested = false;
        VariablesUpdateNeeded = false;
      }
      log.info('Received an update for variables');
      _Inspector.send({ type: 'update', payload: App.utils.parseJSON(data) });
    }

    function BrowserAutomationStudio_UpdateCallstackResult(data) {
      log.info('Received an update for callstack');
      _Inspector.send({ type: 'update', payload: App.utils.parseJSON(data) });
    }

    var IsChangedUsed = false
    var IsChangedOn = false
    function BrowserAutomationStudio_GetClipboardResult(data)
    {
      if(data.length > 0)
      {
        var new_ids = _MainView.PasteFinal(data)
        new_ids.forEach(function(id){
          BrowserAutomationStudio_FocusActionFast(parseInt(id))
        })
      }
    }

    function BrowserAutomationStudio_IsChanged()
    {
      if(IsChangedUsed)
        return

      IsChangedUsed = true
      setInterval(function(){
        $("#restart").removeClass("toolblinkon").removeClass("toolblinkoff")
        IsChangedOn = !IsChangedOn
        if(IsChangedOn)
          $("#restart").addClass("toolblinkon")
        else
          $("#restart").addClass("toolblinkoff")
      }, 400) 
      
    }
    
    function BrowserAutomationStudio_EditCancel()
    {
      $('#editmodal').data('accept', false).modal('hide');
    }
  
    function BrowserAutomationStudio_AddTask(Name, Code, Id, DontInterrupt, DontSendToDetector)
    {
      if(Id == 0)
        Id = Math.floor(Math.random() * (1000000000 - 100)) + 100
      if(Name == "_threadnumber_")
      {
        _GobalModel.set("threadnumber",Code)
        _MainView.send()
      }else if(Name == "_successnumber_")
      {
        _GobalModel.set("successnumber",Code)
        _MainView.send()
      }else if(Name == "_failnumber_")
      {
        _GobalModel.set("failnumber",Code)
        _MainView.send()
      }else
      {
        var donotexecuteduringrecord = false
        var parsed = false
        var color = ""
        var is_fold = false
        var fd = ""
        try{
          if(Name.length > 0)
          {
            var data = JSON.parse(Name)
            if("e" in data)
              donotexecuteduringrecord = data["e"]
            if("n" in data)
              Name = data["n"]
            else
              Name = ""
            if("c" in data)
              color = data["c"]
            if("f" in data)
              is_fold = data["f"]
            if("fd" in data)
              fd = data["fd"]
          }

          parsed = true

        }catch(e){}

        if(!parsed)
        {
          while(Name.startsWith("_"))
          {
            donotexecuteduringrecord = true
            Name = Name.slice(1)
          }
        }

        if(typeof(DontInterrupt) == "undefined")
        {
          if(_MainView.isEdit)
          {
            _MainView.taskeditcustom(Name,Code,donotexecuteduringrecord)
            _ActionUpdater.model.trigger('toolbox.editSuccess');
            $('#editmodal').data('accept', true).modal('hide');
            return
          }
        }

        var insert_index = _GobalModel.get("insert_index")
        if(insert_index == 0)
        {
          insert_index = GetFirstNotFunctionId()
          if(insert_index == 0)
            insert_index = _TaskCollection.models.length - 1
          else
            insert_index = -IndexOf(GetFirstNotFunctionId())
        }
        insert_index = ((insert_index<0) ? - insert_index : insert_index + 1)

        var insert_parent = _GobalModel.get("insert_parent")
        //Id = Math.floor(Math.random() * (1000000000 - 100)) + 100

        var ParsedName = ""
        var IsMasterAndHasSlave = false
        try
        {
          var match = Code.match("Dat:([^\*]+)")
          if(match)
          {
            var dat = JSON.parse(b64_to_utf8(match[1]))
            if(dat["role"])
            {
              if(dat["role"] == "master") 
              {
                IsMasterAndHasSlave = true
                Id = dat["master"]
              }else if(dat["role"] == "slave")
              {
                Id = dat["slave"]
              }
            }
            if(dat["s"])
              ParsedName = dat["s"]
          }
          Id = parseInt(Id)
        }catch(e){}



        var task = { name: Name, code: Code, id: Id, donotexecuteduringrecord: donotexecuteduringrecord, is_fold: is_fold, fd: fd, color: color, parentid: insert_parent}

        _GobalModel.set("dontsend",true)

        _CacheLoader.SetDontUpdate(true)

          _TaskCollection.add(task,{at: insert_index})
          _GobalModel.attributes["insert_index"] = insert_index
          if((ParsedName == "if" && !IsMasterAndHasSlave) || ParsedName == "for" || ParsedName == "foreach" || ParsedName == "while" || ParsedName == "loopelement")
          {
            _GobalModel.attributes["insert_parent"] = Id
          }
          _MainView.UpdateInsertDataInterface()

        _CacheLoader.SetDontUpdate(false)
        _CacheLoader.Start()

        _GobalModel.set("dontsend",false)

        _MainView.PreserveInsert()

        BrowserAutomationStudio_SaveToUndoManager()
        BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()
        _MainView.send()


        _MainView.render()
        var el = $("*[task-id=" + Id + "]")
        if(el.length > 0)
        {
          el[0].scrollIntoViewIfNeeded();
        }

        //_NewInsertId = Id
        BrowserAutomationStudio_FocusActionFast(parseInt(Id))


        if(typeof(DontSendToDetector) == "undefined" || !DontSendToDetector)
          BrowserAutomationStudio_DetectorBrowserData(_TaskCollection.at(insert_index))

        
      }
    }

    function BrowserAutomationStudio_NotRunningTask(Id)
    {
      if(Id == -3)
      {
        VariablesUpdateRequested = false
        if(VariablesUpdateNeeded)
          BrowserAutomationStudio_AskForVariablesUpdate()
        return
      }

      if(typeof(Id) != "undefined" && Id == -2)
          Id = 0

      if(typeof(Id) != "undefined")
      {
        _GobalModel.set("execute_next_id", parseInt(Id))
        var task = FindTaskById(parseInt(Id))
        if(task)
        {
           var index = _.indexOf(_TaskCollection.models, task)
           var upper = false

           for(;index<_TaskCollection.models.length;index++)
           {
            if(NeedToShowUpperInsert(index))
            {
              upper = true
              break;
            }
            if(NeedToShowLowerInsert(index))
              break;
           }
           //_GobalModel.set("insert_parent", _TaskCollection.models[index].get("parentid"))
           
           try{
             if(Id != 0)
             {
                var new_name = GetFunctionData(parseInt(_TaskCollection.models[index].get("id")))["name"]
                
                if(new_name != _GobalModel.get("function_name"))
                  _MainView.ClearSelection()

                _GobalModel.set("function_name", new_name )
              }else
              {
                if("Main" != _GobalModel.get("function_name"))
                  _MainView.ClearSelection()

                _GobalModel.set("function_name", "Main" )
              }

           }catch(e){}
           //_GobalModel.set("insert_index", (upper) ? -index : index)

        }else
        {
          //_GobalModel.set("insert_index", _TaskCollection.length - 1)
          //_GobalModel.set("insert_parent", 0)
          //_GobalModel.set("function_name", "Main")
        }


      }

      if(_GobalModel.get("isstepnextactivated"))
      {
        _GobalModel.set("isscriptexecuting",false)
        _GobalModel.set("isstepnextactivated",false)
      }

      if(_GobalModel.get("current_run_until_target_id") == parseInt(Id))
      {
        _GobalModel.set("isscriptexecuting",false)
        _GobalModel.set("current_run_until_target_id",-1)
      }

      if(_GobalModel.get("run_only_one_enabled") == true)
      {
        _GobalModel.set("isscriptexecuting",false)
        _GobalModel.set("run_only_one_enabled",false)
      }

      if(_GobalModel.get("isscriptexecuting"))
      {
        SendTask()
      }else
        _GobalModel.set("istaskexecuting",false)

      if(typeof(Id) != "undefined")
      {
        if(Id == 0) 
          Id = GetFirstNotFunctionId()
        
        if(!_GobalModel.get("isscriptexecuting") && !_GobalModel.get("istaskexecuting"))
          BrowserAutomationStudio_UnfoldParents(Id)
        BrowserAutomationStudio_FocusActionFast(parseInt(Id))
      }/*else if(_NewInsertId)
      {
        if(!_GobalModel.get("isscriptexecuting") && !_GobalModel.get("istaskexecuting"))
          BrowserAutomationStudio_UnfoldParents(Id)
        BrowserAutomationStudio_FocusActionFast(parseInt(_NewInsertId))
        _NewInsertId = null
      }*/
      _GobalModel.set("isexecutionaborting", false);
    }

    function BrowserAutomationStudio_PreserveInterfaceState() {
      const state = JSON.stringify({
        inspector: {
          visible: _Inspector.$el.is(':visible'),
          height: _Inspector.$el.css('height'),
        },
      });

      BrowserAutomationStudio_SaveInterfaceState(state);
    }

    function BrowserAutomationStudio_LoadInterfaceState(state) {
      _.attempt(() => {
        const { inspector } = JSON.parse(state);

        if (inspector.visible) {
          _Inspector.$el.show();
        } else {
          _Inspector.$el.hide();
        }

        _Inspector.$el.css('height', inspector.height);
      });
    }

    function BrowserAutomationStudio_FinishedBackup(fullPath) {
      _ActionUpdater.model.trigger('backup', fullPath);
    }

    function BrowserAutomationStudio_HandleEvent(name, data) {
      try {
        _ActionUpdater.model.trigger(name, JSON.parse(data));
      } catch (e) {
        _ActionUpdater.model.trigger(name);
      }
    }

    function BrowserAutomationStudio_ShowActionUpdater() {
      _ActionUpdater.show();
    }

    function BrowserAutomationStudio_HideActionUpdater() {
      _ActionUpdater.hide();
    }

    function BrowserAutomationStudio_IsPlayingScript() {
      return !_GobalModel.get('isstepnextactivated');
    }

    function BrowserAutomationStudio_RunningTask() {
      _GobalModel.set('istaskexecuting', true);
    }

    function BrowserAutomationStudio_Parse(Code)
    {
      BrowserAutomationStudio_LastCode = Code
      Code = Code.replace(/_set_goto_label\(\"_internal_\d+\"\)!/g,"")

      var RegexpStart = new RegExp("section_start\\(\\s*\\\"([^\\\"]*)\\\"\\s*\\,\\s*(\\-?\\d*)\\)\\!")
      var RegexpInsert = new RegExp("section_insert\\(\\)")
      var RegexpEnd = new RegExp("section_end\\(\\)\\!")
      var RegexpThreadNumber = new RegExp("section\\(\\s*([^\\/\\,]+)\\s*(\\/\\*([^\\*]*))?")
      var RegexpSuccess = new RegExp("section\\(\\s*([^\\/\\,]+)\\s*(\\/\\*([^\\*]*)\\*\\/)?\\s*\\,\\s*([^\\/\\,]+)\\s*(\\/\\*([^\\*]*)\\*\\/)?")
      var RegexpFail = new RegExp("section\\(\\s*([^\\/\\,]+)\\s*(\\/\\*([^\\*]*)\\*\\/)?\\s*\\,\\s*([^\\/\\,]+)\\s*(\\/\\*([^\\*]*)\\*\\/)?\\s*\\,\\s*([^\\/\\,]+)\\s*(\\/\\*([^\\*]*)\\*\\/)?")
      var MatchThreadNumber = Code.match(RegexpThreadNumber)
      var MatchSuccess = Code.match(RegexpSuccess)
      var MatchFail = Code.match(RegexpFail)


      if(MatchThreadNumber && MatchThreadNumber.length == 4)
      {
        var index = 1
        if(typeof(MatchThreadNumber[3]) == "string")
        {
          index = 3;
        }
        _GobalModel.set("threadnumber",MatchThreadNumber[index])
      }else
        _GobalModel.set("threadnumber",1)
      if(MatchSuccess && MatchSuccess.length == 7)
      {
        var index = 4
        if(typeof(MatchSuccess[6]) == "string")
        {
          index = 6;
        }
        _GobalModel.set("successnumber",MatchSuccess[index])
      }else
        _GobalModel.set("successnumber",1)
      if(MatchFail && MatchFail.length == 10)
      {
        var index = 7
        if(typeof(MatchFail[9]) == "string")
        {
          index = 9;
        }
        _GobalModel.set("failnumber",MatchFail[index])
      }else
        _GobalModel.set("failnumber",1)

      var InsertData = []
      var Stack = []
      var StackReverse = []
      var StackData = {}
      // -1 - none
      // 0  - start
      // 1  - end
      // 2  - insert
      var State = -1
      var PushLength = 0
      while(true)
      {
        var MatchStart = Code.match(RegexpStart)
        var MatchEnd = Code.match(RegexpEnd)
        var MatchInsert = Code.match(RegexpInsert)


        if(MatchStart && (!MatchEnd || (MatchStart.index < MatchEnd.index)) && (!MatchInsert || (MatchStart.index < MatchInsert.index)))
        {
          //Match start
          var name = eval("\"" + MatchStart[1] + "\"")
          var donotexecuteduringrecord = false
          var parsed = false
          var color = ""
          var is_fold = false
          var fd = ""
          try{
            if(name.length > 0)
            {
              var data = JSON.parse(name)
              if("e" in data)
                donotexecuteduringrecord = data["e"]
              if("n" in data)
                name = data["n"]
              else
                name = ""
              if("c" in data)
                color = data["c"]
              if("f" in data)
                is_fold = data["f"]
              if("fd" in data)
                fd = data["fd"]
            }

            parsed = true

          }catch(e){}

          if(!parsed)
          {
            while(name.startsWith("_"))
            {
              donotexecuteduringrecord = true
              name = name.slice(1)
            }
          }

          var id = MatchStart[2]
          var parentid = "0"
          if(Stack.length > 0)
            parentid = Stack[Stack.length - 1]

          var code = ""

          if(State == 0)
          {
            code = Normalize(Code.substr(0, MatchStart.index - 1))
          }

          var task = {name: name, id: id, donotexecuteduringrecord: donotexecuteduringrecord, parentid: parentid, code: code, is_fold: is_fold, fd: fd, color: color}
          Stack.push(id)
          StackReverse.push(id)
          StackData[id] = task
          Code = Code.substr(MatchStart.index + MatchStart[0].length)
          State = 0

        }else if(MatchEnd && (!MatchStart || (MatchEnd.index < MatchStart.index)) && (!MatchInsert || (MatchEnd.index < MatchInsert.index)))
        {
          //Match end
          if(State == -1)
            break;

          if(Stack.length == 0)
            break;

          var code = Code.substr(0, MatchEnd.index - 1)
          var taskid = Stack[Stack.length - 1]
          var task = StackData[taskid]
          task["code"] = Normalize(task["code"] + "\n" + code)
          StackData[taskid] = task
          Stack = Stack.slice(0,Stack.length - 1)

          PushLength++
          if(PushLength >= StackReverse.length)
          {
            for(var i = 0;i<StackReverse.length;i+=1)
            {
              InsertData.push(StackData[StackReverse[i]])
            }
            StackReverse = []
            PushLength = 0
          }

          Code = Code.substr(MatchEnd.index + MatchEnd[0].length)
          State = 1

        }else if(MatchInsert && (!MatchStart || (MatchInsert.index < MatchStart.index)) && (!MatchEnd || (MatchInsert.index < MatchEnd.index)))
        {
          //Match insert
          if(State == -1)
            break;

          if(State == 0 && Stack.length > 0)
          {
            var code = Code.substr(0, MatchInsert.index + MatchInsert[0].length)
            var taskid = Stack[Stack.length - 1]
            var task = StackData[taskid]
            task["code"] = Normalize(task["code"] + "\n" + code)
            StackData[taskid] = task
          }
          Code = Code.substr(MatchInsert.index + MatchInsert[0].length)
          State = 2
        }else
          break;
      }




      _GobalModel.set("dontsend",true)
      if(InsertData.length == 0)
      {
        InsertData.push({name: "Initialize", id: "0", donotexecuteduringrecord: false, parentid: "0", code: "browser()!"})
      }

      _TaskCollection.reset(InsertData)

     
      _GobalModel.set("dontsend",false)

      _CacheLoader.Start()



      UpdateGotos()

      _EmbeddedModel.Init()



      _CacheLoader.Stop()      



      BrowserAutomationStudio_SaveToUndoManager()

      


      BrowserAutomationStudio_AskForVariablesUpdateIfNeeded()

      

      _MainView.render()

            //alert(InsertData.length)

      _WebInterfaceTasks.CodeReady()

    }

    function UpdateInsertPlacesTooltips()
    {

      /*$('.toolinsertdata:has(.toolselected)').attr("title", tr("A place where new action can be inserted or moved. This one is active. New actions will be inserted here."))

      $('.toolinsertdata:not(:has(.toolselected))').attr("title", tr("A place where new action can be inserted or moved. This one is not active. Click to make it active."))*/

      /*$('.toolinsertdata:has(.toolselected)').attr("data-toggle","tooltip").attr("data-placement","auto").attr("data-original-title", tr("A place where new action can be inserted or moved. This one is active. New actions will be inserted here."))

      $('.toolinsertdata:not(:has(.toolselected))').attr("data-toggle","tooltip").attr("data-placement","auto").attr("data-original-title", tr("A place where new action can be inserted or moved. This one is not active. Click to make it active."))

      $('.toollabelcreate').on('show.bs.tooltip', function () {
        $('.toolinsertdata').tooltip('hide')
      })*/
    }
    function je(data)
    {
      return data
      .replace(new RegExp("\\\\","g"),"\\u005c")
      .replace(new RegExp("<","g"),"\\u003c")
      .replace(new RegExp(">","g"),"\\u003e")
      .replace(new RegExp("\"","g"),"\\u0022")
      .replace(new RegExp("'","g"),"\\u0027")
      .replace(new RegExp("&","g"),"\\u0026")
      .replace(new RegExp("{","g"),"\\u007b")
      .replace(new RegExp("}","g"),"\\u007d")

      .replace(new RegExp("\\n","g"),"\\n")
      .replace(new RegExp("\\r","g"),"\\r")
    }

    function quoteattr(s)
    {
      var preserveCR = '&#13;';
      return ('' + s) /* Forces the conversion to string. */
          .replace(/&/g, '&amp;') /* This MUST be the 1st replacement. */
          .replace(/'/g, '&apos;') /* The 4 other predefined entities, required. */
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          /*
          You may add other replacements here for HTML only 
          (but it's not necessary).
          Or for XML, only if the named entities are defined in its DTD.
          */ 
          .replace(/\r\n/g, preserveCR) /* Must be before the next replacement. */
          .replace(/[\r\n]/g, preserveCR);
          ;
  }

    function jsort(json)
    {
      return json.sort(function (a, b) {
        if (a["name"].toLowerCase() > b["name"].toLowerCase()) {
          return 1;
        }
        if (a["name"].toLowerCase() < b["name"].toLowerCase()) {
          return -1;
        }
        return 0;
      })
    }

    function extract_functions(code)
    {
      var res = []

      var regexp = new RegExp("section_start\\((\\\"[^\\\"]+\\\")\\s*\\,\\s*\\d+\\)\\!\\s*function","gm")
      var matches;
      while (matches = regexp.exec(code))
      {
        res.push(matches[1]);
      }

      res = res.filter(function(item, pos) {
            return res.indexOf(item) == pos && item.indexOf("OnApplicationStart") < 0;
      })

      res = res.map(function(el){return {name: el.toString()}})

      return JSON.stringify(res)

    }
    function extract_resources(code)
    {
      var res = []

      var regexp = new RegExp("RCreate\\(\\\"([^\\\"]+)","g")
      var matches;
      while (matches = regexp.exec(code))
      {
        res.push(matches[1]);
      }

      res = res.filter(function(item, pos) {
            return res.indexOf(item) == pos;
      })

      res = res.map(function(el){return {name: el.toString()}})

      return JSON.stringify(res)
      
    }
    function extract_variables(code)
    {
      var res = new Set()
      var regexp = new RegExp("VAR_([A-Z0-9_]+)","g")
      var matches;
      while (matches = regexp.exec(code))
      {
        res.add(matches[1]);
      }

      res = [...res]; 

      res = res.map(function(el){return {name: el.toString()}})

      return JSON.stringify(res)
    }
    function extract_global_variables(code)
    {
      var res = []
      var regexp = new RegExp("PSet\\(\\s*\\\"basglobal\\\"\\s*\\,\\s*\\\"([^\\\"]+)\\\"","g")
      var matches;
      while (matches = regexp.exec(code))
      {
        res.push(JSON.parse("\"" + matches[1] + "\""));
      }

      res = res.filter(function(item, pos) {
            return res.indexOf(item) == pos;
      })

      res = res.map(function(el){return {name: el.toString()}})

      return JSON.stringify(res)
    }

    function extract_labels(code)
    {
      var res = []
      var regexp = new RegExp("_set_goto_label\\(([^\\)]+)","g")
      var matches;
      while (matches = regexp.exec(code))
      {
        if(matches[1].indexOf("_internal_") < 0)
        {
          res.push(matches[1]);
        }
      }

      res = res.filter(function(item, pos) {
            return JSON.parse(res.indexOf(item)) == JSON.parse(pos);
      })

      res = res.map(function(el){return {name: JSON.parse(el.toString())}})

      return JSON.stringify(res)
    }

    function utf8_to_b64( str ) {
        return window.btoa(unescape(encodeURIComponent( str )));
    }

    function b64_to_utf8( str ) {
        return decodeURIComponent(escape(window.atob( str )));
    }

    function Normalize(code, tab)
    {
      var a = code.split("\n")
      var res = "";
      for(var i=0;i<a.length;i+=1)
      {
        var l = a[i].trim()
        if(l.length == 0)
          continue;

        if(res.length != 0)
        {
          res += "\n"
        }
        for(var j = 0;j<tab;j+=1)
          res += "   "
        res += l
      }
      return res
    }

    function CacheLoader()
    {
      var IsActiveForFindTaskById = false;
      var IsActiveForIsEmptyAndGroup = false;
      var IsActiveForGetGroupsEndings = false;
      var IsActiveForGetFunctionData = false;
      var IsActiveForGetFunctionDataOfThisNode = false;
      var IsActiveForGetFirstNotFunctionId = false;
      var DontUpdate = false;

      var BuildingCache = false

      var firstNotFunctionId = 0;
      var IdToTask = {}
      var IndexToId = []
      var IdToFunctionData = {}
      var IdToFunctionDataForThisNode = {}
      var IndexToIsEmptyAndGroup = []
      var IndexToGroupsEndings = []
      var TimesStarted = []

      this.GetIsBuildingCache = function()
      {
        return BuildingCache
      }

      this.GetIsActiveForFindTaskById = function()
      {
        if(!IsActiveForFindTaskById && !BuildingCache)
          this.StartCarefully()
        return IsActiveForFindTaskById
      }
      this.GetIsActiveForIsEmptyAndGroup = function()
      {
        if(!IsActiveForIsEmptyAndGroup && !BuildingCache)
          this.StartCarefully()
        return IsActiveForIsEmptyAndGroup
      }
      this.GetIsActiveForGetGroupsEndings = function()
      {
        if(!IsActiveForGetGroupsEndings && !BuildingCache)
          this.StartCarefully()
        return IsActiveForGetGroupsEndings
      }
      this.GetIsActiveForGetFunctionData = function()
      {
        if(!IsActiveForGetFunctionData && !BuildingCache)
          this.StartCarefully()
        return IsActiveForGetFunctionData
      }
      this.GetIsActiveForGetFunctionDataOfThisNode = function()
      {
        if(!IsActiveForGetFunctionDataOfThisNode && !BuildingCache)
          this.StartCarefully()
        return IsActiveForGetFunctionDataOfThisNode
      }
      this.GetIsActiveForGetFirstNotFunctionId = function()
      {
        if(!IsActiveForGetFirstNotFunctionId && !BuildingCache)
          this.StartCarefully()
        return IsActiveForGetFirstNotFunctionId
      }

      this.SetDontUpdate = function(NewDontUpdate)
      {
        DontUpdate = NewDontUpdate
      }

      this.StartCarefully = function()
      {
        if(DontUpdate)
          return
        if(TimesStarted.length == 0 || Date.now() - TimesStarted[0] > 100)
        {
          this.Start()
        }else
        {
          this.Stop()
        }
      }

      this.Start = function()
      {
        TimesStarted = TimesStarted.slice(-2)
        TimesStarted.push(Date.now())

        BuildingCache = true;
        IsActiveForFindTaskById = false;
        IsActiveForIsEmptyAndGroup = false;
        IsActiveForGetGroupsEndings = false;
        IsActiveForGetFunctionData = false;
        IsActiveForGetFunctionDataOfThisNode = false;
        IsActiveForGetFirstNotFunctionId = false;

        IdToTask = {}
        IdToFunctionData = {}
        IndexToId = []
        IndexToIsEmptyAndGroup = []
        IndexToGroupsEndings = []

        var t;

        var models = _TaskCollection.models

        t = new Date()

        var len = models.length
        for(var i = 0;i<len;i++)
        {
          var task = models[i]
          var id = Number(task.get('id'))
          IndexToId.push(id)
          IdToTask[id] = task
        }

        IsActiveForFindTaskById = true

        for(var i = 0;i<len;i++)
        {
          var task = models[i]
          var id = Number(task.get('id'))
          IndexToIsEmptyAndGroup.push(IsEmptyAndGroup(i))
        }

        IsActiveForIsEmptyAndGroup = true

        for(var i = 0;i<len;i++)
        {
          var task = models[i]
          var id = Number(task.get('id'))
          IndexToGroupsEndings.push(GetGroupsEndings(i))
        }

        IsActiveForGetGroupsEndings = true

        for(var i = 0;i<len;i++)
        {
          var task = models[i]
          var id = Number(task.get('id'))
          IdToFunctionDataForThisNode[id] = GetFunctionDataOfThisNode(id)
        }

        IsActiveForGetFunctionDataOfThisNode = true

        var found = false
        firstNotFunctionId = 0
        for(var i = 0;i<len;i++)
        {
          var task = models[i]
          var id = Number(task.get('id'))
          var funcdata = GetFunctionData(id)

          if(!found && funcdata.id == 0 && id != 0)
          {
            found = true
            firstNotFunctionId = id
          }

          IdToFunctionData[id] = funcdata
        }

        IsActiveForGetFunctionData = true
        IsActiveForGetFirstNotFunctionId = true
        BuildingCache = false;

        console.trace("Cache time " + (new Date() - t) )

      }

      this.Stop = function()
      {
        IsActiveForFindTaskById = false;
        IsActiveForIsEmptyAndGroup = false;
        IsActiveForGetGroupsEndings = false;
        IsActiveForGetFunctionData = false;
        IsActiveForGetFunctionDataOfThisNode = false;
        IsActiveForGetFirstNotFunctionId = false;
      }

      this.GetGroupsEndings = function(index)
      {
        return IndexToGroupsEndings[index]
      }

      this.IsEmptyAndGroup = function(index)
      {
        return IndexToIsEmptyAndGroup[index]
      }

      this.FindTaskById = function(Id)
      {
        var res = IdToTask[Id]
        if(typeof(res) == "undefined")
        {
          return null
        }
        return res
      }

      this.GetFunctionData = function(Id)
      {
        var res = IdToFunctionData[Id]
        if(typeof(res) == "undefined")
        {
          return null
        }
        return res
      }

      this.GetFunctionDataOfThisNode = function(Id)
      {
        var res = IdToFunctionDataForThisNode[Id]
        if(typeof(res) == "undefined")
        {
          return null
        }
        return res
      }

      this.GetFirstNotFunctionId = function()
      {
        return firstNotFunctionId
      }
    }

    function ResourceLoader()
    {
      var AdditionalData = "";
      var IsString = true;
      var Iteration = 1;

      this.Resolve = function(str)
      {
        var res = this.ResolveResources(str);
        //res = this.ResolveVariables(res);
        return res;
      }

      this.SetIsString = function(value)
      {
        IsString = value;
      }

      this.ResolveVariables = function(str)
      {
        var res = "";
        var reg = new RegExp("\\[\\[([^\\]]+)\\]\\]")
        var rest = str
        var all = ""
        while(true)
        {
          all = res
          if(res.length > 0 && rest.length > 0)
            all += ((IsString) ? " + " : "")

          if(rest.length > 0)
            all += ((IsString) ? "\"" : "") + ((IsString) ? je(rest) : rest) + ((IsString) ? "\"" : "")

          var match = reg.exec(rest)
          if(!match)
            break;

          var i = match.index
          var resnew = "";
          if(i>0)
          {
            resnew += (IsString) ? "\"" : ""
            resnew += (IsString) ? je(rest.substr(0,i)) : rest.substr(0,i)
            resnew += (IsString) ? "\" + " : ""
          }

          resnew += "VAR_" + match[1]

          i = match.index + match[0].length
          var j = rest.length - i
          if(j>0)
          {
            rest = rest.substr(i,j)
          }else
            rest = ""

          if(res.length == 0)
            res = resnew
          else
            res +=  ((IsString) ? " + " : "") + resnew


        }
        return all;
      }

      this.ResolveResources = function(str)
      {
        var res = "";
        var reg = new RegExp("\\{\\{([^\\}]+)\\}\\}")
        var rest = str
        var all = ""
        while(true)
        {
          all = res
          if(res.length > 0 && rest.length > 0)
            all += ((IsString) ? " + " : "")

          if(rest.length > 0)
            all += this.ResolveVariables(rest)

          var match = reg.exec(rest)
          if(!match)
            break;


          var v = "RESOURCE_" + Iteration;
          var m = match[1].split("|")[0]
          var notreuse = match[1].indexOf("|notreuse")>=0
          var onlyfail = match[1].indexOf("|onlyfail")>=0
          AdditionalData +=  _.template($('#resource_code').html())({resource:m,variable:v,notreuse:notreuse,onlyfail:onlyfail});

          var i = match.index
          var resnew = "";
          if(i>0)
          {
            resnew += this.ResolveVariables(rest.substr(0,i))
            resnew += ((IsString) ? " + " : "")
          }

          resnew += v

          i = match.index + match[0].length
          var j = rest.length - i
          if(j>0)
          {
            rest = rest.substr(i,j)
          }else
            rest = ""

          if(res.length == 0)
            res = resnew
          else
            res +=  ((IsString) ? " + " : "") + resnew

          Iteration+=1;

        }
        return all;
      }

      this.GetAdditionalData = function()
      {
        return AdditionalData;
      }

    }

    function GenerateCode(data,global)
    {
      //console.trace("GenerateCode")
      var res = "";
      var loader = new ResourceLoader();
      loader.SetIsString(false)

      var threadnumber = global["threadnumber"].toString()
      if(threadnumber.length > 0 && threadnumber[0] == "{")
        threadnumber = loader.Resolve(threadnumber)

      var successnumber = global["successnumber"].toString()
      if(successnumber.length > 0 && successnumber[0] == "{")
        successnumber = loader.Resolve(successnumber)

      var failnumber = global["failnumber"].toString()
      if(failnumber.length > 0 && failnumber[0] == "{")
        failnumber = loader.Resolve(failnumber)

      res += Normalize(loader.GetAdditionalData())
      if(res.length > 0)
        res += "\n\n"
      res += "section(" + threadnumber + " \/*" + global["threadnumber"].toString() + "*\/," + successnumber  + " \/*" + global["successnumber"].toString() + "*\/," + failnumber  + " \/*" + global["failnumber"].toString() + "*\/,0,function(){";
      res += "\n"
      var index = 0

      var isfunction = true
      var wasonstartcall = false
      var IsOnStartExists = true
      while(true)
      {
        if(index >= data.length)
          break;

        var ret = GenerateSubsection(index,data,1,"")
        var newres = ret["res"]
        if(index!=0 && IsOnStartExists)
        {

          var isfunctionnew = IsFunctionNode(data[index].id)
          if(!isfunctionnew && isfunction)
          {
            res += "   _call(_on_start, null)!\n\n"
            wasonstartcall = true
          }
          isfunction = isfunctionnew
        }
        index = ret["index"]

        res += newres
      }
      if(!wasonstartcall && IsOnStartExists)
        res += "   _call(_on_start, null)!\n\n"

      res += "})!";

      return res;
    }

    function GenerateSubsection(index,data,level,res)
    {
        if(index >= data.length)
          return {index:index,res:res};

        var task = data[index]

        var real_task = _TaskCollection.models[index]

        if(real_task && real_task.attributes["code_precomputed"])
        {
          //This task has cache
          var code_precomputed = real_task.attributes["code_precomputed"]
          res += code_precomputed.start
          if(!code_precomputed.end)
          {
            //Action without internals
            index += 1
          }else
          {
            //Action with internals
            var level_last = level
            index ++
            while(true)
            {
              if(index >= data.length)
                break;

              if(parseInt(data[index].parentid) === parseInt(task.id))
              {
                var ret = GenerateSubsection(index,data,level + 1,res)
                index = ret["index"]
                res = ret["res"]
              }else
                break
            }
            res += Normalize(code_precomputed.end,level_last)
            res += "\n"
          }
        }else
        {
          //No cache

          var cache_add = ""

          var obj = {}
          var notempty = false;
          if(task.donotexecuteduringrecord)
          {
            notempty = true;
            obj["e"] = task.donotexecuteduringrecord
          }
          if(task.name.length > 0)
          {
            notempty = true;
            obj["n"] = task.name
          }
          if(task.color.length > 0)
          {
            notempty = true;
            obj["c"] = task.color
          }
          if(task.is_fold)
          {
            notempty = true;
            obj["f"] = task.is_fold
          }
          if(task.fd)
          {
            notempty = true;
            obj["fd"] = task.fd
          }

          if(notempty)
          {
            obj = JSON.stringify(obj)
          }else
          {
            obj = ""
          }

          var name = obj

          var sectioninsert = "section_start(\"" + je(name) + "\", " + task.id.toString() + ")!"
          if(task.internal_label_id.length > 0)
          {
            sectioninsert = "_set_goto_label(\"_internal_" + task.internal_label_id + "\")!" + sectioninsert
          }
          cache_add += Normalize(sectioninsert,level)
          
          cache_add += "\n"
          var separator = "section_insert()"

          var index_str = task.code.indexOf(separator)
          if(index_str >= 0)
            index_str += separator.length

          if(index_str < 0)
          {
            cache_add += Normalize(task.code,level)
            cache_add += "\n"
            res += cache_add

            //Save cache
            real_task.attributes["code_precomputed"] = {start:cache_add,end:null}
            index += 1
          }else
          {
            cache_add += Normalize(task.code.substr(0,index_str),level)
            cache_add += "\n"
            res += cache_add

            var code_last = task.code.substr(index_str)
            
            //Save cache
            real_task.attributes["code_precomputed"] = {start:cache_add,end:code_last}

            var level_last = level
            index ++
            while(true)
            {
              if(index >= data.length)
                break;

              if(parseInt(data[index].parentid) === parseInt(task.id))
              {
                var ret = GenerateSubsection(index,data,level + 1,res)
                index = ret["index"]
                res = ret["res"]
              }else
                break
            }
            res += Normalize(code_last,level_last)
            res += "\n"

          }
        }
        //This thing is not cached
        res += Normalize("section_end()!",level)
        res += "\n"
        res += "\n"
        return {index:index,res:res};
    }
  </script>
</body>
</html>
